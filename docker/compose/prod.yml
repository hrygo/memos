# =============================================================================
# DivineSense 生产环境 (2C2G 服务器)
# =============================================================================
#
# 包含: PostgreSQL + DivineSense
#
# 使用方式:
#   cp .env.example .env.prod
#   docker-compose -f prod.yml --env-file .env.prod up -d
#
# =============================================================================

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: divinesense-postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-divinesense}
      POSTGRES_USER: ${POSTGRES_USER:-divinesense}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # 内存优化 (2G 服务器，PostgreSQL 使用 ~512M)
      POSTGRES_SHARED_BUFFERS: 128MB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 384MB
      POSTGRES_MAINTENANCE_WORK_MEM: 32MB
      POSTGRES_WORK_MEM: 4MB
      POSTGRES_MAX_CONNECTIONS: 50
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # 数据库初始化脚本 (仅首次创建时执行)
      - ../../store/migration/postgres:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT_MAPPING:-}"  # 可选: 127.0.0.1:25432:5432
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-divinesense}"]
      interval: 30s
      timeout: 10s
      retries: 3
    # 资源限制 (2C2G)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    command:
      [
        "-c", "shared_buffers=128MB",
        "-c", "effective_cache_size=384MB",
        "-c", "maintenance_work_mem=32MB",
        "-c", "work_mem=4MB",
        "-c", "max_connections=50",
        "-c", "shared_preload_libraries=vector"
      ]
    networks:
      - divinesense_network

  divinesense:
    image: divinesense:latest
    container_name: divinesense
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # 运行模式
      - DIVINESENSE_MODE=prod
      - DIVINESENSE_PORT=5230
      - DIVINESENSE_ADDR=0.0.0.0

      # 数据库配置
      - DIVINESENSE_DRIVER=postgres
      - DIVINESENSE_DSN=postgres://${POSTGRES_USER:-divinesense}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-divinesense}?sslmode=disable

      # 实例 URL
      - DIVINESENSE_INSTANCE_URL=${DIVINESENSE_INSTANCE_URL}

      # AI 功能
      - DIVINESENSE_AI_ENABLED=${DIVINESENSE_AI_ENABLED:-true}
      - DIVINESENSE_AI_EMBEDDING_PROVIDER=${DIVINESENSE_AI_EMBEDDING_PROVIDER:-siliconflow}
      - DIVINESENSE_AI_EMBEDDING_MODEL=${DIVINESENSE_AI_EMBEDDING_MODEL:-BAAI/bge-m3}
      - DIVINESENSE_AI_SILICONFLOW_API_KEY=${DIVINESENSE_AI_SILICONFLOW_API_KEY}
      - DIVINESENSE_AI_OPENAI_API_KEY=${DIVINESENSE_AI_OPENAI_API_KEY}
      - DIVINESENSE_AI_LLM_PROVIDER=${DIVINESENSE_AI_LLM_PROVIDER:-deepseek}
      - DIVINESENSE_AI_LLM_MODEL=${DIVINESENSE_AI_LLM_MODEL:-deepseek-chat}
      - DIVINESENSE_AI_DEEPSEEK_API_KEY=${DIVINESENSE_AI_DEEPSEEK_API_KEY}
      - DIVINESENSE_AI_RERANK_MODEL=${DIVINESENSE_AI_RERANK_MODEL:-BAAI/bge-reranker-v2-m3}
    ports:
      - "${DIVINESENSE_PORT:-5230}:5230"
    volumes:
      - divinesense_data:/var/opt/divinesense
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'cat < /dev/null > /dev/tcp/127.0.0.1/5230 || exit 1'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # 资源限制 (2C2G)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    networks:
      - divinesense_network

networks:
  divinesense_network:
    driver: bridge

volumes:
  postgres_data:
  divinesense_data:
