# ç¬”è®°ååº”ç³»ç»Ÿ

<cite>
**æœ¬æ–‡å¼•ç”¨çš„æ–‡ä»¶**
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go)
- [store/reaction.go](file://store/reaction.go)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go)
- [proto/gen/api/v1/apiv1connect/memo_service.connect.go](file://proto/gen/api/v1/apiv1connect/memo_service.connect.go)
- [proto/gen/api/v1/memo_service_grpc.pb.go](file://proto/gen/api/v1/memo_service_grpc.pb.go)
- [web/src/components/MemoReactionListView/MemoReactionListView.tsx](file://web/src/components/MemoReactionListView/MemoReactionListView.tsx)
- [web/src/components/MemoReactionListView/ReactionSelector.tsx](file://web/src/components/MemoReactionListView/ReactionSelector.tsx)
- [web/src/components/MemoReactionListView/hooks.ts](file://web/src/components/MemoReactionListView/hooks.ts)
- [store/migration/sqlite/0.20/00__reaction.sql](file://store/migration/sqlite/0.20/00__reaction.sql)
- [store/migration/sqlite/LATEST.sql](file://store/migration/sqlite/LATEST.sql)
- [store/migration/postgres/LATEST.sql](file://store/migration/postgres/LATEST.sql)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶æ„æ€»è§ˆ](#æ¶æ„æ€»è§ˆ)
5. [è¯¦ç»†ç»„ä»¶åˆ†æ](#è¯¦ç»†ç»„ä»¶åˆ†æ)
6. [ä¾èµ–å…³ç³»åˆ†æ](#ä¾èµ–å…³ç³»åˆ†æ)
7. [æ€§èƒ½è€ƒé‡](#æ€§èƒ½è€ƒé‡)
8. [æ•…éšœæ’æŸ¥æŒ‡å—](#æ•…éšœæ’æŸ¥æŒ‡å—)
9. [ç»“è®º](#ç»“è®º)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹
æœ¬æ–‡ä»¶ä¸ºâ€œç¬”è®°ååº”ç³»ç»Ÿâ€çš„å®Œæ•´ API æ–‡æ¡£ï¼Œè¦†ç›–ä»¥ä¸‹æ¥å£ä¸èƒ½åŠ›ï¼š
- åˆ—å‡ºç¬”è®°ååº”ï¼šListMemoReactions
- æ–°å¢/æ›´æ–°ç¬”è®°ååº”ï¼šUpsertMemoReaction
- åˆ é™¤ç¬”è®°ååº”ï¼šDeleteMemoReaction
- Reaction å®ä½“æ•°æ®ç»“æ„ä¸ååº”ç±»å‹å®šä¹‰
- ç”¨æˆ·å¯¹ç¬”è®°çš„ç‚¹èµã€è¡¨æƒ…ååº”ç­‰äº’åŠ¨åŠŸèƒ½
- ååº”ç»Ÿè®¡ã€å»é‡å¤„ç†ä¸æƒé™æ§åˆ¶æœºåˆ¶
- ååº”å†å²è®°å½•ä¸è¶‹åŠ¿åˆ†æçš„å®ç°æ€è·¯
- æ€§èƒ½ä¼˜åŒ–ä¸ç¼“å­˜ç­–ç•¥
- å®Œæ•´æ¥å£ç¤ºä¾‹ä¸ç”¨æˆ·ä½“éªŒä¼˜åŒ–å»ºè®®

## é¡¹ç›®ç»“æ„
å›´ç»•ååº”ç³»ç»Ÿçš„ç›¸å…³æ¨¡å—åˆ†å¸ƒå¦‚ä¸‹ï¼š
- åè®®ä¸å®¢æˆ·ç«¯ï¼šproto/api/v1/memo_service.proto å®šä¹‰äº† Reaction æ¶ˆæ¯ä¸ä¸‰ä¸ªååº”æ¥å£ï¼›apiv1connect ä¸ grpc å®¢æˆ·ç«¯ç”Ÿæˆæ–‡ä»¶æä¾›è°ƒç”¨å…¥å£ã€‚
- åç«¯æœåŠ¡ï¼šserver/router/api/v1/reaction_service.go å®ç°ä¸‰ä¸ªæ¥å£çš„ä¸šåŠ¡é€»è¾‘ï¼ˆé‰´æƒã€æƒé™æ ¡éªŒã€è½¬æ¢æ¶ˆæ¯ï¼‰ã€‚
- å­˜å‚¨å±‚ï¼šstore/reaction.go å®šä¹‰å®ä½“ä¸æŸ¥è¯¢ç»“æ„ï¼›postgres/sqlite çš„ reaction.go æä¾›å…·ä½“æ•°æ®åº“æ“ä½œã€‚
- å‰ç«¯ç»„ä»¶ï¼šweb/src/components/MemoReactionListView ä¸‹çš„åˆ—è¡¨è§†å›¾ã€é€‰æ‹©å™¨ä¸ hooksï¼Œè´Ÿè´£å±•ç¤ºä¸äº¤äº’ã€‚

```mermaid
graph TB
subgraph "åè®®ä¸å®¢æˆ·ç«¯"
P1["proto/api/v1/memo_service.proto"]
C1["apiv1connect å®¢æˆ·ç«¯"]
C2["grpc å®¢æˆ·ç«¯"]
end
subgraph "åç«¯æœåŠ¡"
S1["server/router/api/v1/reaction_service.go"]
end
subgraph "å­˜å‚¨å±‚"
ST1["store/reaction.go"]
DBP["store/db/postgres/reaction.go"]
DBS["store/db/sqlite/reaction.go"]
end
subgraph "å‰ç«¯ç»„ä»¶"
F1["MemoReactionListView.tsx"]
F2["ReactionSelector.tsx"]
F3["hooks.ts"]
end
P1 --> C1
P1 --> C2
C1 --> S1
C2 --> S1
S1 --> ST1
ST1 --> DBP
ST1 --> DBS
S1 --> F1
F1 --> F2
F1 --> F3
```

å›¾è¡¨æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L88-L105)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L94)
- [store/reaction.go](file://store/reaction.go#L7-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L101)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L136)
- [web/src/components/MemoReactionListView/MemoReactionListView.tsx](file://web/src/components/MemoReactionListView/MemoReactionListView.tsx#L14-L34)
- [web/src/components/MemoReactionListView/ReactionSelector.tsx](file://web/src/components/MemoReactionListView/ReactionSelector.tsx#L15-L63)

ç« èŠ‚æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L88-L151)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L107)
- [store/reaction.go](file://store/reaction.go#L7-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L101)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L136)
- [web/src/components/MemoReactionListView/MemoReactionListView.tsx](file://web/src/components/MemoReactionListView/MemoReactionListView.tsx#L14-L34)
- [web/src/components/MemoReactionListView/ReactionSelector.tsx](file://web/src/components/MemoReactionListView/ReactionSelector.tsx#L15-L63)

## æ ¸å¿ƒç»„ä»¶
- Reaction å®ä½“ä¸æ¶ˆæ¯
  - å­—æ®µï¼šnameã€creatorã€content_idã€reaction_typeã€create_time
  - èµ„æºå‘½åè§„åˆ™ï¼šmemos/{memo}/reactions/{reaction}
  - ååº”ç±»å‹ï¼šå­—ç¬¦ä¸²ï¼Œå¦‚â€œğŸ‘â€ã€â€œâ¤ï¸â€ã€â€œğŸ˜„â€ï¼Œç”±å®ä¾‹è®¾ç½®å†³å®š
- ä¸‰ä¸ªæ ¸å¿ƒæ¥å£
  - ListMemoReactionsï¼šæŒ‰ç¬”è®°èµ„æºååˆ—å‡ºæ‰€æœ‰ååº”
  - UpsertMemoReactionï¼šæ–°å¢æˆ–æ›´æ–°å½“å‰ç”¨æˆ·çš„ååº”
  - DeleteMemoReactionï¼šåˆ é™¤æŒ‡å®šååº”ï¼ˆéœ€æƒé™ï¼‰

ç« èŠ‚æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L115-L151)
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L466-L511)

## æ¶æ„æ€»è§ˆ
ä»å®¢æˆ·ç«¯åˆ°æ•°æ®åº“çš„æ•´ä½“è°ƒç”¨é“¾è·¯å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant Connect as "apiv1connect å®¢æˆ·ç«¯"
participant GRPC as "grpc å®¢æˆ·ç«¯"
participant Handler as "APIV1Service<br/>reaction_service.go"
participant Store as "Store å±‚"
participant DB as "Postgres/SQLite"
Client->>Connect : "è°ƒç”¨ UpsertMemoReaction"
Connect->>Handler : "UpsertMemoReaction"
Handler->>Handler : "é‰´æƒä¸å‚æ•°æ ¡éªŒ"
Handler->>Store : "UpsertReaction"
Store->>DB : "INSERT INTO reaction"
DB-->>Store : "è¿”å›æ–°è®°å½•"
Store-->>Handler : "è¿”å› Reaction"
Handler-->>Connect : "è¿”å› Reaction"
Connect-->>Client : "è¿”å›ç»“æœ"
Client->>GRPC : "è°ƒç”¨ ListMemoReactions"
GRPC->>Handler : "ListMemoReactions"
Handler->>Store : "ListReactions"
Store->>DB : "SELECT ... WHERE content_id=?"
DB-->>Store : "è¿”å›ååº”åˆ—è¡¨"
Store-->>Handler : "è¿”å›åˆ—è¡¨"
Handler-->>GRPC : "è¿”å› ListMemoReactionsResponse"
GRPC-->>Client : "è¿”å›ç»“æœ"
```

å›¾è¡¨æ¥æº
- [proto/gen/api/v1/apiv1connect/memo_service.connect.go](file://proto/gen/api/v1/apiv1connect/memo_service.connect.go#L185-L202)
- [proto/gen/api/v1/memo_service_grpc.pb.go](file://proto/gen/api/v1/memo_service_grpc.pb.go#L201-L219)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L94)
- [store/reaction.go](file://store/reaction.go#L27-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L83)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L89)

## è¯¦ç»†ç»„ä»¶åˆ†æ

### æ¥å£ä¸€ï¼šListMemoReactionsï¼ˆåˆ—å‡ºç¬”è®°ååº”ï¼‰
- åŠŸèƒ½ï¼šæ ¹æ®ç¬”è®°èµ„æºååˆ—å‡ºè¯¥ç¬”è®°ä¸‹çš„æ‰€æœ‰ååº”
- è¯·æ±‚å‚æ•°ï¼šnameï¼ˆç¬”è®°èµ„æºåï¼‰ã€å¯é€‰åˆ†é¡µå‚æ•°
- è¿”å›ï¼šreactions åˆ—è¡¨ã€next_page_tokenã€total_size
- æƒé™ï¼šæ— éœ€ç™»å½•å³å¯è®¿é—®ï¼ˆä»…è¯»å–ï¼‰
- æ•°æ®æ¥æºï¼šStore.ListReactions â†’ DB æŸ¥è¯¢ content_id

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant Handler as "ListMemoReactions"
participant Store as "Store.ListReactions"
participant DB as "DB.ListReactions"
Client->>Handler : "ListMemoReactions(name)"
Handler->>Store : "FindReaction{ContentID=name}"
Store->>DB : "SELECT ... WHERE content_id=? ORDER BY id ASC"
DB-->>Store : "è¿”å›åˆ—è¡¨"
Store-->>Handler : "è¿”å› []*Reaction"
Handler-->>Client : "ListMemoReactionsResponse"
```

å›¾è¡¨æ¥æº
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L33)
- [store/reaction.go](file://store/reaction.go#L31-L33)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L25-L83)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L28-L89)

ç« èŠ‚æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L466-L490)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L33)
- [store/reaction.go](file://store/reaction.go#L31-L33)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L25-L83)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L28-L89)

### æ¥å£äºŒï¼šUpsertMemoReactionï¼ˆæ–°å¢/æ›´æ–°ç¬”è®°ååº”ï¼‰
- åŠŸèƒ½ï¼šä¸ºå½“å‰ç”¨æˆ·åœ¨æŒ‡å®šç¬”è®°ä¸Šæ–°å¢æˆ–æ›´æ–°ä¸€æ¡ååº”
- è¯·æ±‚å‚æ•°ï¼šnameï¼ˆç¬”è®°èµ„æºåï¼‰ã€reactionï¼ˆåŒ…å« content_idã€reaction_typeï¼‰
- è¿”å›ï¼šæ–°å¢æˆ–æ›´æ–°åçš„ Reaction
- æƒé™ï¼šå¿…é¡»ç™»å½•ï¼›æœªç™»å½•è¿”å› 401
- å»é‡ç­–ç•¥ï¼šå½“å‰å®ç°ä¸ºæ’å…¥æ–°è®°å½•ï¼›è‹¥éœ€å»é‡ï¼ˆåŒä¸€ç”¨æˆ·å¯¹åŒä¸€ç¬”è®°åªä¿ç•™æœ€æ–°ååº”ï¼‰ï¼Œå¯åœ¨ Upsert æ—¶å¢åŠ æ¡ä»¶ï¼ˆä¾‹å¦‚åŸºäºç”¨æˆ·ä¸å†…å®¹çš„å”¯ä¸€çº¦æŸï¼‰
- æ•°æ®æ¥æºï¼šStore.UpsertReaction â†’ DB INSERT

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant Handler as "UpsertMemoReaction"
participant Store as "Store.UpsertReaction"
participant DB as "DB.UpsertReaction"
Client->>Handler : "UpsertMemoReaction(name, reaction)"
Handler->>Handler : "fetchCurrentUser()"
Handler->>Store : "UpsertReaction{CreatorID, ContentID, ReactionType}"
Store->>DB : "INSERT INTO reaction (...) RETURNING id, created_ts"
DB-->>Store : "è¿”å›æ–°è®°å½•"
Store-->>Handler : "è¿”å› Reaction"
Handler-->>Client : "Reaction"
```

å›¾è¡¨æ¥æº
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L35-L55)
- [store/reaction.go](file://store/reaction.go#L27-L29)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L23)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L26)

ç« èŠ‚æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L492-L502)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L35-L55)
- [store/reaction.go](file://store/reaction.go#L27-L29)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L23)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L26)

### æ¥å£ä¸‰ï¼šDeleteMemoReactionï¼ˆåˆ é™¤ç¬”è®°ååº”ï¼‰
- åŠŸèƒ½ï¼šåˆ é™¤æŒ‡å®šçš„ååº”è®°å½•
- è¯·æ±‚å‚æ•°ï¼šnameï¼ˆååº”èµ„æºåï¼Œæ ¼å¼ä¸º memos/{memo}/reactions/{reaction}ï¼‰
- æƒé™ï¼šå¿…é¡»ç™»å½•ï¼›åˆ é™¤è€…å¿…é¡»æ˜¯åˆ›å»ºè€…æˆ–è¶…çº§ç”¨æˆ·ï¼Œå¦åˆ™è¿”å› 403
- éšç§ä¿æŠ¤ï¼šè‹¥æ‰¾ä¸åˆ°è®°å½•ï¼Œè¿”å› 403 ä»¥é¿å…ä¿¡æ¯æ³„éœ²
- æ•°æ®æ¥æºï¼šStore.GetReaction â†’ Store.DeleteReaction â†’ DB DELETE

```mermaid
sequenceDiagram
participant Client as "å®¢æˆ·ç«¯"
participant Handler as "DeleteMemoReaction"
participant Store as "Store"
participant DB as "DB"
Client->>Handler : "DeleteMemoReaction(name)"
Handler->>Handler : "è§£æ reactionID"
Handler->>Store : "GetReaction(ID)"
Store->>DB : "SELECT ... WHERE id=? LIMIT 1"
DB-->>Store : "è¿”å›è®°å½•æˆ–ç©º"
alt è®°å½•ä¸å­˜åœ¨
Handler-->>Client : "PermissionDenied"
else è®°å½•å­˜åœ¨
Handler->>Handler : "æ ¡éªŒ CreatorID æˆ– isSuperUser"
Handler->>Store : "DeleteReaction(ID)"
Store->>DB : "DELETE FROM reaction WHERE id=?"
DB-->>Store : "OK"
Store-->>Handler : "OK"
Handler-->>Client : "Empty"
end
```

å›¾è¡¨æ¥æº
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L57-L94)
- [store/reaction.go](file://store/reaction.go#L35-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L85-L101)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L92-L136)

ç« èŠ‚æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L504-L511)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L57-L94)
- [store/reaction.go](file://store/reaction.go#L35-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L85-L101)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L92-L136)

### Reaction å®ä½“ä¸æ•°æ®æ¨¡å‹
- å­˜å‚¨å±‚å­—æ®µï¼šIDã€CreatedTsã€CreatorIDã€ContentIDã€ReactionType
- æŸ¥è¯¢ç»“æ„ï¼šFindReaction æ”¯æŒæŒ‰ IDã€CreatorIDã€ContentIDã€ContentIDList è¿‡æ»¤
- åˆ é™¤ç»“æ„ï¼šDeleteReaction ä»…åŒ…å« ID
- èµ„æºå‘½åï¼šReaction.name = memos/{memo}/reactions/{id}

```mermaid
classDiagram
class Reaction {
+int32 ID
+int64 CreatedTs
+int32 CreatorID
+string ContentID
+string ReactionType
}
class FindReaction {
+int32* ID
+int32* CreatorID
+string* ContentID
+string[] ContentIDList
}
class DeleteReaction {
+int32 ID
}
class Store {
+UpsertReaction(...)
+ListReactions(...)
+GetReaction(...)
+DeleteReaction(...)
}
Store --> Reaction : "è¯»å†™"
Store --> FindReaction : "æŸ¥è¯¢"
Store --> DeleteReaction : "åˆ é™¤"
```

å›¾è¡¨æ¥æº
- [store/reaction.go](file://store/reaction.go#L7-L41)

ç« èŠ‚æ¥æº
- [store/reaction.go](file://store/reaction.go#L7-L41)

### å‰ç«¯ç»„ä»¶ä¸äº¤äº’
- åˆ—è¡¨è§†å›¾ï¼šMemoReactionListView.tsx å°† reactions æŒ‰ reaction_type åˆ†ç»„å±•ç¤ºï¼Œå¹¶åœ¨éå½’æ¡£çŠ¶æ€ä¸‹æ˜¾ç¤º ReactionSelector
- é€‰æ‹©å™¨ï¼šReactionSelector.tsx å±•ç¤ºå®ä¾‹é…ç½®çš„ååº”é›†åˆï¼Œæ”¯æŒç‚¹å‡»åˆ‡æ¢
- Hooksï¼šhooks.ts æä¾› reactions -> ç”¨æˆ·åˆ†ç»„æ˜ å°„ä¸ååº”åŠ¨ä½œå°è£…ï¼ˆå«æŸ¥è¯¢ç¼“å­˜é›†æˆï¼‰

```mermaid
flowchart TD
Start(["æ¸²æŸ“ MemoReactionListView"]) --> CheckEmpty{"reactions æ˜¯å¦ä¸ºç©º?"}
CheckEmpty --> |æ˜¯| Hide["ä¸æ¸²æŸ“"]
CheckEmpty --> |å¦| Group["æŒ‰ reaction_type åˆ†ç»„ç”¨æˆ·"]
Group --> Render["æ¸²æŸ“ ReactionView åˆ—è¡¨"]
Render --> Editable{"æ˜¯å¦å¯ç¼–è¾‘?"}
Editable --> |æ˜¯| Selector["æ¸²æŸ“ ReactionSelector"]
Editable --> |å¦| End(["å®Œæˆ"])
Selector --> End
Hide --> End
```

å›¾è¡¨æ¥æº
- [web/src/components/MemoReactionListView/MemoReactionListView.tsx](file://web/src/components/MemoReactionListView/MemoReactionListView.tsx#L14-L34)
- [web/src/components/MemoReactionListView/ReactionSelector.tsx](file://web/src/components/MemoReactionListView/ReactionSelector.tsx#L15-L63)
- [web/src/components/MemoReactionListView/hooks.ts](file://web/src/components/MemoReactionListView/hooks.ts#L12-L28)

ç« èŠ‚æ¥æº
- [web/src/components/MemoReactionListView/MemoReactionListView.tsx](file://web/src/components/MemoReactionListView/MemoReactionListView.tsx#L14-L34)
- [web/src/components/MemoReactionListView/ReactionSelector.tsx](file://web/src/components/MemoReactionListView/ReactionSelector.tsx#L15-L63)
- [web/src/components/MemoReactionListView/hooks.ts](file://web/src/components/MemoReactionListView/hooks.ts#L12-L28)

## ä¾èµ–å…³ç³»åˆ†æ
- åè®®å±‚ä¸å®¢æˆ·ç«¯
  - memo_service.proto å®šä¹‰äº†ä¸‰ä¸ªæ¥å£ä¸ Reaction æ¶ˆæ¯
  - apiv1connect ä¸ grpc å®¢æˆ·ç«¯ç”Ÿæˆæ–‡ä»¶æä¾›è°ƒç”¨å…¥å£
- æœåŠ¡å±‚
  - APIV1Service å¯¹æ¥ Store å±‚ï¼Œè¿›è¡Œé‰´æƒã€å‚æ•°æ ¡éªŒä¸æ¶ˆæ¯è½¬æ¢
- å­˜å‚¨å±‚
  - Store æŠ½è±¡å‡º Upsert/List/Get/Delete
  - Postgres/SQLite å…·ä½“å®ç° SQL æŸ¥è¯¢ä¸è¿”å›
- å‰ç«¯
  - ç»„ä»¶é€šè¿‡ hooks ä¸æœåŠ¡ç«¯äº¤äº’ï¼Œä½¿ç”¨ React Query ç¼“å­˜

```mermaid
graph LR
Proto["memo_service.proto"] --> Conn["apiv1connect å®¢æˆ·ç«¯"]
Proto --> Grpc["grpc å®¢æˆ·ç«¯"]
Conn --> API["APIV1Service"]
Grpc --> API
API --> Store["Store"]
Store --> Pg["Postgres DB"]
Store --> Sq["SQLite DB"]
API --> FE["å‰ç«¯ç»„ä»¶"]
```

å›¾è¡¨æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L88-L105)
- [proto/gen/api/v1/apiv1connect/memo_service.connect.go](file://proto/gen/api/v1/apiv1connect/memo_service.connect.go#L185-L202)
- [proto/gen/api/v1/memo_service_grpc.pb.go](file://proto/gen/api/v1/memo_service_grpc.pb.go#L201-L219)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L94)
- [store/reaction.go](file://store/reaction.go#L27-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L101)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L136)

ç« èŠ‚æ¥æº
- [proto/api/v1/memo_service.proto](file://proto/api/v1/memo_service.proto#L88-L105)
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L17-L94)
- [store/reaction.go](file://store/reaction.go#L27-L41)
- [store/db/postgres/reaction.go](file://store/db/postgres/reaction.go#L10-L101)
- [store/db/sqlite/reaction.go](file://store/db/sqlite/reaction.go#L12-L136)

## æ€§èƒ½è€ƒé‡
- æŸ¥è¯¢ä¼˜åŒ–
  - ListReactions å·²æŒ‰ content_id è¿‡æ»¤å¹¶æ’åºï¼Œå»ºè®®åœ¨ content_id ä¸Šå»ºç«‹ç´¢å¼•
  - è‹¥éœ€è¦æ‰¹é‡æŸ¥è¯¢å¤šä¸ªç¬”è®°çš„ååº”ï¼Œå¯åˆ©ç”¨ ContentIDList å‚æ•°å‡å°‘å¤šæ¬¡å¾€è¿”
- å†™å…¥ä¼˜åŒ–
  - Upsert é‡‡ç”¨å•æ¡ INSERTï¼Œå»ºè®®åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹è¯„ä¼°æ˜¯å¦å¼•å…¥â€œå»é‡ Upsertâ€ï¼ˆåŸºäºç”¨æˆ·+å†…å®¹çš„å”¯ä¸€çº¦æŸï¼‰ä»¥å‡å°‘é‡å¤è®°å½•
- ç¼“å­˜ç­–ç•¥
  - å‰ç«¯ä½¿ç”¨ React Query ç¼“å­˜ï¼Œå»ºè®®å¯¹ ListMemoReactions çš„å“åº”è¿›è¡Œç¼“å­˜ä¸å¤±æ•ˆç­–ç•¥ç®¡ç†
  - å¯è€ƒè™‘å¯¹çƒ­é—¨ç¬”è®°çš„ååº”æ€»æ•°ä¸åˆ†ç»„ç»Ÿè®¡åšçŸ­æœŸç¼“å­˜ï¼ˆå¦‚ Redisï¼‰
- æ‰¹é‡æ“ä½œ
  - è‹¥å‰ç«¯éœ€è¦åŒæ—¶æ›´æ–°å¤šä¸ªç¬”è®°çš„ååº”ï¼Œå¯è€ƒè™‘åˆå¹¶è¯·æ±‚æˆ–æ‰¹é‡æ¥å£ï¼ˆå½“å‰æœªæä¾›ï¼‰

## æ•…éšœæ’æŸ¥æŒ‡å—
- 401 æœªè®¤è¯
  - Upsert/Delete éœ€è¦ç™»å½•ï¼›è¯·æ£€æŸ¥é‰´æƒæµç¨‹ä¸ Token
- 403 æƒé™ä¸è¶³
  - Delete æ—¶è‹¥éåˆ›å»ºè€…ä¸”éè¶…çº§ç”¨æˆ·ä¼šæ‹’ç»ï¼›ç¡®è®¤ç”¨æˆ·èº«ä»½ä¸ç¬”è®°å½’å±
  - Delete æ—¶è‹¥è®°å½•ä¸å­˜åœ¨ä¹Ÿè¿”å› 403ï¼Œç”¨äºé˜²æ­¢ä¿¡æ¯æ³„éœ²
- 500 æœåŠ¡å™¨é”™è¯¯
  - æ•°æ®åº“è¿æ¥å¼‚å¸¸ã€SQL æ‰§è¡Œå¤±è´¥ã€è½¬æ¢æ¶ˆæ¯å¤±è´¥ç­‰æƒ…å†µ
- å‰ç«¯æ— æ˜¾ç¤º
  - è‹¥ reactions ä¸ºç©ºï¼ŒMemoReactionListView ä¸æ¸²æŸ“ï¼›è¯·ç¡®è®¤ ListMemoReactions è¿”å›å€¼ä¸å‰ç«¯ç¼“å­˜çŠ¶æ€

ç« èŠ‚æ¥æº
- [server/router/api/v1/reaction_service.go](file://server/router/api/v1/reaction_service.go#L35-L94)

## ç»“è®º
æœ¬ååº”ç³»ç»Ÿæä¾›äº†ç®€æ´è€Œå®Œæ•´çš„ç¬”è®°äº’åŠ¨èƒ½åŠ›ï¼šåˆ—å‡ºã€æ–°å¢/æ›´æ–°ã€åˆ é™¤ååº”ï¼Œå¹¶å…·å¤‡åŸºç¡€çš„æƒé™æ§åˆ¶ä¸å‰ç«¯å±•ç¤ºã€‚åç»­å¯è¿›ä¸€æ­¥å®Œå–„ï¼š
- å»é‡ Upsertï¼ˆåŒä¸€ç”¨æˆ·å¯¹åŒä¸€ç¬”è®°ä»…ä¿ç•™ä¸€æ¡ååº”ï¼‰
- ååº”ç»Ÿè®¡ä¸è¶‹åŠ¿åˆ†æï¼ˆæŒ‰æ—¶é—´çª—å£èšåˆï¼‰
- æ‰¹é‡æ¥å£ä¸ç¼“å­˜ç­–ç•¥
- æ›´ä¸°å¯Œçš„ååº”ç±»å‹ä¸è‡ªå®šä¹‰è¡¨æƒ…æ”¯æŒ

## é™„å½•

### æ•°æ®åº“æ¨¡å¼
- SQLiteï¼ˆè¿ç§»è„šæœ¬ï¼‰
  - æ—©æœŸç‰ˆæœ¬ï¼šstore/migration/sqlite/0.20/00__reaction.sql
  - æœ€æ–°ç‰ˆæœ¬ï¼šstore/migration/sqlite/LATEST.sql ä¸­åŒ…å« reaction è¡¨å®šä¹‰
- PostgreSQLï¼ˆè¿ç§»è„šæœ¬ï¼‰
  - æœ€æ–°ç‰ˆæœ¬ï¼šstore/migration/postgres/LATEST.sql ä¸­åŒ…å« reaction è¡¨å®šä¹‰

ç« èŠ‚æ¥æº
- [store/migration/sqlite/0.20/00__reaction.sql](file://store/migration/sqlite/0.20/00__reaction.sql)
- [store/migration/sqlite/LATEST.sql](file://store/migration/sqlite/LATEST.sql)
- [store/migration/postgres/LATEST.sql](file://store/migration/postgres/LATEST.sql)