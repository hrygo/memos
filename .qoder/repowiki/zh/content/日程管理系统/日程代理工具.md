# 日程代理工具

<cite>
**本文档引用的文件**
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go)
- [plugin/ai/agent/schedule_parrot_v2.go](file://plugin/ai/agent/schedule_parrot_v2.go)
- [plugin/ai/agent/context.go](file://plugin/ai/agent/context.go)
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go)
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go)
- [plugin/ai/schedule/recurrence.go](file://plugin/ai/schedule/recurrence.go)
- [plugin/ai/schedule/timezone_validator.go](file://plugin/ai/schedule/timezone_validator.go)
- [server/service/schedule/service.go](file://server/service/schedule/service.go)
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go)
- [plugin/ai/agent/tools/scheduler_test.go](file://plugin/ai/agent/tools/scheduler_test.go)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件系统性阐述日程代理工具在AI代理中的作用与集成方式，覆盖工具接口定义、调用协议、执行流程、参数解析、业务逻辑调用、结果格式化、与其他AI工具的协作机制（上下文传递与状态管理）、安全控制与权限验证、错误处理与异常恢复策略、测试方法与质量保证措施，并提供扩展新日程管理功能的指导。该工具体系基于框架无关的原生LLM工具调用，结合自然语言解析、时区处理与时序规则，构建了完整的日程智能代理。

## 项目结构
日程代理工具位于插件层与服务层之间，采用分层设计：
- 插件层（plugin/ai/agent）：定义工具接口、工具实现、对话上下文管理、原生Agent框架与工具适配器。
- 插件层（plugin/ai/schedule）：提供自然语言解析、递归规则与时区验证等能力。
- 服务层（server/service/schedule）：封装数据库访问、冲突检测、实例展开等业务逻辑。
- 路由层（server/router/api/v1）：对外暴露Schedule Agent服务，负责鉴权、会话与事件流式输出。

```mermaid
graph TB
subgraph "插件层"
A["agent/tools/scheduler.go<br/>日程工具实现"]
B["agent/scheduler_v2.go<br/>调度代理V2"]
C["agent/schedule_parrot_v2.go<br/>鹦鹉代理包装"]
D["agent/context.go<br/>对话上下文"]
E["agent/tool_adapter.go<br/>工具适配器"]
F["schedule/parser.go<br/>自然语言解析"]
G["schedule/recurrence.go<br/>递归规则"]
H["schedule/timezone_validator.go<br/>时区验证"]
end
subgraph "服务层"
I["server/service/schedule/service.go<br/>日程服务"]
end
subgraph "路由层"
J["server/router/api/v1/schedule_agent_service.go<br/>Schedule Agent服务"]
end
A --> I
B --> A
C --> B
D --> B
E --> B
F --> I
G --> I
H --> F
J --> B
```

图表来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L1-L1076)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L1-L371)
- [plugin/ai/agent/schedule_parrot_v2.go](file://plugin/ai/agent/schedule_parrot_v2.go#L1-L173)
- [plugin/ai/agent/context.go](file://plugin/ai/agent/context.go#L1-L488)
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L1-L237)
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go#L1-L378)
- [plugin/ai/schedule/recurrence.go](file://plugin/ai/schedule/recurrence.go#L1-L557)
- [plugin/ai/schedule/timezone_validator.go](file://plugin/ai/schedule/timezone_validator.go#L1-L247)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L1-L737)
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L1-L281)

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L1-L1076)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L1-L371)
- [plugin/ai/agent/schedule_parrot_v2.go](file://plugin/ai/agent/schedule_parrot_v2.go#L1-L173)
- [plugin/ai/agent/context.go](file://plugin/ai/agent/context.go#L1-L488)
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L1-L237)
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go#L1-L378)
- [plugin/ai/schedule/recurrence.go](file://plugin/ai/schedule/recurrence.go#L1-L557)
- [plugin/ai/schedule/timezone_validator.go](file://plugin/ai/schedule/timezone_validator.go#L1-L247)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L1-L737)
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L1-L281)

## 核心组件
- 工具接口与实现
  - 工具接口：定义统一的Name、Description、Run等方法，便于Agent动态调用。
  - 工具实现：包含日程查询、新增、查找空闲时间等工具，均实现输入校验、参数解析、业务调用与结果格式化。
- 原生Agent框架
  - 提供系统提示、工具描述、迭代执行与回调事件机制，支持非LangChainGo的原生工具调用。
- 自然语言解析与递归规则
  - 解析器将自然语言转换为结构化的日程字段（标题、开始/结束时间、地点、重复规则等），并进行时区与DST校验。
- 服务层
  - 封装数据库访问、冲突检测、实例展开与更新逻辑，确保原子性与一致性。
- 路由层
  - 对外提供非流式与流式聊天接口，负责鉴权、会话上下文管理与事件流式输出。

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L132-L614)
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L12-L237)
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go#L62-L348)
- [plugin/ai/schedule/recurrence.go](file://plugin/ai/schedule/recurrence.go#L40-L323)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L88-L302)
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L55-L260)

## 架构总览
日程代理工具采用“原生LLM工具调用 + 插件解析 + 服务层持久化”的架构。Agent通过工具描述向LLM提供工具签名，LLM根据用户输入决定调用顺序；工具在运行时解析参数、调用服务层并返回结构化结果；路由层负责鉴权、上下文与事件流式输出。

```mermaid
sequenceDiagram
participant U as "用户"
participant Svc as "ScheduleAgentService"
participant Agent as "SchedulerAgentV2"
participant Tool as "工具(查询/新增/空闲)"
participant Srv as "ScheduleService"
participant DB as "数据库"
U->>Svc : "发送消息(含用户时区)"
Svc->>Agent : "创建Agent并执行"
Agent->>Agent : "构建系统提示与工具描述"
Agent->>Tool : "根据LLM决策调用工具"
Tool->>Srv : "查询/创建/更新日程"
Srv->>DB : "读写日程记录"
DB-->>Srv : "返回结果"
Srv-->>Tool : "返回业务结果"
Tool-->>Agent : "返回格式化结果"
Agent-->>Svc : "回调事件(工具使用/结果/答案)"
Svc-->>U : "流式事件与最终答案"
```

图表来源
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L96-L260)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L175-L196)
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L183-L266)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L194-L302)

## 详细组件分析

### 工具接口与调用协议
- 工具接口
  - 统一的Name、Description、Run方法，便于Agent动态发现与调用。
  - 工具适配器支持将既有工具（如ScheduleQueryTool）转换为具备JSON Schema的ToolWithSchema，以便LLM理解参数。
- 调用协议
  - Agent通过ChatWithTools调用LLM，LLM返回工具调用列表与内容；Agent依次执行工具并将结果注入消息历史，直至LLM给出最终答案。
  - 回调事件包括“tool_use”、“tool_result”、“answer”，用于前端流式渲染与UI事件驱动。

```mermaid
classDiagram
class Tool {
+Name() string
+Description() string
+Run(ctx, input) (string, error)
}
class ToolWithSchema {
+Parameters() map[string]interface{}
}
class NativeTool {
-name string
-description string
-execute func
-params map[string]interface{}
+Name() string
+Description() string
+Parameters() map[string]interface{}
+Run(ctx, input) (string, error)
}
Tool <|.. NativeTool
ToolWithSchema <|.. NativeTool
```

图表来源
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L12-L77)

章节来源
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L12-L237)

### 日程查询工具（ScheduleQueryTool）
- 功能职责
  - 在指定时间范围内查询现有日程，避免冲突。
  - 支持驼峰/蛇形字段兼容（normalizeJSONFields）。
- 参数解析与校验
  - 必填字段：start_time、end_time；格式：ISO8601；end_time需晚于start_time。
- 业务逻辑
  - 获取用户ID（从上下文），调用服务层FindSchedules，返回实例列表。
- 结果格式化
  - 输出人类可读的列表，包含标题、时间范围、地点、是否重复等信息；若无日程则返回“未找到”。

```mermaid
flowchart TD
Start(["进入 ScheduleQueryTool.Run"]) --> Norm["规范化JSON字段"]
Norm --> Parse["解析输入(start_time,end_time)"]
Parse --> Validate{"校验通过?"}
Validate -- 否 --> Err["返回错误"]
Validate -- 是 --> GetUID["获取用户ID"]
GetUID --> Query["调用服务层查询"]
Query --> Found{"是否有结果?"}
Found -- 否 --> NoRes["返回'未找到'"]
Found -- 是 --> Format["格式化输出(标题/时间/地点/重复)"]
Format --> End(["返回结果"])
Err --> End
NoRes --> End
```

图表来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L183-L266)

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L132-L284)

### 日程新增工具（ScheduleAddTool）
- 功能职责
  - 在冲突检测后创建日程；若冲突存在，尝试自动调整或提供替代时间槽。
- 参数解析与校验
  - 必填：title、start_time；可选：end_time（缺省1小时）、description、location、all_day。
- 业务逻辑
  - 解析时间，构造CreateScheduleRequest，调用服务层CreateSchedule。
  - 若发生冲突，使用ConflictResolver寻找替代时间；若仍失败，返回结构化冲突错误。
- 结果格式化
  - 成功：返回“已创建”提示，包含标题、时间范围、地点等；若时间被自动调整，标注“时间冲突已自动调整”。
  - 失败：返回冲突错误（包含替代时间槽）。

```mermaid
flowchart TD
Start(["进入 ScheduleAddTool.Run"]) --> Norm["规范化JSON字段"]
Norm --> Parse["解析输入(title,start_time,end_time,etc.)"]
Parse --> Validate{"校验通过?"}
Validate -- 否 --> Err["返回错误"]
Validate -- 是 --> ParseTime["解析start/end时间"]
ParseTime --> GetUID["获取用户ID"]
GetUID --> CreateReq["构造CreateScheduleRequest"]
CreateReq --> Create["调用服务层创建"]
Create --> Conflict{"冲突?"}
Conflict -- 否 --> Success["记录审计日志并格式化输出"]
Conflict -- 是 --> Resolve["冲突解析(寻找替代)"]
Resolve --> HasAlt{"有替代?"}
HasAlt -- 否 --> ErrAlt["返回冲突错误(含替代)"]
HasAlt -- 是 --> Retry["重试创建(替代时间)"]
Retry --> RetryOk{"重试成功?"}
RetryOk -- 否 --> ErrAlt
RetryOk -- 是 --> Success
Success --> End(["返回结果"])
Err --> End
ErrAlt --> End
```

图表来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L459-L648)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L194-L302)

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L389-L648)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L37-L68)

### 查找空闲时间工具（FindFreeTimeTool）
- 功能职责
  - 在指定日期内查找可用的1小时时间槽，用于冲突后的替代方案。
- 参数解析与校验
  - 必填：date（YYYY-MM-DD）；解析为用户时区的当天开始/结束。
- 业务逻辑
  - 查询当日所有日程，遍历8:00-22:00的每小时槽位，返回第一个空闲槽位（起始时间）。
- 结果格式化
  - 返回ISO8601起始时间（需自行加1小时作为结束时间）；若无空闲槽则报错。

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L692-L848)

### 自然语言解析器（Parser）
- 功能职责
  - 将自然语言转换为结构化日程字段，包括标题、描述、地点、开始/结束时间、全天标记、提醒与递归规则。
- 输入规范
  - 当前UTC与本地时间参考、用户时区、相对日期计算步骤、时间格式要求、全天事件处理、时长计算规则、输出JSON模式、递归规则提取、标题清洗规则、提醒提取规则。
- 输出规范
  - ParseResult：包含标题、描述、地点、UTC时间戳、全天标记、时区、提醒与递归规则。
- 时区与DST校验
  - 使用TimezoneValidator对时间范围进行验证，处理夏令时跳变导致的无效/模糊时间。

```mermaid
flowchart TD
Start(["进入 Parser.Parse"]) --> Trim["去除空白/长度限制"]
Trim --> LLM["调用LLM生成JSON"]
LLM --> Clean["清理代码块标记"]
Clean --> ParseJSON["解析JSON为结构体"]
ParseJSON --> Convert["转换为UTC时间戳"]
Convert --> Validate["时区/DST验证"]
Validate --> Build["构建ParseResult"]
Build --> End(["返回结果"])
```

图表来源
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go#L62-L348)
- [plugin/ai/schedule/timezone_validator.go](file://plugin/ai/schedule/timezone_validator.go#L110-L129)

章节来源
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go#L62-L348)
- [plugin/ai/schedule/timezone_validator.go](file://plugin/ai/schedule/timezone_validator.go#L14-L147)

### 递归规则与实例展开
- 规则类型
  - daily、weekly、monthly三种类型，支持间隔、工作日筛选与月日设定。
- 实例生成
  - 生成指定时间窗内的实例列表，支持迭代器懒加载，避免一次性生成过多实例。
- 展开与查询
  - 服务层在查询时将模板日程按规则展开为实例，限制最大实例数量以防止性能问题。

章节来源
- [plugin/ai/schedule/recurrence.go](file://plugin/ai/schedule/recurrence.go#L40-L323)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L88-L192)

### 调度代理V2（SchedulerAgentV2）
- 组件职责
  - 创建工具集合（查询、新增、空闲、更新），构建系统提示，执行Agent并处理UI事件回调。
- 事件驱动UI
  - 监听“tool_use”与“tool_result”，在冲突时发出UI冲突解决事件，支持建议日程与替代槽位。
- 会话上下文
  - 通过ConversationContext维护多轮对话状态，支持精炼（如“改为3点”）与工作流步骤跟踪。

章节来源
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L16-L91)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L175-L371)
- [plugin/ai/agent/context.go](file://plugin/ai/agent/context.go#L19-L101)

### 鹦鹉代理包装（ScheduleParrotV2）
- 组件职责
  - 为调度代理提供统一的ParrotAgent接口，支持历史对话回放、流式聊天与自我描述。
- 回调适配
  - 将旧版回调签名适配为新版事件数据结构，确保UI事件正确传递。

章节来源
- [plugin/ai/agent/schedule_parrot_v2.go](file://plugin/ai/agent/schedule_parrot_v2.go#L1-L173)

### 路由层（ScheduleAgentService）
- 非流式与流式接口
  - Chat：一次性返回最终答案。
  - ChatStream：事件流式输出，包含“tool_use”、“tool_result”、“answer”等事件，以及“schedule_updated”刷新事件。
- 鉴权与会话
  - 从请求上下文中获取用户ID与时区，创建Agent并执行；使用ContextStore管理会话上下文。
- 响应净化
  - 移除可能泄漏的工具调用语法，确保用户侧响应整洁。

章节来源
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L55-L260)

## 依赖关系分析
- 组件耦合
  - 工具依赖服务层（schedule.Service）进行数据访问与业务处理。
  - Agent依赖工具适配器与工具描述，实现动态工具发现与调用。
  - 路由层依赖Agent与ContextStore，负责鉴权与事件流式输出。
- 外部依赖
  - LLM服务：提供ChatWithTools能力，支持原生工具调用。
  - 数据库：通过store层抽象，提供日程CRUD与约束保证。
- 循环依赖
  - 未发现循环依赖；各层职责清晰，接口边界明确。

```mermaid
graph LR
Agent["Agent"] --> Tools["工具集合"]
Tools --> Svc["ScheduleService"]
Svc --> Store["Store/DB"]
Agent --> LLM["LLM服务"]
Router["ScheduleAgentService"] --> Agent
Router --> Ctx["ContextStore"]
```

图表来源
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L100-L117)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L83-L86)
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L43-L53)

章节来源
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L100-L117)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L83-L86)
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L43-L53)

## 性能考虑
- 工具链路
  - 工具输入解析与字段规范化（驼峰/蛇形映射）采用轻量级JSON处理，避免不必要的内存分配。
  - 时区解析使用大小受限的缓存（最多100项），防止DoS攻击与内存膨胀。
- 递归展开
  - 服务层限制最大实例数量（默认100，递归场景提升至500），并使用小时索引优化冲突检测。
- 迭代上限
  - Agent最大迭代次数默认10次，防止无限工具调用循环。
- 流式输出
  - 路由层事件流式发送，减少一次性大响应带来的延迟。

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L30-L94)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L28-L35)
- [plugin/ai/agent/tool_adapter.go](file://plugin/ai/agent/tool_adapter.go#L100-L104)

## 故障排除指南
- 权限与鉴权
  - 路由层在Chat/ChatStream中检查用户ID，未授权返回401；请确认认证头与用户上下文。
- 工具调用失败
  - 工具内部返回错误时，Agent将其包装为“Error: ...”并注入消息历史；检查工具输入格式与必需字段。
- 冲突检测
  - 服务层返回ErrScheduleConflict，包含冲突计数与替代时间槽；前端可据此触发UI冲突解决流程。
- 时区与DST
  - 解析器与验证器会处理无效/模糊时间；若出现异常，检查用户时区设置与输入时间是否处于DST跳变区间。
- 日志与可观测性
  - 路由层与工具层均记录关键事件（tool_use、tool_result、answer、error），便于定位问题。

章节来源
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L59-L61)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L37-L68)
- [plugin/ai/schedule/timezone_validator.go](file://plugin/ai/schedule/timezone_validator.go#L41-L96)

## 结论
日程代理工具通过原生LLM工具调用与插件解析相结合，实现了从自然语言到结构化日程的完整闭环。其核心优势在于：
- 明确的工具接口与事件驱动回调，便于扩展与UI联动；
- 强大的冲突检测与替代时间槽机制，保障日程一致性；
- 完善的时区与DST处理，提升跨时区体验；
- 清晰的分层架构与严格的性能与安全控制，适合生产环境部署。

## 附录

### 安全控制与权限验证
- 认证与授权
  - 路由层在Chat/ChatStream中校验用户ID，未授权请求直接拒绝。
- 数据隔离
  - 工具与服务层均通过用户ID过滤数据，确保仅访问当前用户日程。
- 审计日志
  - 新增日程时记录关键字段（标题、描述、开始/结束时间、地点、是否全天、时区），并对敏感信息进行截断处理。

章节来源
- [server/router/api/v1/schedule_agent_service.go](file://server/router/api/v1/schedule_agent_service.go#L59-L61)
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L574-L587)

### 错误处理与异常恢复策略
- 工具层
  - 输入校验失败、时间格式错误、缺少必要字段等，立即返回错误。
- 服务层
  - 冲突检测失败返回ErrScheduleConflict；数据库约束冲突转换为友好错误。
- Agent层
  - 最大迭代次数保护；工具未知或执行失败时，注入错误消息并继续对话。
- UI层
  - 冲突时通过UI事件（ui_conflict_resolution）提供替代时间槽；空闲时间查询失败时提示用户。

章节来源
- [plugin/ai/agent/tools/scheduler.go](file://plugin/ai/agent/tools/scheduler.go#L268-L284)
- [server/service/schedule/service.go](file://server/service/schedule/service.go#L264-L285)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L308-L315)

### 测试方法与质量保证
- 单元测试
  - 覆盖ScheduleQueryTool与ScheduleAddTool的Run与Validate方法，包括正常路径、缺失字段、格式错误、冲突等场景。
- 模拟服务
  - 使用MockScheduleService模拟Find/Create/Update/Delete与冲突检测，确保测试独立可控。
- 质量保障
  - 严格的数据结构与错误码定义；日志与可观测性覆盖关键路径；性能指标（缓存命中/未命中、迭代次数、实例展开数量）可追踪。

章节来源
- [plugin/ai/agent/tools/scheduler_test.go](file://plugin/ai/agent/tools/scheduler_test.go#L14-L273)

### 扩展新日程管理功能
- 新增工具
  - 实现Tool接口或继承BaseTool，定义Name、Description、Run与可选的Validate/Parameters。
  - 在SchedulerAgentV2中注册工具，确保系统提示与工作流步骤覆盖。
- 新增解析规则
  - 在Parser中扩展系统提示与输出模式，增加新的字段提取（如参与者、优先级等）。
- 新增递归规则
  - 在RecurrenceRule中扩展类型与生成逻辑，注意实例数量限制与迭代器懒加载。
- UI联动
  - 在SchedulerAgentV2中扩展UI事件类型与数据结构，前端监听并渲染相应控件。

章节来源
- [plugin/ai/agent/base_tool.go](file://plugin/ai/agent/base_tool.go#L10-L135)
- [plugin/ai/agent/scheduler_v2.go](file://plugin/ai/agent/scheduler_v2.go#L58-L71)
- [plugin/ai/schedule/parser.go](file://plugin/ai/schedule/parser.go#L95-L254)
- [plugin/ai/schedule/recurrence.go](file://plugin/ai/schedule/recurrence.go#L40-L75)