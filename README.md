# Memos

> 本项目是 [usememos/memos](https://github.com/usememos/memos) 的分支。

Memos 是一个**隐私优先、AI 驱动的个人智能助手**，结合了轻量级笔记记录、智能日程管理和多智能体 AI 能力。

## ✨ 亮点

- 🦜 **多智能体 AI 系统** – 三个专业化的"鹦鹉智能体"处理不同任务
- 🧠 **智能 RAG 管线** – BM25 + 向量搜索 + 重排序的混合检索
- 📅 **智能日程管理** – 日历视图 + 自然语言输入 + 冲突检测
- 🔒 **隐私优先** – 自托管，无遥测，数据完全由你掌控

---

## 💬 AI 对话会话

Memos 提供**持久化 AI 对话会话**，具备智能消息管理：

### 消息类型

| 类型    | 计数 | 前端显示 | LLM 上下文 | 描述                         |
| ------- | ---- | -------- | ---------- | ---------------------------- |
| MSG     | ✓    | ✓        | ✓          | 用户/助手消息（限 100 条）   |
| SEP     | ✗    | ✓        | ✗          | 上下文分隔符（视觉分割线）   |
| SUMMARY | ✗    | ✗        | ✓          | 自动生成的摘要（不可见）     |

### 核心功能

- **持久化对话** – 所有对话会话存储在 PostgreSQL
- **增量同步** – 基于 UID 分页高效加载消息
- **FIFO 缓存** – 前端维护每个对话 100 条 MSG 缓存
- **上下文分隔** – 使用 `---` 手动清除对话上下文
- **自动摘要** – 11 条消息后自动生成对话摘要
- **多设备同步** – 对话状态跨设备同步

### 消息同步流程

```
首次加载          → 最新 100 条 MSG（含 SEP）
增量加载          → lastMessageUid 之后的消息（最多 100 条 MSG）
UID 未找到        → sync_required 标志触发全量刷新
```

---

## 📅 日程管理

Memos 提供**专用日程管理模块**，支持日历可视化和 AI 驱动的自然语言输入：

### 两种访问模式

| 模式       | 入口        | 界面                     | 使用场景                   |
| ---------- | ----------- | ------------------------ | -------------------------- |
| **独立式** | `/schedule` | FullCalendar + 快捷输入  | 可视化规划、拖拽调整       |
| **对话式** | `/chat` → 金刚智能体 | 自然语言           | "明天下午3点开会"          |

### 核心功能

- **日历视图** – 月/周/日视图（FullCalendar）
- **快捷输入** – 带日期上下文的自然语言创建日程
- **冲突检测** – 自动检查重叠日程
- **空闲时间查找** – AI 建议可用时段（8:00-22:00）
- **拖拽调整** – 在日历上拖动事件重新安排
- **重复规则** – 基于 RRULE 的重复日程（每天/每周/每月）

### 日程智能体（金刚）工具

| 工具              | 功能                   |
| ----------------- | ---------------------- |
| `schedule_add`    | 创建新日程并检查冲突   |
| `schedule_query`  | 按时间范围查询日程     |
| `schedule_update` | 修改已有日程           |
| `find_free_time`  | 查找可用时间段         |

---

## 🦜 Parrot AI 智能体

Memos 使用**多智能体架构**，由专业化的 AI 助手（以鹦鹉物种命名）处理不同任务：

| 智能体       | 名称     | 鹦鹉物种                  | 专业领域         | 核心能力                                                   |
| ------------ | -------- | ------------------------- | ---------------- | ---------------------------------------------------------- |
| 🦜 `MEMO`     | **灰灰** | 非洲灰鹦鹉 (African Grey) | 笔记搜索与检索   | 语义搜索、笔记摘要、RAG 问答                               |
| 📅 `SCHEDULE` | **金刚** | 金刚鹦鹉 (Macaw)          | 日程管理         | 创建/查询/更新日程、冲突检测、查找空闲时间                 |
| ⭐ `AMAZING`  | **惊奇** | 亚马逊鹦鹉 (Amazon)       | 综合助手         | 并行笔记 + 日程检索、整合分析                              |

### 智能体选择

Memos 使用**基于意图的智能路由**，由混合 Rule + LLM 分类器驱动：

```
用户输入 → ChatRouter（后端）
                 ↓
         ┌──────┴──────┐
         ↓             ↓
    规则匹配       LLM 分类
     (0ms)         (~400ms)
         ↓             ↓
         └──────┬──────┘
                ↓
    MEMO / SCHEDULE / AMAZING
```

- **规则匹配**（快速路径）：高置信度关键词匹配
- **LLM 回退**：处理模糊输入的语义理解
- **手动指定**：使用 `@` 符号或点击 Parrot Hub 中的智能体卡片

### 智能体技术详情

<details>
<summary><b>🦜 灰灰 (MEMO) – 记忆与检索专家</b></summary>

**工作方式**：ReAct 循环 – 先搜索，再基于检索证据回答

**工具**：
- `memo_search` – 基于嵌入相似度的全笔记语义搜索

**趣闻**：以著名的非洲灰鹦鹉 Alex 命名，它能理解 100+ 词汇概念！
</details>

<details>
<summary><b>📅 金刚 (SCHEDULE) – 时间管理专家</b></summary>

**工作方式**：ReAct 循环，直接高效 – 默认 1 小时时长，自动冲突检测

**工具**：
- `schedule_add` – 创建新日程并自动检查冲突
- `schedule_query` – 按时间范围查询日程
- `schedule_update` – 修改已有日程
- `find_free_time` – 查找可用时间段（8:00-22:00）

**趣闻**：金刚鹦鹉以守时著称，总是遵循固定的日常作息！
</details>

<details>
<summary><b>⭐ 惊奇 (AMAZING) – 综合多任务助手</b></summary>

**工作方式**：两阶段并发检索 – 意图分析 → 并行工具执行 → 答案合成

**工具**：整合 MEMO 和 SCHEDULE 智能体的能力

**趣闻**：亚马逊鹦鹉是最健谈的鹦鹉之一 – 就像惊奇在一次对话中展现多种超能力！
</details>

---

## 🧠 核心技术栈

### 智能 RAG 管线

```
查询 → QueryRouter → 缓存检查
                         ├─ 缓存命中 → 返回（60% 命中率）
                         └─ 缓存未命中 → AdaptiveRetriever → 更新缓存
                                              │
                              ┌───────────────┼───────────────┐
                              ▼               ▼               ▼
                           BM25           向量检索        重排序器
                       (PostgreSQL)    (pgvector)    (bge-reranker-v2-m3)
                              │               │               │
                              └───────────────┴───────────────┘
                                              │
                                          RRF 融合 → 结果
```

| 组件             | 技术                    | 用途                                          |
| ---------------- | ----------------------- | --------------------------------------------- |
| **向量搜索**     | pgvector + HNSW         | 相似度检索（m=16, ef_construction=64）        |
| **全文搜索**     | PostgreSQL FTS + BM25   | 关键词检索（tsvector/GIN 索引）               |
| **重排序器**     | BAAI/bge-reranker-v2-m3 | 交叉编码器重排序提升精度                      |
| **嵌入模型**     | BAAI/bge-m3 (1024d)     | 稠密向量嵌入（SiliconFlow 提供）              |
| **大语言模型**   | DeepSeek V3             | 推理、摘要、智能体执行                        |

### 智能查询路由

`QueryRouter` 自动检测查询意图并路由到最优检索策略：

| 策略                          | 触发条件                       | 使用场景             |
| ----------------------------- | ------------------------------ | -------------------- |
| `schedule_bm25_only`          | 时间关键词（"今天"、"本周"）   | 日程查询             |
| `memo_semantic_only`          | 概念性查询                     | 纯向量搜索           |
| `hybrid_bm25_weighted`        | 混合关键词                     | BM25 + 向量融合      |
| `hybrid_with_time_filter`     | 时间 + 关键词                  | 带过滤的混合搜索     |
| `full_pipeline_with_reranker` | 复杂查询                       | 完整 RAG + 重排序    |

### 日程智能

- **自然语言解析** – "明天下午3点开会" → 创建明天 15:00 的日程
- **冲突检测** – 自动检查重叠日程
- **空闲时间查找** – 在 8:00-22:00 范围内建议可用时段
- **重复支持** – 基于 RRULE 的重复日程（每天/每周/每月）

---

## 🏗️ 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    前端 (React + Vite)                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                     RootLayout                            │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────────┐  │   │
│  │  │ MainLayout │  │ AIChat     │  │ ScheduleLayout     │  │   │
│  │  │ (笔记)     │  │ Layout     │  │ (日历)             │  │   │
│  │  └────────────┘  └────────────┘  └────────────────────┘  │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │ Connect RPC (HTTP/2)
┌─────────────────────────────────────────────────────────────────┐
│                     后端 (Go + Echo)                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   MemoService   │  │ ScheduleService │  │   AIService     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
│                              │                                   │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    ChatRouter (意图路由)                     ││
│  │         规则匹配 (0ms) → LLM 回退 (~400ms)                  ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐       ││
│  │  │  MemoParrot  │  │ScheduleParrot│  │AmazingParrot │       ││
│  │  │    (灰灰)     │  │    (金刚)     │  │    (惊奇)     │       ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘       ││
│  └─────────────────────────────────────────────────────────────┘│
│  ┌─────────────────┐  ┌─────────────────┐                       │
│  │AdaptiveRetriever│  │  QueryRouter    │                       │
│  │ (混合搜索)       │  │ (RAG 策略)      │                       │
│  └─────────────────┘  └─────────────────┘                       │
└─────────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────────┐
│                     存储层 & AI 层                               │
│  ┌─────────────────┐  ┌─────────────────────────────────────┐   │
│  │   PostgreSQL    │  │          AI 服务提供商               │   │
│  │  ├─ memo        │  │  ┌─────────┐ ┌───────┐ ┌─────────┐  │   │
│  │  ├─ schedule    │  │  │嵌入模型 │ │重排序 │ │   LLM   │  │   │
│  │  ├─ conversation│  │  │(bge-m3) │ │(bge)  │ │(DeepSeek│  │   │
│  │  └─ pgvector    │  │  └─────────┘ └───────┘ └─────────┘  │   │
│  └─────────────────┘  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🚀 快速开始

### 前置条件

- Go 1.25+
- Node.js 22+ & pnpm
- Docker（用于 PostgreSQL）

### 本地开发

```bash
# 1. 克隆仓库
git clone https://github.com/hrygo/memos.git
cd memos

# 2. 安装依赖
make deps-all

# 3. 启动开发环境
make start
```

自动启动：
- **PostgreSQL**（Docker 容器，含 pgvector）
- **后端** http://localhost:28081
- **前端** http://localhost:25173

### 构建

```bash
# 后端
make build

# 前端
make build-web
```

### Docker 部署

```bash
docker run -d \
  --name memos \
  -p 5230:5230 \
  -v ~/.memos:/var/opt/memos \
  hrygo/memos:stable
```

---

## 🛠️ 技术栈

### 后端

| 组件       | 技术                | 用途                       |
| ---------- | ------------------- | -------------------------- |
| 语言       | Go 1.25+            | 高性能、并发               |
| 框架       | Echo + Connect RPC  | gRPC-HTTP 转码             |
| 数据库     | PostgreSQL 16+      | 主存储（含 pgvector）      |
| 向量引擎   | pgvector (HNSW)     | 相似度搜索                 |
| 缓存       | Redis 7+（可选）    | L2 缓存、会话              |

### 前端

| 组件   | 技术                    | 用途                       |
| ------ | ----------------------- | -------------------------- |
| 框架   | React 18                | 并发特性、Suspense         |
| 构建   | Vite 7                  | 快速 HMR、优化构建         |
| 状态   | TanStack Query          | 服务端状态、缓存           |
| UI     | Radix UI + Tailwind CSS | 可访问、可主题化           |
| 日历   | FullCalendar            | 日程可视化                 |

### AI 服务

| 服务     | 提供商      | 模型                    |
| -------- | ----------- | ----------------------- |
| 嵌入     | SiliconFlow | BAAI/bge-m3 (1024d)     |
| 重排序   | SiliconFlow | BAAI/bge-reranker-v2-m3 |
| LLM      | DeepSeek    | DeepSeek V3             |

---

## 📊 数据库支持

| 数据库     | 状态                    | AI 功能                                          | 推荐用途             |
| ---------- | ----------------------- | ------------------------------------------------ | -------------------- |
| PostgreSQL | ✅ 完全支持             | ✅ 所有 AI 功能（对话、向量、重排序）             | 生产环境             |
| SQLite     | ⚠️ 仅开发环境           | ❌ **不支持 AI 功能**                             | 非 AI 功能开发       |

> ⚠️ **重要**：SQLite 不支持 AI 功能（对话持久化、向量搜索、重排序）。
> 生产环境 AI 功能请使用 PostgreSQL。详见 [BACKEND_DB.md](docs/dev-guides/BACKEND_DB.md)。

---

## 📁 项目结构

```
memos/
├── cmd/memos/                # 应用主入口
├── server/                   # Go 后端
│   ├── router/api/v1/       # API 处理器（Connect RPC）
│   │   └── ai/              # AI 聊天组件
│   │       ├── context_builder.go     # LLM 上下文构建
│   │       └── conversation_summarizer.go  # 自动摘要
│   ├── queryengine/         # 查询路由 & 意图检测
│   ├── retrieval/           # 自适应检索（BM25 + 向量）
│   ├── runner/              # 后台任务运行器
│   ├── scheduler/           # 日程管理
│   └── service/             # 业务逻辑层
├── plugin/ai/               # AI 组件
│   ├── agent/               # Parrot 智能体
│   │   ├── memo_parrot.go
│   │   ├── schedule_parrot_v2.go
│   │   ├── amazing_parrot.go
│   │   ├── chat_router.go   # 基于意图的智能体路由（Rule + LLM）
│   │   └── tools/           # 智能体工具（scheduler, memo_search）
│   ├── embedding.go         # 嵌入服务
│   ├── reranker.go          # 重排序服务
│   └── llm.go               # LLM 服务
├── store/                   # 数据存储层
│   └── db/                  # 数据库实现
│       ├── postgres/        # PostgreSQL（生产）
│       └── sqlite/          # SQLite（开发）
├── proto/                   # Protocol Buffers
├── web/                     # React 前端
│   └── src/
│       ├── components/      # UI 组件
│       ├── contexts/        # React 上下文
│       │   └── AIChatContext.tsx  # AI 聊天状态管理
│       ├── layouts/         # 页面布局
│       ├── pages/           # 路由页面
│       │   └── AIChat.tsx    # AI 聊天页面
│       └── hooks/           # React Hooks
├── docs/                    # 文档
│   └── dev-guides/          # 开发指南
└── scripts/                 # 开发 & 部署脚本
```

---

## 📖 文档

| 文档                                               | 描述                           |
| -------------------------------------------------- | ------------------------------ |
| [BACKEND_DB.md](docs/dev-guides/BACKEND_DB.md)     | 后端开发 & 数据库策略          |
| [FRONTEND.md](docs/dev-guides/FRONTEND.md)         | 前端架构 & 布局模式            |
| [ARCHITECTURE.md](docs/dev-guides/ARCHITECTURE.md) | 项目架构 & Parrot 智能体详情   |
| [QUICKSTART_AGENT.md](docs/dev-guides/QUICKSTART_AGENT.md) | 智能体测试快速入门     |

---

## 📄 许可证

[MIT](LICENSE)
