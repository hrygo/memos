# 聊天服务数据一致性问题修复实施方案

## 一、概述

本实施方案旨在修复聊天窗口中日程和笔记问答流程中发现的 5 个关键问题，确保聊天信息与实际数据的一致性。

**版本**: v1.0
**日期**: 2026-01-21
**负责人**: 开发团队

---

## 二、问题清单与优先级

| ID | 问题 | 严重程度 | 影响范围 | 修复优先级 |
|----|------|----------|----------|-----------|
| P1 | 两个 ChatWithMemos 实现不一致 | 严重 | Connect RPC 用户 | P0 |
| P2 | 时区处理不一致 | 严重 | 跨时区用户 | P0 |
| P3 | 日程查询时间过滤逻辑宽松 | 中等 | 跨天日程查询 | P1 |
| P4 | 时间解析年份推断单一 | 中等 | 未来年份查询 | P1 |
| P5 | 检索策略停用词过滤简单 | 轻微 | 意图识别准确性 | P2 |

---

## 三、实施阶段划分

### 阶段 1: 紧急修复 (P0) - 1 周

**目标**: 解决导致数据完全不一致的严重问题

**包含任务**:
- P1: 统一两个 ChatWithMemos 实现
- P2: 统一时区处理

**交付物**:
- 统一的 Chat 服务实现
- 时区一致性保证

---

### 阶段 2: 重要优化 (P1) - 1 周

**目标**: 改善查询准确性和用户体验

**包含任务**:
- P3: 优化日程查询时间过滤逻辑
- P4: 改进时间解析年份推断

**交付物**:
- 更精确的日程查询结果
- 支持明确的年份查询

---

### 阶段 3: 体验改进 (P2) - 3 天

**目标**: 提升意图识别准确性

**包含任务**:
- P5: 优化检索策略停用词过滤

**交付物**:
- 更准确的意图识别

---

## 四、详细任务分解

### 任务 P1: 统一两个 ChatWithMemos 实现

**文件**:
- `server/router/api/v1/ai_service_chat.go`
- `server/router/api/v1/connect_handler.go`

**子任务**:
1. 提取公共逻辑到独立的 helper 函数
2. 确保 connect_handler.go 发送完整的 Done 响应
3. 确保 connect_handler.go 返回 ScheduleQueryResult
4. 确保两个实现使用相同的日程时间格式

**验收标准**:
- [ ] 两个实现返回相同的结构化数据
- [ ] 前端能正确解析和显示日程查询结果
- [ ] 所有现有测试通过

**参考规格**: `specs/CHAT_SERVICE_UNIFICATION.md`

---

### 任务 P2: 统一时区处理

**文件**:
- `server/queryengine/query_router.go`
- `server/retrieval/adaptive_retrieval.go`
- `server/router/api/v1/ai_service_chat.go`
- `server/router/api/v1/connect_handler.go`

**子任务**:
1. 定义统一的时区策略（全程 UTC 或用户时区）
2. 更新 QueryRouter 的时间计算逻辑
3. 更新日程时间格式化逻辑
4. 添加时区转换的工具函数

**验收标准**:
- [ ] 所有时间计算使用统一的时区
- [ ] 用户看到的时间与存储的时间一致
- [ ] 跨时区用户的日程显示正确
- [ ] 所有时间相关的测试通过

**参考规格**: `specs/TIMEZONE_UNIFICATION.md`

---

### 任务 P3: 优化日程查询时间过滤逻辑

**文件**:
- `store/db/postgres/schedule.go`
- `store/db/sqlite/schedule.go`
- `store/db/mysql/schedule.go`

**子任务**:
1. 重新定义时间范围查询的语义
2. 添加可选的严格模式（只返回完全在范围内的日程）
3. 更新查询条件和文档

**验收标准**:
- [ ] 查询"今天"只返回今天的日程
- [ ] 跨天日程的查询结果符合用户预期
- [ ] 所有数据库实现的测试通过

**参考规格**: `specs/SCHEDULE_QUERY_OPTIMIZATION.md`

---

### 任务 P4: 改进时间解析年份推断

**文件**:
- `server/queryengine/query_router.go`

**子任务**:
1. 支持明确指定年份的查询
2. 改进年份推断的启发式规则
3. 添加年份识别的正则表达式

**验收标准**:
- [ ] 支持"2025年1月21日"格式
- [ ] 支持"明年1月21日"格式
- [ ] 所有日期解析测试通过

**参考规格**: `specs/SCHEDULE_QUERY_OPTIMIZATION.md`

---

### 任务 P5: 优化检索策略停用词过滤

**文件**:
- `server/queryengine/query_router.go`

**子任务**:
1. 改进停用词列表
2. 添加内容词的权重判断
3. 优化意图检测逻辑

**验收标准**:
- [ ] 意图识别准确率提升
- [ ] 误判率降低
- [ ] 所有意图检测测试通过

**参考规格**: `specs/INTENT_DETECTION_OPTIMIZATION.md`

---

## 五、依赖关系

```
P2 (时区统一)
    ↓
P1 (Chat 服务统一) ← 基础设施
    ↓
P3 (时间过滤优化)
P4 (年份推断改进)
    ↓
P5 (意图检测优化)
```

**说明**:
- P2 必须最先完成，因为它影响所有时间相关逻辑
- P1 依赖 P2 的时区统一
- P3 和 P4 可以并行开发
- P5 可以最后进行，不影响核心功能

---

## 六、测试策略

### 单元测试

**覆盖率要求**: ≥ 80%

**关键测试场景**:
1. 时间范围解析（所有支持格式）
2. 时区转换（UTC ↔ 本地时区）
3. 日程查询边界条件
4. 年份推断逻辑
5. 意图识别准确性

### 集成测试

**测试场景**:
1. 完整的聊天流程（用户查询 → 检索 → LLM → 响应）
2. 日程创建流程（意图检测 → 解析 → 创建）
3. 混合查询（笔记 + 日程）

### E2E 测试

**关键用户旅程**:
1. 用户查询今天的日程
2. 用户查询特定日期的日程
3. 用户查询明年的日程
4. 跨时区用户查询日程
5. 用户创建新的日程

---

## 七、风险与缓解措施

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 时区统一破坏现有功能 | 高 | 中 | 全面的回归测试，分阶段发布 |
| 两个实现合并引入 bug | 高 | 中 | 详细的代码审查，保持测试覆盖 |
| 时间过滤逻辑变更影响用户体验 | 中 | 低 | 可配置的查询模式，保留旧逻辑作为备选 |
| 性能退化 | 中 | 低 | 性能基准测试，优化关键路径 |

---

## 八、回滚计划

**触发条件**:
- 生产环境出现严重 bug
- 性能下降超过 20%
- 用户投诉率显著上升

**回滚步骤**:
1. 立即停止部署
2. 回滚到上一个稳定版本
3. 分析问题根因
4. 修复后重新测试和部署

**保留的兼容性**:
- API 接口保持向后兼容
- 数据库 schema 不变更
- 现有配置文件格式不变

---

## 九、里程碑与时间表

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M1: 设计完成 | Day 2 | 所有设计规格文档 |
| M2: P0 修复完成 | Day 7 | P1 和 P2 修复，测试通过 |
| M3: P1 优化完成 | Day 14 | P3 和 P4 修复，测试通过 |
| M4: P2 改进完成 | Day 17 | P5 修复，所有测试通过 |
| M5: 发布候选 | Day 19 | 完整的回归测试，性能验证 |
| M6: 正式发布 | Day 21 | 生产环境部署 |

---

## 十、成功指标

### 技术指标
- [ ] 所有单元测试通过率 100%
- [ ] 代码覆盖率 ≥ 80%
- [ ] 性能回归 < 5%
- [ ] 零 P0/P1 bug

### 业务指标
- [ ] 用户投诉率下降 ≥ 50%
- [ ] 日程查询准确率 ≥ 95%
- [ ] 跨时区用户满意度 ≥ 90%

---

## 十一、相关文档

- **设计规格**:
  - `specs/CHAT_SERVICE_UNIFICATION.md` - Chat 服务统一化
  - `specs/TIMEZONE_UNIFICATION.md` - 时区统一化
  - `specs/SCHEDULE_QUERY_OPTIMIZATION.md` - 日程查询优化
  - `specs/INTENT_DETECTION_OPTIMIZATION.md` - 意图检测优化

- **技术文档**:
  - `docs/PROJECT_STRUCTURE.md` - 项目结构
  - `docs/optimal_rag/` - RAG 优化文档

- **测试文档**:
  - `server/queryengine/query_router_date_parsing_test.go`
  - `server/router/api/v1/connect_handler_schedule_test.go`
