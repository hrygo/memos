# Memos AI èƒ½åŠ›å®ç°æ–¹æ¡ˆ

> ä¸º Memos çŸ¥è¯†ç®¡ç†å¹³å°å¢åŠ  AI æ™ºèƒ½èƒ½åŠ›

> **âš ï¸ æ•°æ®åº“æ”¯æŒè¯´æ˜**
>
> AI åŠŸèƒ½å’Œæ‰€æœ‰åç»­æ–°åŠŸèƒ½ä»…æ”¯æŒ **PostgreSQL** å’Œ **SQLite** æ•°æ®åº“ã€‚
>
> **åŸå› **ï¼š
> - å‘é‡æœç´¢ï¼ˆpgvectorï¼‰ä»…åœ¨ PostgreSQL ä¸Šå¯ç”¨
> - MySQL ç¼ºä¹ JSON å­—æ®µçº¦æŸå’Œé«˜çº§è§¦å‘å™¨æ”¯æŒ
> - ç»´æŠ¤ä¸‰æ•°æ®åº“å…¼å®¹æ€§çš„æˆæœ¬è¿‡é«˜
>
> **å»ºè®®**ï¼šç°æœ‰ MySQL ç”¨æˆ·è¯·è¿ç§»åˆ° PostgreSQL ä»¥è·å¾—å®Œæ•´åŠŸèƒ½ã€‚

## é¡¹ç›®ç°çŠ¶
> 
> æˆªè‡³å½“å‰ï¼Œåç«¯æ ¸å¿ƒåŠŸèƒ½å·²å…¨éƒ¨å®Œæˆï¼Œæ­£å¤„äºå‰ç«¯é›†æˆé˜¶æ®µã€‚
> 
> - **å·²å®Œæˆ Backend**: 
>   - åŸºç¡€è®¾æ–½ (Proto, Config, DB Migration)
>   - æ¨¡å‹å±‚ (Embedding, Reranker, LLM)
>   - å­˜å‚¨å±‚ (PostgreSQL Vector Search)
>   - æœåŠ¡å±‚ (Background Runner, gRPC APIs)
> - **å¾…å¼€å‘ Frontend**:
>   - React Hookså°è£…
>   - UI ç»„ä»¶é›†æˆ (Search, Chat, Tags)

## æŠ€æœ¯æ¶æ„

### æŠ€æœ¯é€‰å‹

| ç»„ä»¶           | æŠ€æœ¯æ–¹æ¡ˆ                              | è¯´æ˜                      |
| -------------- | ------------------------------------- | ------------------------- |
| **å‘é‡æ•°æ®åº“** | PostgreSQL + pgvector                 | å¤ç”¨ç°æœ‰ PGï¼Œ1:1 å‘é‡å­˜å‚¨ |
| **å‘é‡æ¨¡å‹**   | SiliconFlow `BAAI/bge-m3`             | 1024 ç»´ï¼Œä¸­è‹±åŒè¯­         |
| **é‡æ’åº**     | SiliconFlow `BAAI/bge-reranker-v2-m3` | æå‡æ£€ç´¢ç²¾åº¦              |
| **å¤§è¯­è¨€æ¨¡å‹** | DeepSeek `deepseek-chat`              | ä½æˆæœ¬ï¼Œé«˜è´¨é‡            |
| **Go SDK**     | `tmc/langchaingo`                     | ç»Ÿä¸€å¤šä¾›åº”å•†è°ƒç”¨          |

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ SemanticSearchâ”‚  â”‚ AI Chat Box â”‚  â”‚ Tag Suggestions        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ gRPC / Connect
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AIService (Go gRPC)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  Provider Abstraction                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚  â”‚Embedding â”‚  â”‚ Reranker â”‚  â”‚   LLM    â”‚                â”‚   â”‚
â”‚  â”‚  â”‚ Provider â”‚  â”‚ Provider â”‚  â”‚ Provider â”‚                â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â”‚       â”‚             â”‚             â”‚                       â”‚   â”‚
â”‚  â”‚  SiliconFlow   SiliconFlow    DeepSeek                   â”‚   â”‚
â”‚  â”‚  OpenAI        Cohere         OpenAI                     â”‚   â”‚
â”‚  â”‚  Ollama        -              Ollama                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Store Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   memo_embedding â”‚  â”‚  PostgreSQL + pgvector               â”‚ â”‚
â”‚  â”‚   (1:1 å¤–é”®)     â”‚  â”‚  - HNSW ç´¢å¼•                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - Cosine ç›¸ä¼¼åº¦                     â”‚ â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åŠŸèƒ½è§„æ ¼

### API å®šä¹‰

```protobuf
service AIService {
  // è¯­ä¹‰æœç´¢
  rpc SemanticSearch(SemanticSearchRequest) returns (SemanticSearchResponse);
  // æ ‡ç­¾æ¨è
  rpc SuggestTags(SuggestTagsRequest) returns (SuggestTagsResponse);
  // AI å¯¹è¯ (æµå¼)
  rpc ChatWithMemos(ChatWithMemosRequest) returns (stream ChatWithMemosResponse);
  // ç›¸å…³ç¬”è®°
  rpc GetRelatedMemos(GetRelatedMemosRequest) returns (GetRelatedMemosResponse);
}
```

### è¯­ä¹‰æœç´¢æµç¨‹

```
Query â†’ Embedding â†’ pgvector(Top 10) â†’ Rerank(Top 10) â†’ Response
```

> æ³¨: 2C2Gç¯å¢ƒä¸‹å‡å°‘åˆå§‹å¬å›é‡ä»¥é™ä½å†…å­˜å’ŒCPUå‹åŠ›

### RAG å¯¹è¯æµç¨‹

1. è¯­ä¹‰æ£€ç´¢ç›¸å…³ç¬”è®° (Top 5)
2. æ„å»º Prompt (ç³»ç»Ÿæç¤º + ç¬”è®°ä¸Šä¸‹æ–‡ + ç”¨æˆ·é—®é¢˜)
3. æµå¼è°ƒç”¨ LLM ç”Ÿæˆå›ç­”
4. è¿”å›å›ç­” + å¼•ç”¨æ¥æº

---

## æ•°æ®æ¨¡å‹

### memo_embedding è¡¨

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE memo_embedding (
    id SERIAL PRIMARY KEY,
    memo_id INTEGER NOT NULL REFERENCES memo(id) ON DELETE CASCADE,
    embedding vector(1024) NOT NULL,
    model VARCHAR(100) NOT NULL DEFAULT 'BAAI/bge-m3',
    created_ts BIGINT NOT NULL,
    updated_ts BIGINT NOT NULL,
    UNIQUE(memo_id, model)
);

CREATE INDEX idx_memo_embedding_hnsw
ON memo_embedding USING hnsw (embedding vector_cosine_ops)
WITH (m = 8, ef_construction = 32);  -- 2C2Gä¼˜åŒ–
```

---

## é…ç½®

### ç¯å¢ƒå˜é‡

```bash
# å¯ç”¨ AI
MEMOS_AI_ENABLED=true

# SiliconFlow (å‘é‡ + é‡æ’åº)
MEMOS_AI_SILICONFLOW_API_KEY=sk-xxx

# DeepSeek (LLM)
MEMOS_AI_DEEPSEEK_API_KEY=sk-xxx

# å¯é€‰ï¼šåˆ‡æ¢ä¾›åº”å•†
MEMOS_AI_EMBEDDING_PROVIDER=siliconflow  # siliconflow | openai | ollama
MEMOS_AI_LLM_PROVIDER=deepseek           # deepseek | openai | ollama
```

### å‚æ•°é…ç½®

| å‚æ•°             | å€¼     | è¯´æ˜                               |
| ---------------- | ------ | ---------------------------------- |
| å‘é‡ç»´åº¦         | 1024   | bge-m3 åŸç”Ÿç»´åº¦                    |
| ç´¢å¼•ç±»å‹         | HNSW   | m=8, ef_construction=32 (2C2Gä¼˜åŒ–) |
| å‘é‡å¬å›         | Top 10 | åˆå§‹å¬å›é‡ (2C2Gä¼˜åŒ–)              |
| Rerank è¿”å›      | Top 10 | æœ€ç»ˆè¿”å›é‡                         |
| RAG ä¸Šä¸‹æ–‡       | 5 æ¡   | é€å…¥ LLM çš„ç¬”è®°æ•°                  |
| LLM temperature  | 0.7    | å¹³è¡¡åˆ›é€ æ€§å’Œå‡†ç¡®æ€§                 |
| Embedding æ‰¹å¤„ç† | 8      | åå°ä»»åŠ¡æ‰¹æ¬¡å¤§å° (2C2G)            |
| åå°ä»»åŠ¡é—´éš”     | 2 åˆ†é’Ÿ | å‘é‡ç”Ÿæˆè½®è¯¢é—´éš” (2C2G)            |

---

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶                                  | è¯´æ˜                         |
| ------------------------------------- | ---------------------------- |
| `proto/api/v1/ai_service.proto`       | gRPC æœåŠ¡å®šä¹‰                |
| `plugin/ai/config.go`                 | AI é…ç½®è§£æ                  |
| `plugin/ai/embedding.go`              | Embedding æœåŠ¡ (langchaingo) |
| `plugin/ai/reranker.go`               | Reranker æœåŠ¡                |
| `plugin/ai/llm.go`                    | LLM æœåŠ¡ (langchaingo)       |
| `store/memo_embedding.go`             | MemoEmbedding æ¨¡å‹           |
| `store/db/postgres/memo_embedding.go` | å‘é‡æœç´¢å®ç°                 |
| `server/router/api/v1/ai_service.go`  | AI gRPC æœåŠ¡                 |
| `server/runner/embedding/runner.go`   | åå°å‘é‡ç”Ÿæˆ                 |
| `web/src/hooks/useAIQueries.ts`       | AI React Query Hooks         |

### ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶                          | è¯´æ˜             |
| ----------------------------- | ---------------- |
| `internal/profile/profile.go` | æ·»åŠ  AI é…ç½®å­—æ®µ |
| `store/driver.go`             | æ‰©å±• Driver æ¥å£ |
| `server/server.go`            | æ³¨å†Œ AI æœåŠ¡     |

### æ•°æ®åº“è¿ç§»

| æ–‡ä»¶                                                | è¯´æ˜         |
| --------------------------------------------------- | ------------ |
| `store/migration/postgres/0.30/1__add_pgvector.sql` | å‘é‡è¡¨å’Œç´¢å¼• |

---

## æˆæœ¬ä¼°ç®—

### æœˆåº¦æˆæœ¬ (ä¸ªäººä½¿ç”¨)

å‡è®¾ï¼š1,000 æ¡ç¬”è®°ï¼Œæ¯æ—¥ 20 æ¬¡æœç´¢ï¼Œ10 æ¬¡å¯¹è¯

| é¡¹ç›®                    | æœˆæˆæœ¬      |
| ----------------------- | ----------- |
| Embedding (SiliconFlow) | ~$0.01      |
| Rerank (SiliconFlow)    | ~$0.01      |
| LLM (DeepSeek)          | ~$0.50      |
| **æ€»è®¡**                | **< $1/æœˆ** |

---

## é‡Œç¨‹ç¢‘

| é˜¶æ®µ | å·¥ä½œå†…å®¹                   | æ—¶é—´ | çŠ¶æ€     |
| ---- | -------------------------- | ---- | -------- |
| M1   | Proto + é…ç½® + Migration   | 2 å¤© | âœ… å·²å®Œæˆ |
| M2   | AI æ’ä»¶ (langchaingo é›†æˆ) | 3 å¤© | âœ… å·²å®Œæˆ |
| M3   | Store å±‚å‘é‡æœç´¢           | 2 å¤© | âœ… å·²å®Œæˆ |
| M4   | gRPC æœåŠ¡å®ç°              | 2 å¤© | âœ… å·²å®Œæˆ |
| M5   | å‰ç«¯é›†æˆ                   | 2 å¤© | âœ… å·²å®Œæˆ |
| M6   | æµ‹è¯• + æ–‡æ¡£                | 1 å¤© | ğŸ”„ è¿›è¡Œä¸­ |

**æ€»è®¡ï¼š12 å·¥ä½œæ—¥**
