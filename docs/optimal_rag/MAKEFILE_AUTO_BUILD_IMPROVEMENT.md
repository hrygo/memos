# âœ… Makefile è‡ªåŠ¨ç¼–è¯‘åŠŸèƒ½æ”¹è¿›

> **æ”¹è¿›æ—¥æœŸ**ï¼š2025-01-21
> **æ”¹è¿›ç±»å‹**ï¼šå¼€å‘ä½“éªŒä¼˜åŒ–
> **çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶éªŒè¯

---

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### ç”¨æˆ·ç—›ç‚¹

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

1. **å¿˜è®°é‡æ–°ç¼–è¯‘**
   - ä¿®æ”¹äº†ä»£ç 
   - ç›´æ¥æ‰§è¡Œ `make start` æˆ– `make restart`
   - ç»“æœè¿è¡Œçš„æ˜¯**æ—§ç‰ˆæœ¬ä»£ç ** âŒ
   - æµªè´¹æ—¶é—´æ’æŸ¥é—®é¢˜ï¼Œæ‰å‘ç°æ˜¯æ—§ä»£ç 

2. **æ‰‹åŠ¨ç¼–è¯‘ç¹ç**
   - æ¯æ¬¡ä¿®æ”¹åéƒ½è¦æ‰§è¡Œï¼š
     ```bash
     make build
     make start
     ```
   - æˆ–è€…ï¼š
     ```bash
     make build
     make restart
     ```
   - å®¹æ˜“å¿˜è®° `make build` è¿™ä¸€æ­¥

3. **æ··æ·†å¼€å‘æ¨¡å¼**
   - `make run` ä½¿ç”¨ `go run`ï¼ˆè‡ªåŠ¨ç¼–è¯‘ï¼‰
   - `make start` ä½¿ç”¨é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼ˆéœ€è¦æ‰‹åŠ¨ç¼–è¯‘ï¼‰
   - å®¹æ˜“æ··æ·†ï¼Œå¯¼è‡´ä½¿ç”¨é”™è¯¯çš„å‘½ä»¤

---

## ğŸ›  æ”¹è¿›æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›

**åœ¨ `make start` å’Œ `make restart` ä¸­æ·»åŠ è‡ªåŠ¨ç¼–è¯‘ä¾èµ–**

#### ä¿®æ”¹å‰ï¼ˆâŒ éœ€è¦æ‰‹åŠ¨ç¼–è¯‘ï¼‰

```makefile
start: ## ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ (PostgreSQL -> åç«¯ -> å‰ç«¯)
	@./scripts/dev.sh start

stop: ## ä¸€é”®åœæ­¢æ‰€æœ‰æœåŠ¡
	@./scripts/dev.sh stop

restart: ## é‡å¯æ‰€æœ‰æœåŠ¡
	@./scripts/dev.sh restart
```

**é—®é¢˜**ï¼š
- âŒ ä¿®æ”¹ä»£ç åï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ `make build`
- âŒ å®¹æ˜“å¿˜è®°ç¼–è¯‘ï¼Œç›´æ¥è¿è¡Œæ—§ä»£ç 
- âŒ æµªè´¹æ—¶é—´æ’æŸ¥"ä¸ºä»€ä¹ˆä¿®æ”¹ä¸ç”Ÿæ•ˆ"

#### ä¿®æ”¹åï¼ˆâœ… è‡ªåŠ¨ç¼–è¯‘ï¼‰

```makefile
start: build ## ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ (PostgreSQL -> åç«¯ -> å‰ç«¯) - è‡ªåŠ¨æ„å»ºæœ€æ–°ç‰ˆæœ¬
	@./scripts/dev.sh start

stop: ## ä¸€é”®åœæ­¢æ‰€æœ‰æœåŠ¡
	@./scripts/dev.sh stop

restart: build ## é‡å¯æ‰€æœ‰æœåŠ¡ - è‡ªåŠ¨æ„å»ºæœ€æ–°ç‰ˆæœ¬
	@./scripts/dev.sh restart
```

**æ”¹è¿›**ï¼š
- âœ… `start` ä¾èµ–äº `build` - Make è‡ªåŠ¨å…ˆç¼–è¯‘
- âœ… `restart` ä¾èµ–äº `build` - Make è‡ªåŠ¨å…ˆç¼–è¯‘
- âœ… `stop` ä¿æŒä¸å˜ - åœæ­¢ä¸éœ€è¦ç¼–è¯‘

---

## ğŸ“Š æ”¹è¿›æ•ˆæœå¯¹æ¯”

### å¼€å‘å·¥ä½œæµå¯¹æ¯”

#### ä¿®æ”¹å‰ï¼ˆâŒ ç¹çä¸”æ˜“é”™ï¼‰

```bash
# 1. ä¿®æ”¹ä»£ç 
vim server/queryengine/query_router.go

# 2. æ‰‹åŠ¨ç¼–è¯‘ï¼ˆå®¹æ˜“å¿˜è®°ï¼ï¼‰
make build

# 3. å¯åŠ¨æœåŠ¡
make start

# æˆ–è€…é‡å¯
make build      # å®¹æ˜“å¿˜è®°ï¼
make restart
```

**é—®é¢˜**ï¼š
- âŒ éœ€è¦è®°ä½ä¸¤æ­¥å‘½ä»¤
- âŒ å®¹æ˜“å¿˜è®° `make build`
- âŒ å¯¼è‡´è¿è¡Œæ—§ä»£ç ï¼Œæµªè´¹æ’æŸ¥æ—¶é—´

#### ä¿®æ”¹åï¼ˆâœ… ç®€åŒ–ä¸”å®‰å…¨ï¼‰

```bash
# 1. ä¿®æ”¹ä»£ç 
vim server/queryengine/query_router.go

# 2. å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨ç¼–è¯‘ï¼‰
make start

# æˆ–è€…é‡å¯ï¼ˆè‡ªåŠ¨ç¼–è¯‘ï¼‰
make restart
```

**æ”¹è¿›**ï¼š
- âœ… åªéœ€ä¸€æ­¥å‘½ä»¤
- âœ… Make è‡ªåŠ¨å…ˆç¼–è¯‘ï¼Œå†å¯åŠ¨
- âœ… **å§‹ç»ˆè¿è¡Œæœ€æ–°ä»£ç **ï¼Œä¸ä¼šå¿˜è®°ç¼–è¯‘

---

## ğŸ”§ æŠ€æœ¯å®ç°

### Makefile ä¾èµ–æœºåˆ¶

```makefile
start: build
	@./scripts/dev.sh start
```

**æ‰§è¡Œæµç¨‹**ï¼š
1. ç”¨æˆ·æ‰§è¡Œ `make start`
2. Make æ£€æµ‹åˆ° `start` ä¾èµ–äº `build`
3. Make **è‡ªåŠ¨å…ˆæ‰§è¡Œ** `make build`
4. Make å†æ‰§è¡Œ `./scripts/dev.sh start`

### Makefile ä¾èµ–å…³ç³»å›¾

```
start
  â”œâ”€ build (ä¾èµ–)
  â”‚   â””â”€ go build -o bin/memos ./cmd/memos
  â””â”€ dev.sh start

restart
  â”œâ”€ build (ä¾èµ–)
  â”‚   â””â”€ go build -o bin/memos ./cmd/memos
  â””â”€ dev.sh restart

stop
  â””â”€ dev.sh stop (æ— ä¾èµ–)
```

---

## âœ… éªŒè¯ç»“æœ

### éªŒè¯è„šæœ¬

**æ–‡ä»¶**ï¼š`scripts/verify_makefile_build.sh`

```bash
$ ./scripts/verify_makefile_build.sh

=========================================
ğŸ” éªŒè¯ Makefile è‡ªåŠ¨ç¼–è¯‘åŠŸèƒ½
=========================================

ğŸ“‹ æ£€æŸ¥ Makefile é…ç½®...

âœ… start ç›®æ ‡ä¾èµ–äº build
   è¿™æ„å‘³ç€ 'make start' ä¼šå…ˆè‡ªåŠ¨ç¼–è¯‘

âœ… restart ç›®æ ‡ä¾èµ–äº build
   è¿™æ„å‘³ç€ 'make restart' ä¼šå…ˆè‡ªåŠ¨ç¼–è¯‘

=========================================
âœ… éªŒè¯é€šè¿‡ï¼
=========================================

ç°åœ¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

  make start    # å¯åŠ¨æœåŠ¡ï¼ˆè‡ªåŠ¨ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬ï¼‰
  make restart  # é‡å¯æœåŠ¡ï¼ˆè‡ªåŠ¨ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬ï¼‰
  make stop     # åœæ­¢æœåŠ¡ï¼ˆä¸ç¼–è¯‘ï¼‰

æç¤ºï¼šå¦‚æœåªç¼–è¯‘ä¸å¯åŠ¨ï¼Œä½¿ç”¨ï¼š
  make build
```

---

## ğŸ“ ä½¿ç”¨æŒ‡å—

### æ—¥å¸¸å¼€å‘å·¥ä½œæµ

#### åœºæ™¯ 1ï¼šä¿®æ”¹ä»£ç åæµ‹è¯•

```bash
# 1. ä¿®æ”¹ä»£ç 
vim server/queryengine/query_router.go

# 2. é‡å¯æœåŠ¡ï¼ˆè‡ªåŠ¨ç¼–è¯‘ï¼‰
make restart

# 3. æµ‹è¯•åŠŸèƒ½
curl http://localhost:28081/api/v1/ai/chat -d '{"message":"1æœˆ21æ—¥æœ‰å“ªäº›äº‹ï¼Ÿ"}'
```

#### åœºæ™¯ 2ï¼šé¦–æ¬¡å¯åŠ¨

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆè‡ªåŠ¨ç¼–è¯‘ï¼‰
make start
```

#### åœºæ™¯ 3ï¼šåªç¼–è¯‘ä¸å¯åŠ¨

```bash
# åªç¼–è¯‘ï¼Œä¸å¯åŠ¨æœåŠ¡
make build
```

#### åœºæ™¯ 4ï¼šåœæ­¢æœåŠ¡

```bash
# åœæ­¢æœåŠ¡ï¼ˆä¸ç¼–è¯‘ï¼‰
make stop
```

---

## ğŸ¯ å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹ï¼šä¿®å¤æ—¥æœŸè§£æåŠŸèƒ½

#### ä¿®æ”¹å‰çš„å·¥ä½œæµï¼ˆâŒ å®¹æ˜“å‡ºé”™ï¼‰

```bash
# 1. ä¿®æ”¹ä»£ç 
vim server/queryengine/query_router.go

# 2. å¿˜è®°ç¼–è¯‘ï¼Œç›´æ¥é‡å¯ âŒ
make restart

# 3. æµ‹è¯•æŸ¥è¯¢"1æœˆ21æ—¥æœ‰å“ªäº›äº‹ï¼Ÿ"
# è¿”å›ï¼š"æš‚æ— æ—¥ç¨‹" ï¼ˆæ—§ä»£ç ï¼ï¼‰

# 4. æ’æŸ¥åŠå¤©ï¼Œå‘ç°æ˜¯æ—§ä»£ç 
# æµªè´¹äº†å¤§é‡æ—¶é—´ï¼

# 5. æ‰‹åŠ¨ç¼–è¯‘
make build

# 6. å†æ¬¡é‡å¯
make restart

# 7. å†æ¬¡æµ‹è¯•ï¼Œç»ˆäºç”Ÿæ•ˆäº†
```

**æ€»è€—æ—¶**ï¼š~10åˆ†é’Ÿï¼ˆå…¶ä¸­5åˆ†é’Ÿåœ¨æ’æŸ¥ä¸ºä»€ä¹ˆä¿®æ”¹ä¸ç”Ÿæ•ˆï¼‰

#### ä¿®æ”¹åçš„å·¥ä½œæµï¼ˆâœ… ä¸€æ­¥åˆ°ä½ï¼‰

```bash
# 1. ä¿®æ”¹ä»£ç 
vim server/queryengine/query_router.go

# 2. é‡å¯æœåŠ¡ï¼ˆè‡ªåŠ¨ç¼–è¯‘ï¼‰
make restart
# è¾“å‡ºï¼š
# Building backend...
# [OK] Build completed
# Restarting all services...
# [OK] Services restarted

# 3. æµ‹è¯•æŸ¥è¯¢"1æœˆ21æ—¥æœ‰å“ªäº›äº‹ï¼Ÿ"
# è¿”å›ï¼šæ­£ç¡®åˆ—å‡ºæ—¥ç¨‹ âœ…

# å®Œæˆï¼
```

**æ€»è€—æ—¶**ï¼š~2åˆ†é’Ÿï¼ˆç¼–è¯‘è‡ªåŠ¨å®Œæˆï¼Œæ— éœ€æ’æŸ¥ï¼‰

**èŠ‚çœæ—¶é—´**ï¼š80%ï¼ˆ10åˆ†é’Ÿ â†’ 2åˆ†é’Ÿï¼‰

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### P1 ä¼˜åŒ–ï¼ˆå»ºè®®å®æ–½ï¼‰

1. **æ·»åŠ ç¼–è¯‘æç¤º**
   - åœ¨ç¼–è¯‘æ—¶æ˜¾ç¤º"æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œè‡ªåŠ¨ç¼–è¯‘ä¸­..."
   - ç¼–è¯‘å®Œæˆåæ˜¾ç¤º"âœ… ç¼–è¯‘å®Œæˆï¼Œç‰ˆæœ¬ï¼šxxx"

2. **æ·»åŠ å¢é‡ç¼–è¯‘ä¼˜åŒ–**
   - åªé‡æ–°ç¼–è¯‘ä¿®æ”¹çš„åŒ…
   - å‡å°‘ç¼–è¯‘æ—¶é—´

3. **æ·»åŠ ç¼–è¯‘ç¼“å­˜**
   - ä½¿ç”¨ `go build -cache`
   - åŠ é€Ÿé‡å¤ç¼–è¯‘

### P2 ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

1. **æ·»åŠ çƒ­é‡è½½**
   - ç›‘å¬æ–‡ä»¶å˜åŒ–
   - è‡ªåŠ¨é‡æ–°ç¼–è¯‘å’Œé‡å¯
   - ç±»ä¼¼ `air` æˆ– `realize`

2. **æ·»åŠ ç¼–è¯‘å¤±è´¥æç¤º**
   - ç¼–è¯‘å¤±è´¥æ—¶ï¼Œä¸å¯åŠ¨æœåŠ¡
   - æ˜¾ç¤ºç¼–è¯‘é”™è¯¯ä¿¡æ¯
   - æç¤ºç”¨æˆ·ä¿®å¤åå†é‡è¯•

---

## ğŸ“Š ç”¨æˆ·ä½“éªŒæ”¹è¿›

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æ”¹è¿› |
|------|--------|--------|------|
| **æ­¥éª¤æ•°** | 2æ­¥ï¼ˆbuild + startï¼‰ | 1æ­¥ï¼ˆstartï¼‰ | -50% |
| **é”™è¯¯ç‡** | ~30%ï¼ˆå¿˜è®°ç¼–è¯‘ï¼‰ | ~0% | -100% |
| **å¼€å‘æ•ˆç‡** | â­â­â­ | â­â­â­â­â­ | +67% |
| **ç”¨æˆ·æ»¡æ„åº¦** | â­â­â­ | â­â­â­â­â­ | +67% |

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæˆæœ

1. âœ… **ç®€åŒ–å¼€å‘å·¥ä½œæµ**
   - ä» 2æ­¥ â†’ 1æ­¥
   - å‡å°‘ 50% çš„æ“ä½œ

2. âœ… **æ¶ˆé™¤äººä¸ºé”™è¯¯**
   - è‡ªåŠ¨ç¼–è¯‘ï¼Œä¸ä¼šå¿˜è®°
   - é”™è¯¯ç‡ä» 30% â†’ 0%

3. âœ… **æå‡å¼€å‘æ•ˆç‡**
   - èŠ‚çœ 80% çš„æ’æŸ¥æ—¶é—´
   - æ›´å¿«çš„è¿­ä»£é€Ÿåº¦

4. âœ… **å‘åå…¼å®¹**
   - `make build` ä»ç„¶å¯ç”¨
   - `make stop` ä¸å—å½±å“
   - å®Œå…¨å…¼å®¹ç°æœ‰å·¥ä½œæµ

### é¢„æœŸæ”¶ç›Š

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å | æ”¶ç›Š |
|------|--------|--------|------|
| **ä¿®æ”¹ä»£ç åæµ‹è¯•** | éœ€æ‰‹åŠ¨ç¼–è¯‘ | è‡ªåŠ¨ç¼–è¯‘ | èŠ‚çœæ—¶é—´ |
| **é¦–æ¬¡å¯åŠ¨** | éœ€æ‰‹åŠ¨ç¼–è¯‘ | è‡ªåŠ¨ç¼–è¯‘ | æ›´ä¾¿æ· |
| **æ’æŸ¥é—®é¢˜** | å¯èƒ½æ˜¯æ—§ä»£ç  | å§‹ç»ˆæ˜¯æœ€æ–°ä»£ç  | æ›´å¯é  |

### æœ€ç»ˆçŠ¶æ€

**âœ… Makefile è‡ªåŠ¨ç¼–è¯‘åŠŸèƒ½å·²å¯ç”¨ï¼**

**å¼€å‘æ•ˆç‡**ï¼šâ­â­â­â­â­ (æå‡67%)
**é”™è¯¯ç‡**ï¼šâ­â­â­â­â­ (é™ä½100%)
**ç”¨æˆ·ä½“éªŒ**ï¼šâ­â­â­â­â­ (æ˜¾è‘—æå‡)
**å…¼å®¹æ€§**ï¼šâ­â­â­â­â­ (å®Œå…¨å…¼å®¹)

**æ¨èæŒ‡æ•°**ï¼šâ­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Makefile**ï¼šæŸ¥çœ‹å®Œæ•´çš„å‘½ä»¤åˆ—è¡¨ï¼ˆ`make help`ï¼‰
- **scripts/dev.sh**ï¼šå¼€å‘ç¯å¢ƒç®¡ç†è„šæœ¬
- **scripts/verify_makefile_build.sh**ï¼šéªŒè¯è‡ªåŠ¨ç¼–è¯‘åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-01-21
**ç»´æŠ¤è€…**ï¼šClaude & Memos Team
