# Memos AI 产品统一实施路线图

> **版本**: v1.0  
> **日期**: 2026-01-27  
> **定位**: 隐私优先的私人 AI 助理平台  
> **整合范围**: 智能助理 + 日程管理 + 笔记 AI 增强

---

## 相关文档导航

本文档整合自以下调研与规划文档：

| 领域 | 调研报告 | 实施路线图 |
|:---|:---|:---|
| **智能助理** | [assistant-research.md](./assistant-research.md) | [assistant-roadmap.md](./assistant-roadmap.md) |
| **日程管理** | [schedule-research.md](./schedule-research.md) | [schedule-roadmap.md](./schedule-roadmap.md) |
| **笔记增强** | [memo-research.md](./memo-research.md) | [memo-roadmap.md](./memo-roadmap.md) |
| **行业参考** | - | [assistant-roadmap-industry.md](./assistant-roadmap-industry.md) |

---

## 一、整合策略总览

### 1.1 核心整合原则

| 原则 | 说明 | 实践 |
|:---|:---|:---|
| **能力下沉** | 可复用能力抽象为公共服务 | 记忆/评估/路由/缓存统一由 A 团队提供 |
| **依赖清晰** | 上层能力明确依赖底层服务 | B/C 团队基于 A 团队接口开发 |
| **接口优先** | 先定义接口，再并行开发 | Sprint 0 完成接口契约 |
| **阶段对齐** | 三团队按统一节奏交付 | 每 Phase 有明确的集成里程碑 |

### 1.2 团队职责划分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           三团队职责架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                    ┌─────────────────────────────────────┐                  │
│                    │        用户交互层 (Frontend)         │                  │
│                    └─────────────────────────────────────┘                  │
│                                     │                                       │
│           ┌─────────────────────────┼─────────────────────────┐             │
│           │                         │                         │             │
│           ▼                         ▼                         ▼             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │    团队 B        │    │    团队 C        │    │    团队 B        │         │
│  │  智能助理核心    │    │  笔记 AI 增强    │    │  日程管理 Agent  │         │
│  │                 │    │                 │    │                 │         │
│  │ • ChatRouter    │    │ • 搜索高亮      │    │ • 时间解析      │         │
│  │ • 对话管理      │    │ • 相关推荐      │    │ • 快速创建      │         │
│  │ • 习惯学习      │    │ • 智能标签      │    │ • 批量日程      │         │
│  │ • 预测交互      │    │ • 重复检测      │    │ • 提醒系统      │         │
│  │                 │    │ • 知识图谱      │    │                 │         │
│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘         │
│           │                      │                      │                   │
│           └──────────────────────┼──────────────────────┘                   │
│                                  │                                          │
│                                  ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        团队 A: 公共 AI 基础服务                          │ │
│  │                                                                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │ 记忆系统    │ │ 评估框架    │ │ LLM 路由    │ │ 缓存服务    │      │ │
│  │  │ (2层架构)   │ │ (轻量指标)  │ │ (规则+LLM)  │ │ (LRU)       │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  │                                                                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │ 时间解析    │ │ 向量检索    │ │ 本地模型    │ │ 会话持久化  │      │ │
│  │  │ (多格式)    │ │ (pgvector)  │ │ (Ollama)    │ │ (DB)        │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 资源冲突消解

| 原路线图 | 冲突项 | 整合方案 |
|:---|:---|:---|
| 助理 + 日程 | 记忆系统重复设计 | **合并**: A 团队提供统一记忆服务 |
| 助理 + 日程 | 规则分类器重复 | **合并**: A 团队提供统一 LLM 路由 |
| 助理 + 日程 | 缓存实现重复 | **合并**: A 团队提供通用缓存层 |
| 笔记 + 助理 | 向量检索重复 | **合并**: A 团队提供统一向量检索服务 |
| 日程 + 助理 | 会话持久化重复 | **合并**: A 团队提供统一会话存储 |

---

## 二、统一分阶段实施方案

### 2.1 Phase 总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    统一 Phase 规划 (3 Phase / 6 Sprint)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Sprint 0          Phase 1              Phase 2              Phase 3        │
│  接口契约           基础稳定             智能进化              极致体验        │
│  ════════          ═══════════         ═══════════          ═══════════    │
│  (1 Sprint)        (Sprint 1-2)        (Sprint 3-4)         (Sprint 5-6)   │
│                                                                             │
│  ┌──────────┐     ┌──────────────┐    ┌──────────────┐    ┌──────────────┐ │
│  │ 接口定义 │     │ A: 核心基础  │    │ A: 智能增强  │    │ A: 本地模型  │ │
│  │ 数据模型 │ →   │ B: 助理稳定  │ →  │ B: 习惯学习  │ →  │ B: 预测交互  │ │
│  │ 契约测试 │     │ C: 检索增强  │    │ C: 智能整理  │    │ C: 知识沉淀  │ │
│  └──────────┘     └──────────────┘    └──────────────┘    └──────────────┘ │
│                                                                             │
│  ROI: ★★★★★       ROI: ★★★★★         ROI: ★★★★☆         ROI: ★★★☆☆       │
│  (消除阻塞)        (解决核心痛点)       (提升智能度)        (差异化竞争)      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、Sprint 0: 接口契约 (基础准备)

**目标**: 定义团队间接口，消除并行开发阻塞

### 3.1 团队 A 对外接口定义

```go
// ==================== 公共服务接口定义 ====================

// 1. 记忆服务接口
type MemoryService interface {
    // 短期记忆 (会话内)
    GetRecentMessages(ctx context.Context, sessionID string, limit int) ([]Message, error)
    AddMessage(ctx context.Context, sessionID string, msg Message) error
    
    // 长期记忆 (跨会话)
    SaveEpisode(ctx context.Context, episode EpisodicMemory) error
    SearchEpisodes(ctx context.Context, query string, limit int) ([]EpisodicMemory, error)
    
    // 用户偏好
    GetPreferences(ctx context.Context, userID int32) (*UserPreferences, error)
    UpdatePreferences(ctx context.Context, userID int32, prefs *UserPreferences) error
}

// 2. LLM 路由服务接口
type RouterService interface {
    // 意图分类 (规则优先 → LLM 兜底)
    ClassifyIntent(ctx context.Context, input string) (Intent, float32, error)
    
    // 模型选择 (本地/云端)
    SelectModel(ctx context.Context, task TaskType) (ModelConfig, error)
}

// 3. 向量检索服务接口
type VectorService interface {
    // 向量存储
    StoreEmbedding(ctx context.Context, docID string, vector []float32, metadata map[string]any) error
    
    // 相似度检索
    SearchSimilar(ctx context.Context, vector []float32, limit int, filter map[string]any) ([]VectorResult, error)
    
    // 混合检索 (向量 + 关键词)
    HybridSearch(ctx context.Context, query string, limit int) ([]SearchResult, error)
}

// 4. 时间解析服务接口
type TimeService interface {
    // 标准化时间表达
    Normalize(ctx context.Context, input string, timezone string) (time.Time, error)
    
    // 解析自然语言时间
    ParseNaturalTime(ctx context.Context, input string, reference time.Time) (TimeRange, error)
}

// 5. 缓存服务接口
type CacheService interface {
    Get(ctx context.Context, key string) ([]byte, bool)
    Set(ctx context.Context, key string, value []byte, ttl time.Duration) error
    Invalidate(ctx context.Context, pattern string) error
}

// 6. 评估指标服务接口
type MetricsService interface {
    RecordRequest(ctx context.Context, agentType string, latency time.Duration, success bool)
    RecordToolCall(ctx context.Context, toolName string, latency time.Duration, success bool)
    GetStats(ctx context.Context, timeRange TimeRange) (*AgentMetrics, error)
}

// 7. 会话持久化服务接口
type SessionService interface {
    SaveContext(ctx context.Context, sessionID string, context *ConversationContext) error
    LoadContext(ctx context.Context, sessionID string) (*ConversationContext, error)
    ListSessions(ctx context.Context, userID int32, limit int) ([]SessionSummary, error)
}
```

### 3.2 数据模型统一定义

```go
// ==================== 公共数据模型 ====================

// 情景记忆
type EpisodicMemory struct {
    ID         int64     `json:"id"`
    UserID     int32     `json:"user_id"`
    Timestamp  time.Time `json:"timestamp"`
    AgentType  string    `json:"agent_type"`   // memo/schedule/amazing/assistant
    UserInput  string    `json:"user_input"`
    Outcome    string    `json:"outcome"`      // success/failure
    Summary    string    `json:"summary"`
    Importance float32   `json:"importance"`   // 0-1
}

// 用户偏好
type UserPreferences struct {
    Timezone           string            `json:"timezone"`
    DefaultDuration    int               `json:"default_duration"`     // 分钟
    PreferredTimes     []string          `json:"preferred_times"`      // ["09:00", "14:00"]
    FrequentLocations  []string          `json:"frequent_locations"`
    CommunicationStyle string            `json:"communication_style"`  // concise/detailed
    TagPreferences     []string          `json:"tag_preferences"`      // 常用标签
    CustomSettings     map[string]any    `json:"custom_settings"`
}

// 意图类型
type Intent string

const (
    IntentMemoSearch     Intent = "memo_search"
    IntentMemoCreate     Intent = "memo_create"
    IntentScheduleQuery  Intent = "schedule_query"
    IntentScheduleCreate Intent = "schedule_create"
    IntentScheduleUpdate Intent = "schedule_update"
    IntentBatchSchedule  Intent = "batch_schedule"
    IntentAmazing        Intent = "amazing"
    IntentUnknown        Intent = "unknown"
)

// 任务类型 (用于模型选择)
type TaskType string

const (
    TaskIntentClassification TaskType = "intent_classification"
    TaskEntityExtraction     TaskType = "entity_extraction"
    TaskSimpleQA             TaskType = "simple_qa"
    TaskComplexReasoning     TaskType = "complex_reasoning"
    TaskSummarization        TaskType = "summarization"
    TaskTagSuggestion        TaskType = "tag_suggestion"
)
```

### 3.3 Sprint 0 交付物

| 交付物 | 负责团队 | 依赖方 |
|:---|:---|:---|
| 公共接口 Go 定义 | A | B, C |
| Proto/gRPC 定义 (可选) | A | B, C |
| Mock 实现 | A | B, C |
| 契约测试用例 | A, B, C | - |
| 数据库 Schema | A | B, C |

---

## 四、Phase 1: 基础稳定 (Sprint 1-2)

**目标**: 解决核心痛点，建立可靠基础

### 4.1 团队 A: 公共基础服务

| 任务 | Sprint | 优先级 | 投入 | 产出 |
|:---|:---:|:---:|---:|:---|
| **轻量记忆系统** | 1 | P0 | 3人天 | 跨会话记忆能力 |
| **基础评估指标** | 1 | P0 | 2人天 | 问题可定位 |
| **LLM 路由优化** | 1-2 | P0 | 3人天 | LLM 调用减少 60% |
| **时间解析服务** | 2 | P0 | 2人天 | 时间解析成功率 >98% |
| **通用缓存层** | 2 | P1 | 1人天 | 重复查询 <10ms |

#### 4.1.1 记忆系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    统一记忆系统架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                   短期记忆 (会话内)                         │ │
│  │  • 滑动窗口上下文 (最近 10 轮)                              │ │
│  │  • 实现: 内存 + Redis (可选)                               │ │
│  │  • 调用方: 助理对话 / 日程对话 / 笔记搜索                   │ │
│  └───────────────────────────────────────────────────────────┘ │
│                            │                                    │
│                            ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                   长期记忆 (跨会话)                         │ │
│  │                                                            │ │
│  │  ┌─────────────────────┐  ┌─────────────────────────────┐ │ │
│  │  │  情景记忆 (Episodic) │  │  用户偏好 (Preferences)     │ │ │
│  │  │                     │  │                             │ │ │
│  │  │  调用方:            │  │  调用方:                     │ │ │
│  │  │  • 助理: 历史模式   │  │  • 日程: 默认时长/时区       │ │ │
│  │  │  • 日程: 常见日程   │  │  • 笔记: 常用标签            │ │ │
│  │  │  • 笔记: 搜索模式   │  │  • 助理: 沟通风格            │ │ │
│  │  │                     │  │                             │ │ │
│  │  │  存储: PostgreSQL   │  │  存储: JSONB                 │ │ │
│  │  └─────────────────────┘  └─────────────────────────────┘ │ │
│  │                                                            │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 4.1.2 LLM 路由架构 (统一)

```
┌─────────────────────────────────────────────────────────────────┐
│                    统一 LLM 路由架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户输入 (来自助理/日程/笔记)                                   │
│      │                                                          │
│      ▼                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 1: 精确匹配 (0ms)                                 │   │
│  │  • 日程关键词: 明天/后天/开会/会议/安排...               │   │
│  │  • 笔记关键词: 搜索/查找/记录/写下...                    │   │
│  │  • 正则模式: 时间表达式、标签格式                        │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │ 未匹配                              │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 2: 历史模式匹配 (~10ms)                           │   │
│  │  • 相似历史查询 → 复用路由决策                            │   │
│  │  • 基于情景记忆的快速匹配                                 │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │ 未匹配                              │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Layer 3: LLM 分类 (~400ms)                              │   │
│  │  • 仅对真正模糊的输入使用                                 │   │
│  │  • 结果写入历史模式库                                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  目标: 80% 请求在 Layer 1/2 完成                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

### 4.2 团队 B: 智能助理 + 日程管理

| 任务 | Sprint | 优先级 | 投入 | 产出 | 依赖 A |
|:---|:---:|:---:|---:|:---|:---|
| **工具可靠性增强** | 1 | P0 | 2人天 | 重试+降级 | - |
| **错误恢复机制** | 1 | P0 | 1人天 | 自动恢复 | - |
| **时间解析加固** | 1-2 | P0 | 2人天 | 成功率 +13% | TimeService |
| **规则分类器扩展** | 2 | P0 | 2人天 | LLM 调用 -70% | RouterService |

#### 4.2.1 工具执行增强

```go
// plugin/ai/agent/tools/resilient_executor.go

// ResilientToolExecutor 统一工具执行器 (助理+日程共用)
type ResilientToolExecutor struct {
    maxRetries     int           // 最大重试: 2
    retryDelay     time.Duration // 重试间隔: 500ms
    timeout        time.Duration // 单次超时: 10s
    metricsService MetricsService  // 依赖 A 团队
    fallbackRules  map[string]FallbackFunc
}

// Execute 带重试和降级的执行
func (e *ResilientToolExecutor) Execute(ctx context.Context, tool Tool, input string) (*Result, error) {
    start := time.Now()
    
    for attempt := 0; attempt <= e.maxRetries; attempt++ {
        result, err := e.executeWithTimeout(ctx, tool, input)
        
        if err == nil {
            e.metricsService.RecordToolCall(ctx, tool.Name(), time.Since(start), true)
            return result, nil
        }
        
        if !isRetryable(err) {
            break
        }
        
        time.Sleep(e.retryDelay)
    }
    
    // 降级处理
    e.metricsService.RecordToolCall(ctx, tool.Name(), time.Since(start), false)
    return e.fallback(ctx, tool, input)
}

// 降级策略表 (可配置)
var DefaultFallbackRules = map[string]FallbackFunc{
    "memo_search":    func(...) { return "搜索暂时不可用，请稍后重试" },
    "schedule_query": func(...) { return useCachedDataIfAvailable() },
    "schedule_add":   func(...) { return "日程已记录，待确认后生效" },
}
```

---

### 4.3 团队 C: 笔记 AI 增强

| 任务 | Sprint | 优先级 | 投入 | 产出 | 依赖 A |
|:---|:---:|:---:|---:|:---|:---|
| **搜索结果高亮** | 1 | P0 | 5人天 | 定位效率 +53% | VectorService |
| **上下文智能摘录** | 1-2 | P1 | 3人天 | 搜索体验提升 | VectorService |
| **相关笔记推荐** | 2 | P1 | 6人天 | 关联发现 +300% | VectorService |

#### 4.3.1 高亮搜索架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          搜索高亮架构 (依赖 A 团队向量服务)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  前端                         后端                          A 团队服务       │
│  ────                         ────                          ────────────    │
│                                                                             │
│  SearchInput                  ┌─────────────────┐                           │
│      │                        │ HighlightService│                           │
│      │ query                  │                 │                           │
│      ▼                        └────────┬────────┘                           │
│  ┌──────────────┐                     │                                    │
│  │SearchService│◄────────────────────┤                                    │
│  │  (RPC)      │   SearchWithHighlight                                     │
│  └──────┬───────┘                     │                                    │
│         │                             ▼                                    │
│         │                    ┌─────────────────┐      ┌─────────────────┐  │
│         │                    │ highlight.go    │──────▶│ A: VectorService│  │
│         │                    │ ├─ tokenize()   │      │ HybridSearch()  │  │
│         │                    │ ├─ match()      │      └─────────────────┘  │
│         │                    │ └─ extract()    │                           │
│         ▼                    └─────────────────┘                           │
│  ┌──────────────┐                                                          │
│  │HighlightedResult.tsx                                                    │
│  │ └─ <mark> 渲染                                                          │
│  └──────────────┘                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 4.4 Phase 1 里程碑与集成点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Phase 1 集成里程碑                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Sprint 1 结束                           Sprint 2 结束                       │
│  ═══════════════                         ═══════════════                    │
│                                                                             │
│  M1.1: 基础服务就绪                      M1.2: 稳定版交付                    │
│  ┌─────────────────────┐                 ┌─────────────────────┐            │
│  │ A: 记忆服务 + 指标  │                 │ A: 路由 + 时间 + 缓存│            │
│  │ B: 工具重试机制     │                 │ B: 规则分类器扩展    │            │
│  │ C: 搜索高亮原型     │                 │ C: 相关推荐上线      │            │
│  └─────────────────────┘                 └─────────────────────┘            │
│                                                                             │
│  集成验收点:                              集成验收点:                         │
│  • A→B: MemoryService 调用通过           • A→B: RouterService 调用通过       │
│  • A→C: 无依赖                           • A→C: VectorService 调用通过       │
│                                          • 端到端测试: 助理+日程+笔记         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、Phase 2: 智能进化 (Sprint 3-4)

**目标**: 提升智能程度，"越用越懂你"

### 5.1 团队 A: 智能增强服务

| 任务 | Sprint | 优先级 | 投入 | 产出 |
|:---|:---:|:---:|---:|:---|
| **Self-RAG 检索优化** | 3 | P1 | 3人天 | 无效检索减少 40% |
| **上下文增强构建器** | 3-4 | P1 | 3人天 | 对话连贯性提升 |
| **会话持久化服务** | 4 | P1 | 3人天 | 服务重启后会话恢复 |

#### 5.1.1 Self-RAG 架构 (轻量版)

```
┌─────────────────────────────────────────────────────────────────┐
│                    轻量 Self-RAG (规则驱动)                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Query ──► [需要检索?] ──Yes──► Retrieve ──► [结果有用?]        │
│                │                                  │             │
│               No                                 Yes            │
│                │                                  │             │
│                ▼                                  ▼             │
│         Direct Answer                      Grounded Answer      │
│                                                   │             │
│                                                  No             │
│                                                   │             │
│                                                   ▼             │
│                                              Retry/Expand       │
│                                                                 │
│  调用方: 助理(搜索) / 笔记(推荐) / 日程(查询)                     │
│                                                                 │
│  决策规则 (非 LLM):                                              │
│  - 需要检索? → 关键词/模式规则判断                               │
│  - 结果有用? → 相关性分数阈值判断 (>0.6)                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

### 5.2 团队 B: 习惯学习 + 日程效率

| 任务 | Sprint | 优先级 | 投入 | 产出 | 依赖 A |
|:---|:---:|:---:|---:|:---|:---|
| **用户习惯学习系统** | 3 | P1 | 5人天 | "懂你"体验 | MemoryService |
| **快速创建模式** | 3 | P1 | 4人天 | 简单创建 <500ms | TimeService |
| **后端预检 API** | 4 | P2 | 2人天 | 即时冲突反馈 | CacheService |
| **Generative UI 增强** | 4 | P2 | 4人天 | 交互体验提升 | - |

#### 5.2.1 习惯学习系统 (基于 A 团队记忆服务)

```go
// plugin/ai/agent/habit_learner.go

// HabitLearner 习惯学习器 (依赖 A 团队记忆服务)
type HabitLearner struct {
    memoryService   MemoryService   // A 团队提供
    analyzer        *PatternAnalyzer
    predictor       *HabitPredictor
}

// DailyAnalysis 每日后台任务
func (h *HabitLearner) DailyAnalysis(ctx context.Context, userID int32) error {
    // 1. 从记忆服务获取最近 30 天的成功交互
    episodes, err := h.memoryService.SearchEpisodes(ctx, "", 1000)
    if err != nil {
        return err
    }
    
    // 2. 提取模式 (本地计算，不调用 LLM)
    patterns := h.analyzer.ExtractPatterns(episodes)
    
    // 3. 更新用户偏好 (通过 A 团队接口)
    prefs, _ := h.memoryService.GetPreferences(ctx, userID)
    h.updatePreferences(prefs, patterns)
    return h.memoryService.UpdatePreferences(ctx, userID, prefs)
}

// 可学习的习惯类型
type LearnableHabits struct {
    // 时间习惯
    ActiveHours      []int     // 活跃时段
    PreferredSlots   []string  // 偏好时间段 ["09:00", "14:00"]
    ReminderLeadTime int       // 提醒提前量 (分钟)
    
    // 日程习惯
    DefaultDuration  int       // 默认会议时长
    FrequentTitles   []string  // 常用日程标题
    CommonLocations  []string  // 常用地点
    
    // 搜索习惯
    FrequentKeywords []string  // 常用搜索关键词
    TagPreferences   []string  // 常用标签
}
```

---

### 5.3 团队 C: 智能整理

| 任务 | Sprint | 优先级 | 投入 | 产出 | 依赖 A |
|:---|:---:|:---:|---:|:---|:---|
| **智能标签建议** | 3 | P1 | 7人天 | 标签采纳率 +350% | RouterService |
| **重复检测系统** | 4 | P2 | 9人天 | 重复识别率 80% | VectorService |

#### 5.3.1 智能标签三层策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         智能标签三层策略 (依赖 A 团队)                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入: 笔记内容                                                              │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │ L1: 统计优先 (0ms) - 依赖 A: MemoryService.GetPreferences()    │           │
│  │ ────────────────────────                                      │           │
│  │ • 用户历史高频标签 TOP-5                                        │           │
│  │ • 最近 7 天使用的标签                                          │           │
│  └──────────────────────────────────────────────────────────────┘           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │ L2: 规则提取 (10ms) - 本地执行                                 │           │
│  │ ───────────────────────                                       │           │
│  │ • 专有名词识别 (技术词典)                                       │           │
│  │ • 日期时间模式                                                 │           │
│  └──────────────────────────────────────────────────────────────┘           │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────┐           │
│  │ L3: LLM 语义 (300ms) - 依赖 A: RouterService.SelectModel()     │           │
│  │ ──────────────────────                                        │           │
│  │ • 主题分类                                                     │           │
│  │ • 新标签发现                                                   │           │
│  │ • 降级: 网络异常时跳过                                         │           │
│  └──────────────────────────────────────────────────────────────┘           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 5.4 Phase 2 里程碑与集成点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Phase 2 集成里程碑                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Sprint 3 结束                           Sprint 4 结束                       │
│  ═══════════════                         ═══════════════                    │
│                                                                             │
│  M2.1: 智能基础就绪                      M2.2: 智能版交付                    │
│  ┌─────────────────────┐                 ┌─────────────────────┐            │
│  │ A: Self-RAG + 上下文│                 │ A: 会话持久化        │            │
│  │ B: 习惯学习 + 快速创│                 │ B: 预检API + GenUI   │            │
│  │ C: 智能标签 L1/L2   │                 │ C: 重复检测          │            │
│  └─────────────────────┘                 └─────────────────────┘            │
│                                                                             │
│  集成验收点:                              集成验收点:                         │
│  • A→B: 习惯数据写入记忆服务              • A→B: 会话恢复测试                 │
│  • A→C: 向量检索用于重复检测              • 端到端: "越用越懂你" 体验验收      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、Phase 3: 极致体验 (Sprint 5-6)

**目标**: 差异化竞争力，真正的"私人助理"

### 6.1 团队 A: 本地模型支持

| 任务 | Sprint | 优先级 | 投入 | 产出 |
|:---|:---:|:---:|---:|:---|
| **本地模型集成** | 5 | P2 | 5人天 | API 成本降低 60-80% |
| **模型路由器** | 5-6 | P2 | 3人天 | 智能模型选择 |

#### 6.1.1 混合模型架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    混合模型架构 (A 团队提供)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        请求分流器 (ModelRouter)                       │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
│                                   │                                         │
│            ┌──────────────────────┼──────────────────────┐                 │
│            ▼                      ▼                      ▼                 │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────────┐ │
│   │  本地小模型      │   │  本地中模型      │   │      云端大模型         │ │
│   │  (Qwen2.5-1.5B) │   │  (Qwen2.5-7B)   │   │  (GPT-4/Claude)        │ │
│   │                 │   │                 │   │                         │ │
│   │  适用任务:       │   │  适用任务:       │   │  适用任务:               │ │
│   │  • 意图分类     │   │  • 简单问答     │   │  • 复杂推理              │ │
│   │  • 实体提取     │   │  • 日程创建     │   │  • 长文总结              │ │
│   │  • 标签建议 L3  │   │  • 笔记搜索     │   │  • 创意生成              │ │
│   │                 │   │                 │   │                         │ │
│   │  延迟: <100ms   │   │  延迟: <500ms   │   │  延迟: 1-3s              │ │
│   │  成本: $0       │   │  成本: $0       │   │  成本: ~$0.01/请求       │ │
│   │  调用方: 全部   │   │  调用方: 全部   │   │  调用方: 全部            │ │
│   └─────────────────┘   └─────────────────┘   └─────────────────────────┘ │
│                                                                             │
│   资源需求: 小模型 ~2GB RAM | 中模型 ~8GB RAM (可选)                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 6.2 团队 B: 预测性交互 + 提醒

| 任务 | Sprint | 优先级 | 投入 | 产出 | 依赖 A |
|:---|:---:|:---:|---:|:---|:---|
| **预测性交互系统** | 5 | P2 | 5人天 | 主动服务体验 | MemoryService |
| **主动提醒系统** | 5-6 | P2 | 4人天 | 助理感增强 | TimeService |
| **批量日程支持** | 6 | P2 | 6人天 | 重复日程功能 | TimeService |

#### 6.2.1 预测性交互系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    预测性交互系统 (基于 A 团队记忆服务)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   预测引擎 (PredictionEngine)                         │   │
│  │                                                                       │   │
│  │  输入: 当前时间 + 用户上下文 + 历史模式 (from MemoryService)           │   │
│  │  输出: 预测用户可能需要什么                                            │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  预测场景:                                                                   │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   时间触发       │  │   内容触发       │  │   模式触发      │             │
│  │                 │  │                 │  │                 │             │
│  │ • 早上9点       │  │ • 编辑笔记时    │  │ • 每周一9点     │             │
│  │   → 今日日程    │  │   → 相关笔记    │  │   → 周报提醒    │             │
│  │                 │  │                 │  │                 │             │
│  │ • 会议前15分钟  │  │ • 搜索后       │  │ • 月底          │             │
│  │   → 会议提醒    │  │   → 快捷操作    │  │   → 月度回顾    │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                             │
│  交互方式: 轻量提示卡片 (非弹窗) | "您可能需要..." | 一键执行/忽略           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 6.3 团队 C: 知识沉淀

| 任务 | Sprint | 优先级 | 投入 | 产出 | 依赖 A |
|:---|:---:|:---:|---:|:---|:---|
| **知识图谱可视化** | 5-6 | P2 | 13人天 | 知识关联可视化 | VectorService |
| **智能回顾系统** | 6 | P3 | 8人天 | 间隔重复学习 | MemoryService |

---

### 6.4 Phase 3 里程碑

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Phase 3 集成里程碑                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Sprint 5 结束                           Sprint 6 结束                       │
│  ═══════════════                         ═══════════════                    │
│                                                                             │
│  M3.1: 本地模型就绪                      M3.2: 完整版交付                    │
│  ┌─────────────────────┐                 ┌─────────────────────┐            │
│  │ A: 本地模型 + 路由  │                 │ A: 模型路由优化      │            │
│  │ B: 预测交互原型     │                 │ B: 提醒 + 批量日程   │            │
│  │ C: 知识图谱原型     │                 │ C: 智能回顾          │            │
│  └─────────────────────┘                 └─────────────────────┘            │
│                                                                             │
│  最终验收:                                                                   │
│  • API 成本降低 60%+                                                         │
│  • 端到端: "真正的私人助理" 体验验收                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、资源投入与 ROI 汇总

### 7.1 各团队投入统计

| 团队 | Phase 0 | Phase 1 | Phase 2 | Phase 3 | 合计 |
|:---|---:|---:|---:|---:|---:|
| **A: 公共服务** | 5人天 | 11人天 | 9人天 | 8人天 | **33人天** |
| **B: 助理+日程** | 2人天 | 7人天 | 15人天 | 15人天 | **39人天** |
| **C: 笔记增强** | 2人天 | 14人天 | 16人天 | 21人天 | **53人天** |
| **合计** | 9人天 | 32人天 | 40人天 | 44人天 | **125人天** |

### 7.2 ROI 汇总

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ROI 汇总表                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  阶段       投入        核心产出                           ROI              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  Sprint 0   9人天       接口契约、消除阻塞                  ★★★★★           │
│                                                                             │
│  Phase 1    32人天      LLM调用-60%、搜索效率+53%          ★★★★★           │
│             ¥64,000     时间解析成功率>98%                                   │
│                                                                             │
│  Phase 2    40人天      "懂你"体验、标签采纳+350%          ★★★★☆           │
│             ¥80,000     简单日程创建<500ms                                   │
│                                                                             │
│  Phase 3    44人天      API成本-60%、知识图谱可视化        ★★★☆☆           │
│             ¥88,000     主动预测、提醒系统                                   │
│                                                                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│  总计       125人天     完整私人AI助理平台                                   │
│             ¥250,000                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 关键成本节省 (私有化部署)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       API 成本节省预估                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  假设: 每日 50 次 AI 交互                                                    │
│                                                                             │
│  当前成本:                                                                   │
│  ├── 路由分类: 50 × $0.001 = $0.05/天                                       │
│  ├── Agent 执行: 50 × $0.02 = $1.00/天                                      │
│  └── 总计: ~$1.05/天 = ~$31.5/月                                            │
│                                                                             │
│  Phase 1 后 (路由优化):                                                     │
│  ├── 路由分类: 20 × $0.001 = $0.02/天 (↓60%)                                │
│  └── 总计: ~$1.02/天 = ~$30.6/月                                            │
│                                                                             │
│  Phase 3 后 (本地模型):                                                     │
│  ├── 路由分类: $0 (本地)                                                    │
│  ├── 简单任务: $0 (本地)                                                    │
│  ├── 复杂任务: 10 × $0.02 = $0.20/天                                        │
│  └── 总计: ~$0.20/天 = ~$6/月 (↓81%)                                        │
│                                                                             │
│  年度节省: ~$300/用户                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、风险管理

### 8.1 跨团队协作风险

| 风险 | 概率 | 影响 | 缓解措施 |
|:---|:---:|:---:|:---|
| 接口变更导致返工 | 中 | 高 | Sprint 0 充分评审 + 版本化接口 |
| A 团队延期阻塞 B/C | 中 | 高 | A 团队优先交付 Mock + 契约测试 |
| 集成测试发现问题 | 高 | 中 | 每 Sprint 结束进行集成验收 |
| 技术债务累积 | 中 | 中 | 每 Phase 预留 10% 时间偿还 |

### 8.2 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|:---|:---:|:---:|:---|
| 本地模型质量不足 | 中 | 高 | 混合策略，复杂任务仍用云端 |
| 向量检索性能瓶颈 | 低 | 高 | pgvector HNSW 索引 + 分页 |
| 记忆系统数据膨胀 | 中 | 中 | 定期清理 + 重要性评分 |
| LLM 分类误判 | 中 | 中 | 规则兜底 + 置信度阈值 |

### 8.3 回滚策略

```go
// 所有新特性均支持开关控制
type FeatureFlags struct {
    // Phase 1
    EpisodicMemory    bool  // A 团队
    EnhancedRouting   bool  // A 团队
    SearchHighlight   bool  // C 团队
    ResilientTools    bool  // B 团队
    
    // Phase 2
    HabitLearning     bool  // B 团队
    SelfRAG           bool  // A 团队
    SmartTags         bool  // C 团队
    FastCreate        bool  // B 团队
    
    // Phase 3
    LocalModel        bool  // A 团队
    PredictiveUI      bool  // B 团队
    KnowledgeGraph    bool  // C 团队
}
```

---

## 九、附录

### A. 团队沟通机制

| 会议 | 频率 | 参与者 | 目的 |
|:---|:---|:---|:---|
| 每日站会 | 每日 | 各团队内部 | 进度同步、阻塞识别 |
| 跨团队同步 | 每周 2 次 | A+B+C | 接口对接、依赖协调 |
| Sprint 评审 | 每 Sprint | 全员 | 集成验收、问题复盘 |
| Phase 回顾 | 每 Phase | 全员 | 架构评审、方向调整 |

### B. 接口版本管理

```
服务接口版本规范:
- 主版本号: 不兼容变更 (v1 → v2)
- 次版本号: 向后兼容的功能新增 (v1.1 → v1.2)
- 修订号: 向后兼容的问题修复 (v1.1.1 → v1.1.2)

示例:
- MemoryService v1.0.0 → v1.1.0 (新增 SearchEpisodes)
- VectorService v1.0.0 → v2.0.0 (返回结构变更)
```

### C. 里程碑检查清单

**Phase 1 交付检查清单**:
- [ ] A: 记忆服务 API 可用 + 单元测试通过
- [ ] A: 路由服务 API 可用 + 覆盖率 >70%
- [ ] A: 时间解析服务 API 可用
- [ ] B: 工具重试机制集成 + 端到端测试
- [ ] B: 规则分类器扩展 + 准确率测试
- [ ] C: 搜索高亮上线 + 用户验收
- [ ] C: 相关推荐上线 + 用户验收
- [ ] 集成: 三模块联调通过
- [ ] 文档: API 文档更新

---

> **文档维护**: 本路线图将随产品迭代持续更新  
> **版本**: v1.0 | **更新时间**: 2026-01-27
