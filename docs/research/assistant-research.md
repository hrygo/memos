# Memos 智能助理功能深度调研报告

> 本文档全面解析 Memos 项目中 AI 智能助理的架构设计、工作原理和实现细节。

**文档导航**: [主路线图](./00-master-roadmap.md) | [实施路线图](./assistant-roadmap.md) | [行业参考](./assistant-roadmap-industry.md)

---

## 目录

1. [系统架构总览](#1-系统架构总览)
2. [智能路由机制](#2-智能路由机制-chatrouter)
3. [四大 Agent 详解](#3-四大-agent-详解)
4. [混合 RAG 检索引擎](#4-混合-rag-检索引擎)
5. [Agent 提示词工程](#5-agent-提示词工程详解)
6. [前端 AI Native UX](#6-前端-ai-native-ux)
7. [改进建议](#7-改进建议)

---

## 1. 系统架构总览

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Frontend (React)                               │
│  ┌─────────────┐  ┌──────────────────┐  ┌─────────────────────────────┐ │
│  │ AIChatSidebar│  │ StreamingFeedback │  │ GenerativeUIContainer      │ │
│  └──────┬──────┘  └────────┬─────────┘  └──────────────┬──────────────┘ │
│         │                  │                           │                 │
│         └──────────────────┴───────────────────────────┘                 │
│                            │ gRPC Stream                                 │
└────────────────────────────┼─────────────────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        Backend (Go)                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                      AIService (Chat API)                           ││
│  │  ┌──────────────────┐  ┌─────────────────┐  ┌────────────────────┐  ││
│  │  │ EventBus         │  │ ContextBuilder  │  │ ConversationSvc    │  ││
│  │  └────────┬─────────┘  └────────┬────────┘  └─────────┬──────────┘  ││
│  └───────────┼─────────────────────┼─────────────────────┼─────────────┘│
│              │                     │                     │               │
│  ┌───────────▼─────────────────────▼─────────────────────▼─────────────┐│
│  │                         ChatRouter                                   ││
│  │    ┌─────────────────────────────────────────────────────────────┐  ││
│  │    │  Rule-based Matching (0ms) → LLM Classification (~400ms)    │  ││
│  │    └──────────────────────────┬──────────────────────────────────┘  ││
│  └───────────────────────────────┼─────────────────────────────────────┘│
│                                  │                                       │
│              ┌───────────────────┼───────────────────┐                   │
│              ▼                   ▼                   ▼                   │
│  ┌───────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐  │
│  │ 🦜 灰灰 (Memo)    │ │ 🦜 金刚 (Schedule)│ │ 🦜 惊奇 (Amazing)      │  │
│  │ MemoParrot        │ │ ScheduleParrotV2│ │ AmazingParrot          │  │
│  │ ReAct Loop        │ │ Native Tool Call│ │ Two-Phase Concurrent   │  │
│  └─────────┬─────────┘ └────────┬────────┘ └───────────┬─────────────┘  │
│            │                    │                      │                 │
│  ┌─────────▼────────────────────▼──────────────────────▼───────────────┐│
│  │                        Tool Layer                                   ││
│  │  ┌────────────┐  ┌──────────────┐  ┌────────────┐  ┌─────────────┐  ││
│  │  │memo_search │  │schedule_query│  │schedule_add│  │find_free_time│ ││
│  │  └─────┬──────┘  └──────┬───────┘  └─────┬──────┘  └──────┬──────┘  ││
│  └────────┼────────────────┼────────────────┼────────────────┼─────────┘│
│           │                │                │                │           │
│  ┌────────▼────────────────▼────────────────▼────────────────▼─────────┐│
│  │                    Data Layer                                       ││
│  │  ┌─────────────────────────────┐  ┌──────────────────────────────┐  ││
│  │  │ AdaptiveRetriever (混合RAG) │  │ ScheduleService              │  ││
│  │  │ BM25 + Vector + Reranker    │  │ CRUD + ConflictResolver      │  ││
│  │  └─────────────────────────────┘  └──────────────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────┘│
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐│
│  │                    Storage Layer                                    ││
│  │  ┌──────────────────┐  ┌─────────────────┐  ┌────────────────────┐  ││
│  │  │ PostgreSQL       │  │ pgvector        │  │ Full-Text Search   │  ││
│  │  │ (Memos/Schedules)│  │ (Embeddings)    │  │ (BM25)             │  ││
│  │  └──────────────────┘  └─────────────────┘  └────────────────────┘  ││
│  └─────────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心组件

| 组件 | 路径 | 职责 |
|------|------|------|
| **AIService** | `server/router/api/v1/ai_service_chat.go` | gRPC 入口，会话管理 |
| **ChatRouter** | `plugin/ai/agent/chat_router.go` | 意图识别与路由 |
| **MemoParrot** | `plugin/ai/agent/memo_parrot.go` | 笔记检索 Agent |
| **ScheduleParrotV2** | `plugin/ai/agent/schedule_parrot_v2.go` | 日程管理 Agent |
| **AmazingParrot** | `plugin/ai/agent/amazing_parrot.go` | 综合助手 Agent |
| **AdaptiveRetriever** | `server/retrieval/adaptive_retrieval.go` | 混合 RAG 引擎 |

---

## 2. 智能路由机制 (ChatRouter)

### 2.1 双层路由策略

ChatRouter 采用 **规则优先 + LLM 兜底** 的混合策略：

```
用户输入 → 规则匹配 (0ms) → 匹配成功? → 路由到 Agent
                ↓ 否
           LLM 分类 (~400ms) → 路由到 Agent
                ↓ 失败
           默认 → AmazingParrot (综合助手)
```

### 2.2 规则匹配逻辑

**源码位置**: `plugin/ai/agent/chat_router.go:105-180`

```go
// 日程关键词 (权重 +2)
scheduleKeywords := []string{
    "日程", "schedule", "安排", "几点", "有空", "空闲",
    "会议", "meeting", "提醒", "remind", "预约", "约",
}

// 时间模式词 (权重 +1)
scheduleTimePatterns := []string{
    "今天", "明天", "后天", "下周", "这周", "周一"..."周日",
    "上午", "下午", "晚上", "早上", "中午",
    "点", "时", "分",
}

// 累计得分 ≥3 → 路由到 Schedule
```

**路由决策表**:

| 输入示例 | 匹配规则 | 路由目标 | 置信度 |
|---------|---------|---------|--------|
| "明天下午3点开会" | 日程关键词 + 时间模式 | Schedule | 0.85 |
| "搜索我的 Python 笔记" | memo/笔记/搜索 | Memo | 0.80 |
| "总结一下本周工作" | 综合/总结/周报 | Amazing | 0.80 |
| "你好" | 无明确匹配 | Amazing (LLM) | 0.50 |

### 2.3 LLM 分类器

当规则无法确定时，使用轻量 LLM 进行语义理解：

**配置**:
```go
Model:       "Qwen/Qwen2.5-7B-Instruct"
MaxTokens:   30  // 严格限制输出
Temperature: 0   // 确定性输出
```

**System Prompt**:
```
聊天路由分类器。判断用户意图路由到哪个助手：

memo: 笔记搜索、查找记录、回忆内容
schedule: 日程管理、时间安排、会议提醒、空闲查询
amazing: 综合分析、无法明确归类、需要笔记+日程

默认: amazing
```

**输出 Schema (JSON Schema Strict Mode)**:
```json
{
  "route": "memo|schedule|amazing",
  "confidence": 0.0-1.0
}
```

---

## 3. 四大 Agent 详解

### 3.1 灰灰 (MemoParrot) - 笔记助手

**角色设定**: 非洲灰鹦鹉，以卓越记忆力著称

**执行模式**: ReAct Loop (Reasoning + Acting)

```
用户提问 → 思考 → 调用 memo_search → 获取结果 → 生成回答
              ↑_____________________________|
                    (最多 5 次迭代)
```

**工具**:
| 工具名 | 输入格式 | 功能 |
|--------|---------|------|
| `memo_search` | `{"query": "关键词", "limit": 10, "min_score": 0.5}` | 语义搜索笔记 |

**提示词特色** (拟态认知):
```
### 拟声词使用规范（每轮对话 1-2 次）
- 思考开始时可用："嘎...让我想想"
- 搜索时可用："扑棱扑棱，正在搜索"
- 找到结果时可用："嗯嗯~找到了！"
- 无结果时："咕...没有找到相关笔记"
```

### 3.2 金刚 (ScheduleParrotV2) - 日程助手

**角色设定**: 金刚鹦鹉，象征力量与可靠

**执行模式**: Native Tool Calling (原生工具调用)

**核心原则**:
```
1. 先查后建: 创建日程前必须先用 schedule_query 检查冲突
2. 冲突必处理: 发现冲突时必须调用 find_free_time
3. 默认1小时: 用户未指定时长时，默认为1小时
4. 时间推断: 若时间在当前之前，默认视为明天
```

**工具集**:
| 工具名 | 功能 | 典型工作流 |
|--------|------|-----------|
| `schedule_query` | 查询日程 | 必须首先调用 |
| `schedule_add` | 创建日程 | 查无冲突后调用 |
| `schedule_update` | 修改日程 | 根据 ID 更新 |
| `find_free_time` | 查找空闲 | 冲突时调用 |

**工作流示例**:

```
用户: "明天3点开会"
  ↓
1. schedule_query (检查明天3-4点) → 无冲突
  ↓
2. schedule_add (创建会议) → ✓ 已创建
  ↓
回复: "✓ 已创建: 会议 (2026-01-28 15:00 - 16:00)"
```

```
用户: "明天3点开会" (存在冲突)
  ↓
1. schedule_query → 发现冲突: 项目评审 15:00-16:00
  ↓
2. find_free_time → 建议: 16:00-17:00, 17:00-18:00
  ↓
3. schedule_add (使用自动调整时间)
  ↓
回复: "✓ 已创建: 会议 (2026-01-28 16:00 - 17:00) [时间冲突已自动调整]"
```

### 3.3 惊奇 (AmazingParrot) - 综合助手

**角色设定**: 亚马逊鹦鹉，擅长多维飞行和综合分析

**执行模式**: Two-Phase Concurrent Retrieval (两阶段并发检索)

```
Phase 1: 意图分析 → 生成并发检索计划
         ↓
Phase 2: 并发执行工具 → 综合回答
```

**检索计划格式**:
```
memo_search: Python 学习
schedule_query: today
find_free_time: 2026-01-28
```

**并发执行优势**:
- 笔记搜索和日程查询并行执行
- 总延迟 = max(单工具延迟)，而非累加

### 3.4 灵灵 (CreativeParrot) - 创意助手 [规划中]

> 第四个 Agent，专注创意生成，目前尚未实现。

---

## 4. 混合 RAG 检索引擎

### 4.1 AdaptiveRetriever 架构

**源码位置**: `server/retrieval/adaptive_retrieval.go`

```
              ┌─────────────────────────────────┐
              │      AdaptiveRetriever          │
              │                                 │
 Query ────►  │  ┌──────────┐  ┌──────────────┐ │
              │  │ BM25     │  │ Vector Search│ │
              │  │ (关键词) │  │ (语义向量)    │ │
              │  └────┬─────┘  └──────┬───────┘ │
              │       │               │         │
              │       └───────┬───────┘         │
              │               ▼                 │
              │       ┌──────────────┐          │
              │       │ RRF Fusion   │          │
              │       │ (倒数排名融合)│          │
              │       └──────┬───────┘          │
              │              ▼                  │
              │       ┌──────────────┐          │
              │       │ Reranker     │          │
              │       │ (bge-reranker)│         │
              │       └──────────────┘          │
              └─────────────────────────────────┘
```

### 4.2 检索策略

| 策略 | 使用场景 | 实现 |
|------|---------|------|
| `schedule_bm25_only` | 纯日程查询 | BM25 + 时间过滤 |
| `memo_semantic_only` | 纯笔记搜索 | 向量检索 |
| `hybrid_standard` | 默认混合 | BM25(0.5) + Vector(0.5) + RRF |
| `hybrid_bm25_weighted` | 关键词倾向 | BM25(0.7) + Vector(0.3) |
| `full_pipeline_with_reranker` | 高精度场景 | 混合 + Reranker 重排 |

### 4.3 RRF 融合算法

**Reciprocal Rank Fusion (倒数排名融合)**:

```
RRF(d) = Σ weight_i / (k + rank_i(d))
```

- `k = 60` (阻尼因子)
- `weight_i` 根据策略调整 (semantic vs BM25)

**示例**:
```
文档 A: Vector 排名 1, BM25 排名 3
  RRF = 0.5/(60+1) + 0.5/(60+3) = 0.00819 + 0.00794 = 0.01613

文档 B: Vector 排名 5, BM25 排名 1
  RRF = 0.5/(60+5) + 0.5/(60+1) = 0.00769 + 0.00819 = 0.01588

结果: 文档 A > 文档 B
```

### 4.4 Reranker 触发条件

```go
func shouldRerank(query string, results []*SearchResult) bool {
    // 不重排: 结果少于5条
    if len(results) < 5 { return false }
    
    // 不重排: 简单关键词查询
    if isSimpleKeywordQuery(query) { return false }
    
    // 不重排: Top2 分数差距大 (>0.15)
    if results[0].Score - results[1].Score > 0.15 { return false }
    
    return true  // 其他情况重排
}
```

---

## 5. Agent 提示词工程详解

### 5.1 MemoParrot 完整提示词

```
你是 Memos 笔记助手 🦜 灰灰（非洲灰鹦鹉）。时间: 2026-01-27 10:30

## 拟态认知（适度使用拟声词和口头禅）
你是灰灰，一只非洲灰鹦鹉，以卓越的记忆力著称。

### 拟声词使用规范（每轮对话 1-2 次，不过度）
- 思考开始时可用："嘎...让我想想"
- 搜索时可用："扑棱扑棱，正在搜索"
- 找到结果时可用："嗯嗯~找到了！"
- 无结果时："咕...没有找到相关笔记"

### 口头禅（自然穿插）
- "让我想想..."
- "笔记里说..."
- "在记忆里找找..."

### 鸟类行为（可在回复中描述）
- 用翅膀翻找笔记
- 在记忆森林中飞翔
- 用喙精准啄取信息

## 工作模式
用户提问 → 立即搜索 → 基于结果回答

## 工具
memo_search: {"query": "关键词", "limit": 10, "min_score": 0.5}

## 规则
1. 先搜索，后回答。不编造。
2. 找到结果: 简洁总结，引用笔记内容
3. 无结果: 明确告知，建议换词
4. 一次搜索足够，避免重复调用

## 格式
TOOL: memo_search
INPUT: {"query": "搜索词"}
```

### 5.2 ScheduleParrotV2 完整提示词

```
你是日程助手 🦜 金刚 (Macaw)。
当前系统时间: 2026-01-27 10:30 (+08:00)

## 核心原则
1. **先查后建**: 创建日程前必须先用 schedule_query 检查该时段是否有冲突
2. **冲突必处理**: 发现冲突时必须调用 find_free_time 查找可用时间
3. **默认1小时**: 用户未指定时长时，默认为1小时
4. **时间推断**: 若时间在当前之前，默认视为明天

## 工具调用最佳实践
根据任务类型选择最优调用链：

### 简单创建 (如"明天3点开会")
1. schedule_query → 检查冲突
2. schedule_add → 创建日程
⚡ 共2步，最高效

### 有冲突时
1. schedule_query → 发现冲突
2. find_free_time → 查找空闲时间
3. schedule_add → 创建日程
⚡ 共3步

### 修改日程 (如"把会议改到4点")
1. schedule_query → 找到目标日程
2. schedule_update → 更新时间

### 查询日程 (如"今天有什么安排")
1. schedule_query → 直接返回结果
⚡ 仅1步

## 响应格式
- 创建成功后，回复格式: "✓ 已创建: [标题] ([时间])"
- 更新成功后，回复格式: "✓ 已更新: [标题] ([新时间])"
- 如有冲突，先说明冲突，再给出建议时间

## 注意事项
- 使用 ISO8601 格式传递时间参数 (如 2026-01-27T15:00:00+08:00)
- 所有日期时间都应基于用户时区 (Asia/Shanghai)
- 尽可能简洁回答，避免冗余说明
```

### 5.3 提示词设计原则

| 原则 | 说明 | 示例 |
|------|------|------|
| **拟态认知** | 赋予 Agent 鲜明个性 | 鹦鹉种类、拟声词、口头禅 |
| **角色边界** | 明确能力范围 | "先搜索后回答，不编造" |
| **工作流约束** | 规范工具调用顺序 | "先查后建" |
| **格式规范** | 统一输出格式 | "✓ 已创建: [标题]" |
| **上下文注入** | 动态注入时间/时区 | "当前时间: 2026-01-27" |

---

## 6. 前端 AI Native UX

### 6.1 Generative UI 组件

**源码位置**: `web/src/components/ScheduleAI/`

| 组件 | 功能 | 触发事件 |
|------|------|---------|
| `GenerativeUIContainer` | UI 工具容器 | 管理所有 UI 工具 |
| `ScheduleSuggestionCard` | 日程确认卡片 | `ui_schedule_suggestion` |
| `TimeSlotPicker` | 时间槽选择器 | `ui_time_slot_picker` |
| `ConflictResolution` | 冲突解决面板 | `ui_conflict_resolution` |
| `StreamingFeedback` | 流式状态反馈 | `thinking/tool_use/answer` |

### 6.2 事件流

```
Backend                          Frontend
   │                                │
   │── thinking: "正在思考..." ────►│ StreamingFeedback 显示思考状态
   │                                │
   │── tool_use: "schedule_query" ─►│ 显示 "正在查询日程..."
   │                                │
   │── tool_result: {...} ─────────►│ 更新状态
   │                                │
   │── ui_schedule_suggestion ─────►│ 渲染 ScheduleSuggestionCard
   │                                │
   │── answer: "✓ 已创建..." ──────►│ 显示最终回答
   │                                │
   │── done: true ─────────────────►│ 结束流式传输
```

### 6.3 StreamingFeedback 状态展示

```tsx
// 紧凑模式: 只显示最新状态
<div className="flex items-center gap-2">
  <Loader2 className="animate-spin" />
  <span>正在查询日程...</span>
</div>

// 展开模式: 显示完整历史
<div className="space-y-2">
  <div>✓ 正在思考...</div>
  <div>✓ 正在查询日程...</div>
  <div>● 创建日程中...</div>
</div>
```

---

## 7. 改进建议

### 7.1 智能程度提升

| 方向 | 当前状态 | 改进建议 | 优先级 |
|------|---------|---------|--------|
| **多轮对话理解** | 基于历史消息拼接 | 引入 ConversationContext 状态管理，支持指代消解 | P0 |
| **意图分类精度** | 规则+7B模型 | 微调专用分类器或升级到更大模型 | P1 |
| **工具选择** | 硬编码工作流 | 引入 Tool Router / Function Calling 动态选择 | P1 |
| **记忆机制** | 无长期记忆 | 添加用户偏好记忆、常用日程模板 | P2 |

### 7.2 稳定性增强

| 问题 | 当前风险 | 改进建议 |
|------|---------|---------|
| **LLM 超时** | 10s 超时可能不足 | 分级超时策略 + 降级方案 |
| **工具调用失败** | 直接返回错误 | 自动重试 + 优雅降级 |
| **缓存一致性** | 5min TTL 固定 | 根据数据变更主动失效 |
| **并发限制** | 全局限流 | 用户级别限流 + 队列 |

### 7.3 准确性优化

| 场景 | 问题 | 解决方案 |
|------|------|---------|
| **时间解析** | "下周三"解析偏差 | 增强 NLU 时间解析器，引入 dateparser |
| **笔记检索** | 语义理解不够 | 查询扩展 + 同义词扩展 |
| **日程冲突** | 边界条件处理 | 完善冲突检测逻辑，支持软冲突 |
| **幻觉控制** | 无笔记时编造 | 强化"无则告知"约束 + 输出验证 |

### 7.4 AI Native UX 提升

| 领域 | 当前实现 | 改进方向 |
|------|---------|---------|
| **统一入口** | AmazingParrot 作为默认 | 完善，用户无需选择 Agent |
| **渐进式披露** | StreamingFeedback 可展开 | 增加更多中间状态可视化 |
| **Generative UI** | 日程卡片、时间选择器 | 扩展到笔记预览、关联推荐 |
| **主动建议** | 无 | 基于上下文主动推荐操作 |
| **错误恢复** | 显示错误信息 | 提供具体修复建议和一键重试 |

### 7.5 架构演进建议

```
当前架构:
  ChatRouter → Agent → Tools → Data

建议演进:
  ┌─────────────────────────────────────────────────┐
  │              Orchestrator Layer                  │
  │  ┌─────────────┐  ┌─────────────────────────┐   │
  │  │ Plan Agent  │  │ Memory Agent            │   │
  │  │ (任务规划)  │  │ (长期记忆)              │   │
  │  └──────┬──────┘  └───────────┬─────────────┘   │
  │         │                     │                  │
  │         ▼                     ▼                  │
  │  ┌──────────────────────────────────────────┐   │
  │  │           Execution Agents               │   │
  │  │  Memo | Schedule | Creative | Analysis   │   │
  │  └──────────────────────────────────────────┘   │
  └─────────────────────────────────────────────────┘
```

**关键改进点**:
1. **Plan Agent**: 复杂任务拆解为子任务
2. **Memory Agent**: 跨会话记忆管理
3. **Tool Router**: 动态工具选择而非硬编码
4. **Feedback Loop**: 结果验证 + 自我修正

---

## 附录

### A. 关键文件索引

| 文件 | 说明 |
|------|------|
| `plugin/ai/agent/chat_router.go` | 智能路由 |
| `plugin/ai/agent/memo_parrot.go` | 笔记 Agent |
| `plugin/ai/agent/schedule_parrot_v2.go` | 日程 Agent |
| `plugin/ai/agent/amazing_parrot.go` | 综合 Agent |
| `plugin/ai/agent/scheduler_v2.go` | 日程 Agent 核心实现 |
| `plugin/ai/agent/intent_classifier.go` | 意图分类器 |
| `plugin/ai/agent/tools/scheduler.go` | 日程工具集 |
| `plugin/ai/agent/tools/memo_search.go` | 笔记搜索工具 |
| `server/retrieval/adaptive_retrieval.go` | 混合 RAG |
| `server/router/api/v1/ai_service_chat.go` | Chat API |

### B. 配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `MaxIterations` | 10 | Agent 最大迭代次数 |
| `AgentTimeout` | 60s | Agent 执行超时 |
| `ToolExecutionTimeout` | 30s | 单工具超时 |
| `CacheTTL` | 5min | 缓存过期时间 |
| `RRFK` | 60 | RRF 阻尼因子 |
| `DefaultSearchLimit` | 10 | 默认搜索数量 |
| `MinScore` | 0.5 | 最低相关性分数 |

---

*文档版本: v1.0 | 更新时间: 2026-01-27*
