# P1-A005: é€šç”¨ç¼“å­˜å±‚

> **çŠ¶æ€**: ğŸ”² å¾…å¼€å‘  
> **ä¼˜å…ˆçº§**: P1 (é‡è¦)  
> **æŠ•å…¥**: 1 äººå¤©  
> **è´Ÿè´£å›¢é˜Ÿ**: å›¢é˜Ÿ A  
> **Sprint**: Sprint 2

---

## 1. ç›®æ ‡ä¸èƒŒæ™¯

### 1.1 æ ¸å¿ƒç›®æ ‡

å®ç°è½»é‡çº§ LRU ç¼“å­˜æœåŠ¡ï¼Œæ”¯æŒé‡å¤æŸ¥è¯¢åŠ é€Ÿï¼Œå“åº”æ—¶é—´ <10msã€‚

### 1.2 ç”¨æˆ·ä»·å€¼

- é‡å¤æŸ¥è¯¢å“åº”æ›´å¿«
- ç³»ç»Ÿæ•´ä½“æ›´æµç•…

### 1.3 æŠ€æœ¯ä»·å€¼

- ç»Ÿä¸€ç¼“å­˜æœåŠ¡ä¾›å›¢é˜Ÿ B/C è°ƒç”¨
- å‡å°‘æ•°æ®åº“å’Œ LLM è°ƒç”¨

---

## 2. ä¾èµ–å…³ç³»

### 2.1 å‰ç½®ä¾èµ–

- [x] S0-interface-contract: æ¥å£å®šä¹‰

### 2.2 å¹¶è¡Œä¾èµ–

- P1-A004: æ—¶é—´æœåŠ¡ï¼ˆå¯å¹¶è¡Œï¼‰

### 2.3 åç»­ä¾èµ–

- P1-C001: æœç´¢é«˜äº®
- P1-C003: ç›¸å…³æ¨è
- P2-B003: é¢„æ£€ API

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è½»é‡ç¼“å­˜æœåŠ¡                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   LRU ç¼“å­˜                               â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ å®¹é‡: 1000 æ¡ç›®ï¼ˆç§äººéƒ¨ç½²è¶³å¤Ÿï¼‰                        â”‚   â”‚
â”‚  â”‚  â€¢ æ·˜æ±°ç­–ç•¥: LRU                                         â”‚   â”‚
â”‚  â”‚  â€¢ TTL: å¯é…ç½®ï¼Œé»˜è®¤ 5 åˆ†é’Ÿ                              â”‚   â”‚
â”‚  â”‚  â€¢ å­˜å‚¨: å†…å­˜                                            â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  æ”¯æŒæ“ä½œ:                                                      â”‚
â”‚  â€¢ Get(key) â†’ (value, exists)                                  â”‚
â”‚  â€¢ Set(key, value, ttl)                                        â”‚
â”‚  â€¢ Invalidate(pattern) â†’ æ”¯æŒé€šé…ç¬¦                            â”‚
â”‚                                                                 â”‚
â”‚  ä½¿ç”¨åœºæ™¯:                                                      â”‚
â”‚  â€¢ æœç´¢ç»“æœç¼“å­˜                                                 â”‚
â”‚  â€¢ æ—¥ç¨‹æŸ¥è¯¢ç¼“å­˜                                                 â”‚
â”‚  â€¢ LLM å“åº”ç¼“å­˜                                                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæµç¨‹

1. **Get**: æŸ¥è¯¢ç¼“å­˜ï¼Œå‘½ä¸­åˆ™è¿”å›å¹¶æ›´æ–° LRU é¡ºåº
2. **Set**: å­˜å…¥ç¼“å­˜ï¼Œè¶…å‡ºå®¹é‡åˆ™æ·˜æ±°æœ€ä¹…æœªç”¨
3. **Invalidate**: æŒ‰æ¨¡å¼å¤±æ•ˆç¼“å­˜æ¡ç›®

### 3.3 å…³é”®å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | é€‰æ‹© | ç†ç”± |
|:---|:---|:---|:---:|:---|
| å­˜å‚¨ | Redis | å†…å­˜ LRU | B | ç§äººéƒ¨ç½²æ— éœ€ Redis |
| æ·˜æ±°ç­–ç•¥ | LRU | TTL only | A | æ›´å¥½çš„å†…å­˜åˆ©ç”¨ |

---

## 4. æŠ€æœ¯å®ç°

### 4.1 æ¥å£å®šä¹‰

è§ [S0-interface-contract](../sprint-0/S0-interface-contract.md)

### 4.2 å…³é”®ä»£ç è·¯å¾„

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|:---|:---|
| `plugin/ai/cache/service.go` | ç¼“å­˜æœåŠ¡ä¸»å®ç° |
| `plugin/ai/cache/lru.go` | LRU å®ç° |

### 4.3 LRU å®ç°

```go
// plugin/ai/cache/lru.go

type LRUCache struct {
    capacity int
    ttl      time.Duration
    cache    map[string]*entry
    order    *list.List  // åŒå‘é“¾è¡¨ç»´æŠ¤é¡ºåº
    mu       sync.RWMutex
}

type entry struct {
    key       string
    value     []byte
    expiresAt time.Time
    element   *list.Element
}

func NewLRUCache(capacity int, defaultTTL time.Duration) *LRUCache {
    return &LRUCache{
        capacity: capacity,
        ttl:      defaultTTL,
        cache:    make(map[string]*entry),
        order:    list.New(),
    }
}

func (c *LRUCache) Get(key string) ([]byte, bool) {
    c.mu.RLock()
    e, ok := c.cache[key]
    c.mu.RUnlock()
    
    if !ok {
        return nil, false
    }
    
    // æ£€æŸ¥è¿‡æœŸ
    if time.Now().After(e.expiresAt) {
        c.mu.Lock()
        c.remove(key)
        c.mu.Unlock()
        return nil, false
    }
    
    // ç§»åˆ°æœ€å‰
    c.mu.Lock()
    c.order.MoveToFront(e.element)
    c.mu.Unlock()
    
    return e.value, true
}

func (c *LRUCache) Set(key string, value []byte, ttl time.Duration) {
    if ttl == 0 {
        ttl = c.ttl
    }
    
    c.mu.Lock()
    defer c.mu.Unlock()
    
    // å·²å­˜åœ¨åˆ™æ›´æ–°
    if e, ok := c.cache[key]; ok {
        e.value = value
        e.expiresAt = time.Now().Add(ttl)
        c.order.MoveToFront(e.element)
        return
    }
    
    // å®¹é‡æ»¡åˆ™æ·˜æ±°
    if len(c.cache) >= c.capacity {
        c.evict()
    }
    
    // æ–°å¢
    e := &entry{
        key:       key,
        value:     value,
        expiresAt: time.Now().Add(ttl),
    }
    e.element = c.order.PushFront(e)
    c.cache[key] = e
}

func (c *LRUCache) Invalidate(pattern string) error {
    c.mu.Lock()
    defer c.mu.Unlock()
    
    // æ”¯æŒ * é€šé…ç¬¦
    for key := range c.cache {
        if matchPattern(pattern, key) {
            c.remove(key)
        }
    }
    return nil
}
```

---

## 5. äº¤ä»˜ç‰©æ¸…å•

### 5.1 ä»£ç æ–‡ä»¶

- [ ] `plugin/ai/cache/service.go` - ç¼“å­˜æœåŠ¡ä¸»å®ç°
- [ ] `plugin/ai/cache/lru.go` - LRU ç¼“å­˜å®ç°

### 5.2 æµ‹è¯•æ–‡ä»¶

- [ ] `plugin/ai/cache/service_test.go`
- [ ] `plugin/ai/cache/lru_test.go`

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 åŠŸèƒ½æµ‹è¯•

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|:---|:---|:---|
| ç¼“å­˜å‘½ä¸­ | Get(å­˜åœ¨çš„key) | è¿”å›å€¼ + true |
| ç¼“å­˜æœªå‘½ä¸­ | Get(ä¸å­˜åœ¨çš„key) | nil + false |
| è¿‡æœŸå¤±æ•ˆ | Get(è¿‡æœŸçš„key) | nil + false |
| é€šé…ç¬¦å¤±æ•ˆ | Invalidate("user:*") | åŒ¹é…çš„éƒ½è¢«åˆ é™¤ |

### 6.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|:---|:---|:---|
| Get å»¶è¿Ÿ | < 1ms | å•å…ƒæµ‹è¯• |
| Set å»¶è¿Ÿ | < 1ms | å•å…ƒæµ‹è¯• |
| å†…å­˜å ç”¨ | < 10MB | å‹æµ‹ |

---

## 7. ROI åˆ†æ

| ç»´åº¦ | å€¼ |
|:---|:---|
| å¼€å‘æŠ•å…¥ | 1 äººå¤© |
| é¢„æœŸæ”¶ç›Š | é‡å¤æŸ¥è¯¢ <10ms |
| é£é™©è¯„ä¼° | ä½ |
| å›æŠ¥å‘¨æœŸ | ç«‹å³ |

---

## 8. å®æ–½è®¡åˆ’

### 8.1 æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ |
|:---|:---|:---|
| Day 1 | 1äººå¤© | LRU å®ç° + æµ‹è¯• |

### 8.2 æ£€æŸ¥ç‚¹

- [ ] Day 1: ç¼“å­˜æœåŠ¡å®Œæˆå¹¶é€šè¿‡æµ‹è¯•

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [æ—¥ç¨‹è·¯çº¿å›¾ - æ™ºèƒ½ç¼“å­˜å±‚](../../research/schedule-roadmap.md)

### B. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|:---|:---|:---|:---|
| 2026-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
