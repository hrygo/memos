# P1-B002: é”™è¯¯æ¢å¤æœºåˆ¶

> **çŠ¶æ€**: ğŸ”² å¾…å¼€å‘  
> **ä¼˜å…ˆçº§**: P0 (æ ¸å¿ƒ)  
> **æŠ•å…¥**: 1 äººå¤©  
> **è´Ÿè´£å›¢é˜Ÿ**: å›¢é˜Ÿ B  
> **Sprint**: Sprint 1

---

## 1. ç›®æ ‡ä¸èƒŒæ™¯

### 1.1 æ ¸å¿ƒç›®æ ‡

å®ç° Agent æ‰§è¡Œå±‚çš„é”™è¯¯è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼Œå‡å°‘ç”¨æˆ·é‡æ–°è¾“å…¥çš„æ¬¡æ•°ã€‚

### 1.2 ç”¨æˆ·ä»·å€¼

- é”™è¯¯è‡ªåŠ¨æ¢å¤ï¼Œæ— éœ€é‡æ–°è¾“å…¥
- å‹å¥½çš„é”™è¯¯æç¤º

### 1.3 æŠ€æœ¯ä»·å€¼

- ç»Ÿä¸€é”™è¯¯å¤„ç†é€»è¾‘
- æå‡ç³»ç»Ÿå¥å£®æ€§

---

## 2. ä¾èµ–å…³ç³»

### 2.1 å‰ç½®ä¾èµ–

- æ— 

### 2.2 å¹¶è¡Œä¾èµ–

- P1-B001: å·¥å…·å¯é æ€§å¢å¼ºï¼ˆå¯å¹¶è¡Œï¼‰

### 2.3 åç»­ä¾èµ–

- æ‰€æœ‰ Agent æ‰§è¡Œ

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é”™è¯¯æ¢å¤æœºåˆ¶                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Agent æ‰§è¡Œ                                                      â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              æ‰§è¡Œç»“æœ                                     â”‚   â”‚
â”‚  â”‚              â”‚                                            â”‚   â”‚
â”‚  â”‚     æˆåŠŸ â—„â”€â”€â”€â”´â”€â”€â”€â–º å¤±è´¥                                   â”‚   â”‚
â”‚  â”‚      â”‚              â”‚                                     â”‚   â”‚
â”‚  â”‚      â–¼              â–¼                                     â”‚   â”‚
â”‚  â”‚   è¿”å›ç»“æœ      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚                 â”‚  tryRecover(err, input)           â”‚     â”‚   â”‚
â”‚  â”‚                 â”‚                                   â”‚     â”‚   â”‚
â”‚  â”‚                 â”‚  å¯æ¢å¤?                          â”‚     â”‚   â”‚
â”‚  â”‚                 â”‚  â”œâ”€ Yes â†’ ä¿®æ­£è¾“å…¥ â†’ é‡è¯•         â”‚     â”‚   â”‚
â”‚  â”‚                 â”‚  â””â”€ No  â†’ å‹å¥½é”™è¯¯æç¤º            â”‚     â”‚   â”‚
â”‚  â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  å¯æ¢å¤é”™è¯¯ç±»å‹:                                                â”‚
â”‚  â€¢ ErrInvalidTimeFormat â†’ é‡æ–°è§£ææ—¶é—´                         â”‚
â”‚  â€¢ ErrToolNotFound â†’ é‡æ–°è·¯ç”±                                  â”‚
â”‚  â€¢ ErrParseError â†’ æå–å…³é”®ä¿¡æ¯é‡è¯•                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæµç¨‹

1. **æ‰§è¡Œ**: Agent æ‰§è¡Œä»»åŠ¡
2. **é”™è¯¯æ£€æµ‹**: æ•è·æ‰§è¡Œé”™è¯¯
3. **æ¢å¤å°è¯•**: å°è¯•è‡ªåŠ¨ä¿®æ­£
4. **å‹å¥½æç¤º**: æ— æ³•æ¢å¤æ—¶è¿”å›å‹å¥½æç¤º

### 3.3 å…³é”®å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | é€‰æ‹© | ç†ç”± |
|:---|:---|:---|:---:|:---|
| é‡è¯•æ¬¡æ•° | 1æ¬¡ | æ— é™ | A | é¿å…æ­»å¾ªç¯ |
| é”™è¯¯æç¤º | æŠ€æœ¯é”™è¯¯ | ç”¨æˆ·å‹å¥½ | B | æ›´å¥½çš„ä½“éªŒ |

---

## 4. æŠ€æœ¯å®ç°

### 4.1 å…³é”®ä»£ç è·¯å¾„

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|:---|:---|
| `plugin/ai/agent/recovery.go` | é”™è¯¯æ¢å¤é€»è¾‘ |

### 4.2 æ ¸å¿ƒå®ç°

```go
// plugin/ai/agent/recovery.go

type ErrorRecovery struct {
    timeNormalizer *time.TimeNormalizer
    maxRetries     int
}

func NewErrorRecovery(timeNormalizer *time.TimeNormalizer) *ErrorRecovery {
    return &ErrorRecovery{
        timeNormalizer: timeNormalizer,
        maxRetries:     1,
    }
}

// ExecuteWithRecovery å¸¦è‡ªåŠ¨æ¢å¤çš„æ‰§è¡Œ
func (r *ErrorRecovery) ExecuteWithRecovery(
    ctx context.Context,
    executor func(context.Context, string) (string, error),
    input string,
) (string, error) {
    result, err := executor(ctx, input)
    if err == nil {
        return result, nil
    }
    
    // å°è¯•æ¢å¤
    if recovered, fixedInput := r.tryRecover(err, input); recovered {
        result, err = executor(ctx, fixedInput)
        if err == nil {
            return result, nil
        }
    }
    
    // è¿”å›å‹å¥½é”™è¯¯
    return r.formatUserFriendlyError(err), nil
}

// tryRecover å°è¯•è‡ªåŠ¨æ¢å¤
func (r *ErrorRecovery) tryRecover(err error, input string) (bool, string) {
    switch {
    case errors.Is(err, ErrInvalidTimeFormat):
        // æ—¶é—´æ ¼å¼é”™è¯¯ â†’ å°è¯•é‡æ–°è§£æ
        if normalized := r.normalizeTimeInInput(input); normalized != input {
            return true, normalized
        }
        
    case errors.Is(err, ErrToolNotFound):
        // å·¥å…·ä¸å­˜åœ¨ â†’ ä¸ä¿®æ”¹ï¼Œè®©è·¯ç”±é‡æ–°é€‰æ‹©
        return true, input
        
    case errors.Is(err, ErrParseError):
        // è§£æé”™è¯¯ â†’ å°è¯•æå–å…³é”®ä¿¡æ¯
        if simplified := r.simplifyInput(input); simplified != input {
            return true, simplified
        }
    }
    
    return false, ""
}

// normalizeTimeInInput å°è¯•æ ‡å‡†åŒ–è¾“å…¥ä¸­çš„æ—¶é—´
func (r *ErrorRecovery) normalizeTimeInInput(input string) string {
    // æå–æ—¶é—´è¡¨è¾¾å¼å¹¶å°è¯•æ ‡å‡†åŒ–
    // ä¾‹å¦‚: "æ˜å¤©3ç‚¹" â†’ "2026-01-28T15:00:00"
    return r.timeNormalizer.NormalizeInText(input)
}

// formatUserFriendlyError æ ¼å¼åŒ–ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
func (r *ErrorRecovery) formatUserFriendlyError(err error) string {
    switch {
    case errors.Is(err, ErrInvalidTimeFormat):
        return "æŠ±æ­‰ï¼Œæˆ‘æ²¡èƒ½ç†è§£æ—¶é—´ã€‚è¯·å°è¯•æ›´æ˜ç¡®çš„è¡¨è¾¾ï¼Œæ¯”å¦‚"æ˜å¤©ä¸‹åˆ3ç‚¹""
        
    case errors.Is(err, ErrToolNotFound):
        return "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å¤„ç†è¿™ä¸ªè¯·æ±‚"
        
    case errors.Is(err, ErrNetworkError):
        return "ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•"
        
    case errors.Is(err, context.DeadlineExceeded):
        return "å¤„ç†æ—¶é—´è¾ƒé•¿ï¼Œè¯·ç¨åé‡è¯•"
        
    default:
        return "æŠ±æ­‰ï¼Œå¤„ç†é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•"
    }
}
```

---

## 5. äº¤ä»˜ç‰©æ¸…å•

### 5.1 ä»£ç æ–‡ä»¶

- [ ] `plugin/ai/agent/recovery.go` - é”™è¯¯æ¢å¤é€»è¾‘
- [ ] `plugin/ai/agent/errors.go` - é”™è¯¯å®šä¹‰

### 5.2 æµ‹è¯•æ–‡ä»¶

- [ ] `plugin/ai/agent/recovery_test.go`

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 åŠŸèƒ½æµ‹è¯•

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|:---|:---|:---|
| æ—¶é—´é”™è¯¯æ¢å¤ | é”™è¯¯æ—¶é—´æ ¼å¼ | è‡ªåŠ¨ä¿®æ­£åé‡è¯• |
| ä¸å¯æ¢å¤é”™è¯¯ | æœªçŸ¥é”™è¯¯ | å‹å¥½æç¤º |
| æ­£å¸¸æ‰§è¡Œ | æ­£ç¡®è¾“å…¥ | æ­£å¸¸è¿”å› |

### 6.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|:---|:---|:---|
| æ¢å¤å¼€é”€ | < 50ms | å•å…ƒæµ‹è¯• |

---

## 7. ROI åˆ†æ

| ç»´åº¦ | å€¼ |
|:---|:---|
| å¼€å‘æŠ•å…¥ | 1 äººå¤© |
| é¢„æœŸæ”¶ç›Š | ç”¨æˆ·é‡è¯•ç‡ -50% |
| é£é™©è¯„ä¼° | ä½ |
| å›æŠ¥å‘¨æœŸ | Phase 1 ç»“æŸ |

---

## 8. å®æ–½è®¡åˆ’

### 8.1 æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ |
|:---|:---|:---|
| Day 1 | 1äººå¤© | æ¢å¤é€»è¾‘ + æµ‹è¯• |

### 8.2 æ£€æŸ¥ç‚¹

- [ ] Day 1: æ—¶é—´é”™è¯¯å¯è‡ªåŠ¨æ¢å¤

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [æ—¥ç¨‹è·¯çº¿å›¾ - é”™è¯¯æ¢å¤](../../research/schedule-roadmap.md)

### B. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|:---|:---|:---|:---|
| 2026-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
