# P1-B003: æ—¶é—´è§£æåŠ å›º

> **çŠ¶æ€**: ğŸ”² å¾…å¼€å‘  
> **ä¼˜å…ˆçº§**: P0 (æ ¸å¿ƒ)  
> **æŠ•å…¥**: 2 äººå¤©  
> **è´Ÿè´£å›¢é˜Ÿ**: å›¢é˜Ÿ B  
> **Sprint**: Sprint 1-2

---

## 1. ç›®æ ‡ä¸èƒŒæ™¯

### 1.1 æ ¸å¿ƒç›®æ ‡

åŸºäºå›¢é˜Ÿ A çš„ TimeServiceï¼Œåœ¨æ—¥ç¨‹ Agent å±‚é¢åŠ å›ºæ—¶é—´è§£æï¼Œç¡®ä¿ LLM ç”Ÿæˆçš„æ—¶é—´èƒ½è¢«æ­£ç¡®å¤„ç†ã€‚

### 1.2 ç”¨æˆ·ä»·å€¼

- æ—¥ç¨‹åˆ›å»ºæˆåŠŸç‡ä» 85% æå‡è‡³ 98%
- è‡ªç„¶è¯­è¨€æ—¶é—´è¡¨è¾¾æ›´å¯é 

### 1.3 æŠ€æœ¯ä»·å€¼

- è¡¥å…… LLM è¾“å‡ºçš„æ—¶é—´æ ¼å¼å…¼å®¹
- ä¸ TimeService ååŒå·¥ä½œ

---

## 2. ä¾èµ–å…³ç³»

### 2.1 å‰ç½®ä¾èµ–

- [ ] P1-A004: æ—¶é—´è§£ææœåŠ¡ï¼ˆæ ¸å¿ƒä¾èµ–ï¼‰

### 2.2 å¹¶è¡Œä¾èµ–

- P1-B004: è§„åˆ™åˆ†ç±»å™¨æ‰©å±•

### 2.3 åç»­ä¾èµ–

- P2-B002: å¿«é€Ÿåˆ›å»ºæ¨¡å¼

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ—¶é—´è§£æåŠ å›ºå±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  LLM è¾“å‡ºçš„æ—¶é—´                                                  â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: LLM è¾“å‡ºæ ¼å¼å…¼å®¹                                 â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ "2026å¹´1æœˆ28æ—¥ä¸‹åˆ3ç‚¹" â†’ æ ‡å‡†åŒ–                       â”‚   â”‚
â”‚  â”‚  â€¢ "tomorrow 3pm" â†’ æ ‡å‡†åŒ–                               â”‚   â”‚
â”‚  â”‚  â€¢ "15:00" (ç¼ºæ—¥æœŸ) â†’ è¡¥å……ä»Šå¤©/æ˜å¤©                      â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯æ ¼å¼ â†’ å°è¯•ä¿®å¤                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: è°ƒç”¨ TimeService                                 â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  TimeService.Normalize(input, timezone)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: åˆç†æ€§æ£€æŸ¥                                       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ æ—¶é—´æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…ï¼ˆä¸æ—©äºç°åœ¨ï¼‰                     â”‚   â”‚
â”‚  â”‚  â€¢ æ˜¯å¦åœ¨æœªæ¥ 1 å¹´å†…                                      â”‚   â”‚
â”‚  â”‚  â€¢ å·¥ä½œæ—¶é—´åå¥½æ£€æŸ¥                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæµç¨‹

1. **æ ¼å¼å…¼å®¹**: å¤„ç† LLM è¾“å‡ºçš„å„ç§æ ¼å¼
2. **æ ‡å‡†åŒ–**: è°ƒç”¨ TimeService
3. **åˆç†æ€§æ£€æŸ¥**: éªŒè¯æ—¶é—´åˆç†æ€§

### 3.3 LLM è¾“å‡ºæ ¼å¼è¡¨

| LLM å¯èƒ½è¾“å‡º | å¤„ç†æ–¹å¼ |
|:---|:---|
| `2026å¹´1æœˆ28æ—¥ä¸‹åˆ3ç‚¹` | ä¸­æ–‡æ ¼å¼è§£æ |
| `tomorrow 3pm` | è‹±æ–‡æ··åˆè§£æ |
| `15:00` | è¡¥å……æ—¥æœŸï¼ˆæ™ºèƒ½æ¨æ–­ï¼‰ |
| `ä¸‹åˆä¸‰ç‚¹` | ä¸­æ–‡æ•°å­—è½¬æ¢ |
| `æ˜å¤©ä¸‹åˆ` | é»˜è®¤æ—¶é—´ï¼ˆ14:00ï¼‰ |

---

## 4. æŠ€æœ¯å®ç°

### 4.1 å…³é”®ä»£ç è·¯å¾„

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|:---|:---|
| `plugin/ai/schedule/time_hardener.go` | æ—¶é—´åŠ å›ºå±‚ |

### 4.2 æ ¸å¿ƒå®ç°

```go
// plugin/ai/schedule/time_hardener.go

type TimeHardener struct {
    timeService aitime.TimeService
    timezone    *time.Location
    now         func() time.Time
}

func NewTimeHardener(timeService aitime.TimeService, timezone *time.Location) *TimeHardener {
    return &TimeHardener{
        timeService: timeService,
        timezone:    timezone,
        now:         time.Now,
    }
}

// HardenTime åŠ å›ºæ—¶é—´è§£æ
func (h *TimeHardener) HardenTime(ctx context.Context, input string) (time.Time, error) {
    // Step 1: é¢„å¤„ç† LLM è¾“å‡º
    normalized := h.preprocessLLMOutput(input)
    
    // Step 2: è°ƒç”¨ TimeService
    t, err := h.timeService.Normalize(ctx, normalized, h.timezone.String())
    if err != nil {
        return time.Time{}, fmt.Errorf("æ—¶é—´è§£æå¤±è´¥: %w", err)
    }
    
    // Step 3: åˆç†æ€§æ£€æŸ¥
    if err := h.validateTime(t); err != nil {
        return time.Time{}, err
    }
    
    return t, nil
}

// preprocessLLMOutput é¢„å¤„ç† LLM è¾“å‡º
func (h *TimeHardener) preprocessLLMOutput(input string) string {
    // ä¸­æ–‡æ•°å­—è½¬é˜¿æ‹‰ä¼¯æ•°å­—
    input = h.convertChineseNumbers(input)
    
    // å¤„ç†ç¼ºå¤±æ—¥æœŸçš„æƒ…å†µ
    if h.hasTimeButNoDate(input) {
        input = h.inferDate(input)
    }
    
    // æ ‡å‡†åŒ–ä¸­æ–‡æ ¼å¼
    input = h.normalizeChineseFormat(input)
    
    return input
}

// convertChineseNumbers ä¸­æ–‡æ•°å­—è½¬æ¢
func (h *TimeHardener) convertChineseNumbers(input string) string {
    replacer := strings.NewReplacer(
        "ä¸€", "1", "äºŒ", "2", "ä¸‰", "3", "å››", "4", "äº”", "5",
        "å…­", "6", "ä¸ƒ", "7", "å…«", "8", "ä¹", "9", "å", "10",
        "åä¸€", "11", "åäºŒ", "12",
    )
    return replacer.Replace(input)
}

// inferDate æ¨æ–­æ—¥æœŸ
func (h *TimeHardener) inferDate(input string) string {
    // å¦‚æœåªæœ‰æ—¶é—´æ²¡æœ‰æ—¥æœŸï¼Œæ ¹æ®æ—¶é—´æ¨æ–­
    // å¦‚æœæ—¶é—´å·²è¿‡ï¼Œæ¨æ–­ä¸ºæ˜å¤©ï¼›å¦åˆ™ä¸ºä»Šå¤©
    now := h.now()
    
    // æå–æ—¶é—´
    hour := h.extractHour(input)
    if hour < now.Hour() || (hour == now.Hour() && h.extractMinute(input) <= now.Minute()) {
        // æ—¶é—´å·²è¿‡ï¼Œæ¨æ–­ä¸ºæ˜å¤©
        return "æ˜å¤©" + input
    }
    return "ä»Šå¤©" + input
}

// validateTime éªŒè¯æ—¶é—´åˆç†æ€§
func (h *TimeHardener) validateTime(t time.Time) error {
    now := h.now()
    
    // ä¸èƒ½æ˜¯è¿‡å»çš„æ—¶é—´
    if t.Before(now) {
        return fmt.Errorf("æ—¶é—´ä¸èƒ½æ—©äºç°åœ¨")
    }
    
    // ä¸èƒ½å¤ªä¹…è¿œï¼ˆ1å¹´å†…ï¼‰
    oneYearLater := now.AddDate(1, 0, 0)
    if t.After(oneYearLater) {
        return fmt.Errorf("æ—¶é—´å¤ªè¿œï¼Œè¯·é€‰æ‹©ä¸€å¹´å†…çš„æ—¶é—´")
    }
    
    return nil
}
```

---

## 5. äº¤ä»˜ç‰©æ¸…å•

### 5.1 ä»£ç æ–‡ä»¶

- [ ] `plugin/ai/schedule/time_hardener.go` - æ—¶é—´åŠ å›ºå±‚

### 5.2 æµ‹è¯•æ–‡ä»¶

- [ ] `plugin/ai/schedule/time_hardener_test.go`

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 åŠŸèƒ½æµ‹è¯•

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|:---|:---|:---|
| ä¸­æ–‡æ ¼å¼ | "2026å¹´1æœˆ28æ—¥ä¸‹åˆ3ç‚¹" | æ­£ç¡®æ—¶é—´ |
| ç¼ºå¤±æ—¥æœŸ | "ä¸‹åˆ3ç‚¹" | ä»Šå¤©/æ˜å¤©ä¸‹åˆ3ç‚¹ |
| ä¸­æ–‡æ•°å­— | "ä¸‹åˆä¸‰ç‚¹" | ä¸‹åˆ3ç‚¹ |
| è‹±æ–‡æ··åˆ | "tomorrow 3pm" | æ˜å¤©15:00 |

### 6.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|:---|:---|:---|
| è§£ææˆåŠŸç‡ | > 98% | æµ‹è¯•ç”¨ä¾‹é›† |
| è§£æå»¶è¿Ÿ | < 50ms | å•å…ƒæµ‹è¯• |

---

## 7. ROI åˆ†æ

| ç»´åº¦ | å€¼ |
|:---|:---|
| å¼€å‘æŠ•å…¥ | 2 äººå¤© |
| é¢„æœŸæ”¶ç›Š | æ—¥ç¨‹åˆ›å»ºæˆåŠŸç‡ +13% |
| é£é™©è¯„ä¼° | ä½ |
| å›æŠ¥å‘¨æœŸ | Phase 1 ç»“æŸ |

---

## 8. å®æ–½è®¡åˆ’

### 8.1 æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ |
|:---|:---|:---|
| Day 1 | 1äººå¤© | é¢„å¤„ç†é€»è¾‘ |
| Day 2 | 1äººå¤© | æµ‹è¯•ç”¨ä¾‹ + è¾¹ç•Œå¤„ç† |

### 8.2 æ£€æŸ¥ç‚¹

- [ ] Day 1: æ ¸å¿ƒé¢„å¤„ç†å®Œæˆ
- [ ] Day 2: æˆåŠŸç‡ > 98%

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [æ—¥ç¨‹è·¯çº¿å›¾ - æ—¶é—´è§£æåŠ å›º](../../research/schedule-roadmap.md)

### B. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|:---|:---|:---|:---|
| 2026-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
