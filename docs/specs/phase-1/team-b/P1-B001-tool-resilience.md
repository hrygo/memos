# P1-B001: å·¥å…·å¯é æ€§å¢å¼º

> **çŠ¶æ€**: ğŸ”² å¾…å¼€å‘  
> **ä¼˜å…ˆçº§**: P0 (æ ¸å¿ƒ)  
> **æŠ•å…¥**: 2 äººå¤©  
> **è´Ÿè´£å›¢é˜Ÿ**: å›¢é˜Ÿ B  
> **Sprint**: Sprint 1

---

## 1. ç›®æ ‡ä¸èƒŒæ™¯

### 1.1 æ ¸å¿ƒç›®æ ‡

å®ç°å¸¦é‡è¯•å’Œé™çº§çš„å·¥å…·æ‰§è¡Œå™¨ï¼Œæå‡å·¥å…·è°ƒç”¨æˆåŠŸç‡å’Œç”¨æˆ·ä½“éªŒã€‚

### 1.2 ç”¨æˆ·ä»·å€¼

- å·¥å…·è°ƒç”¨æ›´ç¨³å®š
- å¤±è´¥æ—¶æœ‰å‹å¥½æç¤º

### 1.3 æŠ€æœ¯ä»·å€¼

- ç»Ÿä¸€å·¥å…·æ‰§è¡Œç­–ç•¥
- ä¸ºæŒ‡æ ‡é‡‡é›†æä¾›åŸ‹ç‚¹

---

## 2. ä¾èµ–å…³ç³»

### 2.1 å‰ç½®ä¾èµ–

- [ ] P1-A001: è®°å¿†ç³»ç»Ÿï¼ˆç”¨äºé™çº§æ—¶çš„ç¼“å­˜æ•°æ®ï¼‰
- [ ] P1-A002: æŒ‡æ ‡æ¡†æ¶ï¼ˆä¸ŠæŠ¥å·¥å…·è°ƒç”¨æŒ‡æ ‡ï¼‰

### 2.2 å¹¶è¡Œä¾èµ–

- P1-B002: é”™è¯¯æ¢å¤æœºåˆ¶ï¼ˆå¯å¹¶è¡Œï¼‰

### 2.3 åç»­ä¾èµ–

- æ‰€æœ‰ Agent å·¥å…·è°ƒç”¨

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥å…·æ‰§è¡Œå™¨æ¶æ„                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Agent è°ƒç”¨                                                      â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ResilientToolExecutor                       â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  æ‰§è¡Œæµç¨‹                                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  1. é¦–æ¬¡æ‰§è¡Œ                                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  2. å¤±è´¥? â†’ å¯é‡è¯•? â†’ é‡è¯• (æœ€å¤š2æ¬¡)               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  3. ä»å¤±è´¥? â†’ é™çº§ç­–ç•¥                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  4. ä¸ŠæŠ¥æŒ‡æ ‡                                       â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  é…ç½®:                                                   â”‚   â”‚
â”‚  â”‚  â€¢ maxRetries: 2                                         â”‚   â”‚
â”‚  â”‚  â€¢ retryDelay: 500ms                                     â”‚   â”‚
â”‚  â”‚  â€¢ timeout: 10s                                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  é™çº§ç­–ç•¥è¡¨:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å·¥å…·           â”‚ é™çº§æ–¹æ¡ˆ                               â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ memo_search    â”‚ "æœç´¢æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"          â”‚    â”‚
â”‚  â”‚ schedule_query â”‚ ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰                  â”‚    â”‚
â”‚  â”‚ schedule_add   â”‚ è½¬ä¸º"å¾…ç¡®è®¤"çŠ¶æ€                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæµç¨‹

1. **æ‰§è¡Œ**: è°ƒç”¨å·¥å…·
2. **é‡è¯•**: å¤±è´¥ä¸”å¯é‡è¯•æ—¶é‡è¯•
3. **é™çº§**: é‡è¯•å¤±è´¥åæ‰§è¡Œé™çº§ç­–ç•¥
4. **ä¸ŠæŠ¥**: è®°å½•æŒ‡æ ‡

### 3.3 å…³é”®å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | é€‰æ‹© | ç†ç”± |
|:---|:---|:---|:---:|:---|
| é‡è¯•ç­–ç•¥ | å›ºå®šé—´éš” | æŒ‡æ•°é€€é¿ | A | ç®€å•æœ‰æ•ˆï¼Œç§äººéƒ¨ç½²æ— éœ€å¤æ‚ |
| é™çº§ç­–ç•¥ | ç»Ÿä¸€æç¤º | æŒ‰å·¥å…·å®šåˆ¶ | B | æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ |

---

## 4. æŠ€æœ¯å®ç°

### 4.1 å…³é”®ä»£ç è·¯å¾„

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|:---|:---|
| `plugin/ai/agent/tools/executor.go` | å·¥å…·æ‰§è¡Œå™¨ |
| `plugin/ai/agent/tools/fallback.go` | é™çº§ç­–ç•¥ |

### 4.2 æ ¸å¿ƒå®ç°

```go
// plugin/ai/agent/tools/executor.go

type ResilientToolExecutor struct {
    maxRetries     int
    retryDelay     time.Duration
    timeout        time.Duration
    metricsService metrics.MetricsService
    fallbackRules  map[string]FallbackFunc
}

func NewResilientToolExecutor(
    metricsService metrics.MetricsService,
) *ResilientToolExecutor {
    return &ResilientToolExecutor{
        maxRetries:     2,
        retryDelay:     500 * time.Millisecond,
        timeout:        10 * time.Second,
        metricsService: metricsService,
        fallbackRules:  DefaultFallbackRules,
    }
}

func (e *ResilientToolExecutor) Execute(
    ctx context.Context,
    tool Tool,
    input string,
) (*Result, error) {
    start := time.Now()
    var lastErr error
    
    for attempt := 0; attempt <= e.maxRetries; attempt++ {
        // å¸¦è¶…æ—¶æ‰§è¡Œ
        execCtx, cancel := context.WithTimeout(ctx, e.timeout)
        result, err := tool.Run(execCtx, input)
        cancel()
        
        if err == nil {
            // æˆåŠŸï¼Œä¸ŠæŠ¥æŒ‡æ ‡
            e.metricsService.RecordToolCall(ctx, tool.Name(), time.Since(start), true)
            return result, nil
        }
        
        lastErr = err
        
        // æ£€æŸ¥æ˜¯å¦å¯é‡è¯•
        if !isRetryable(err) {
            break
        }
        
        // ç­‰å¾…åé‡è¯•
        if attempt < e.maxRetries {
            time.Sleep(e.retryDelay)
        }
    }
    
    // ä¸ŠæŠ¥å¤±è´¥æŒ‡æ ‡
    e.metricsService.RecordToolCall(ctx, tool.Name(), time.Since(start), false)
    
    // æ‰§è¡Œé™çº§
    if fallback, ok := e.fallbackRules[tool.Name()]; ok {
        return fallback(ctx, tool, input, lastErr)
    }
    
    return nil, lastErr
}

func isRetryable(err error) bool {
    // ç½‘ç»œé”™è¯¯ã€è¶…æ—¶å¯é‡è¯•
    // å‚æ•°é”™è¯¯ã€æƒé™é”™è¯¯ä¸å¯é‡è¯•
    return errors.Is(err, context.DeadlineExceeded) ||
           errors.Is(err, ErrNetworkError) ||
           errors.Is(err, ErrServiceUnavailable)
}
```

### 4.3 é™çº§ç­–ç•¥

```go
// plugin/ai/agent/tools/fallback.go

type FallbackFunc func(ctx context.Context, tool Tool, input string, err error) (*Result, error)

var DefaultFallbackRules = map[string]FallbackFunc{
    "memo_search": func(ctx context.Context, tool Tool, input string, err error) (*Result, error) {
        return &Result{
            Output:  "æœç´¢æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•",
            Success: false,
        }, nil
    },
    
    "schedule_query": func(ctx context.Context, tool Tool, input string, err error) (*Result, error) {
        // å°è¯•ä½¿ç”¨ç¼“å­˜
        if cached := getCachedSchedules(ctx, input); cached != nil {
            return &Result{
                Output:  formatSchedules(cached) + "\n(æ¥è‡ªç¼“å­˜ï¼Œå¯èƒ½ä¸æ˜¯æœ€æ–°)",
                Success: true,
            }, nil
        }
        return &Result{
            Output:  "æ—¥ç¨‹æŸ¥è¯¢æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•",
            Success: false,
        }, nil
    },
    
    "schedule_add": func(ctx context.Context, tool Tool, input string, err error) (*Result, error) {
        return &Result{
            Output:  "æ—¥ç¨‹å·²è®°å½•ï¼Œå¾…ç¡®è®¤åç”Ÿæ•ˆã€‚æ‚¨å¯ä»¥ç¨ååœ¨æ—¥ç¨‹é¡µé¢æŸ¥çœ‹",
            Success: false,
        }, nil
    },
}
```

---

## 5. äº¤ä»˜ç‰©æ¸…å•

### 5.1 ä»£ç æ–‡ä»¶

- [ ] `plugin/ai/agent/tools/executor.go` - å·¥å…·æ‰§è¡Œå™¨
- [ ] `plugin/ai/agent/tools/fallback.go` - é™çº§ç­–ç•¥

### 5.2 æµ‹è¯•æ–‡ä»¶

- [ ] `plugin/ai/agent/tools/executor_test.go`

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 åŠŸèƒ½æµ‹è¯•

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|:---|:---|:---|
| é¦–æ¬¡æˆåŠŸ | æ­£å¸¸è°ƒç”¨ | è¿”å›ç»“æœ |
| é‡è¯•æˆåŠŸ | é¦–æ¬¡è¶…æ—¶ï¼Œé‡è¯•æˆåŠŸ | è¿”å›ç»“æœ |
| é™çº§æ‰§è¡Œ | å¤šæ¬¡å¤±è´¥ | æ‰§è¡Œé™çº§ç­–ç•¥ |
| æŒ‡æ ‡ä¸ŠæŠ¥ | ä»»æ„è°ƒç”¨ | æŒ‡æ ‡è®°å½•æ­£ç¡® |

### 6.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|:---|:---|:---|
| æ‰§è¡Œå¼€é”€ | < 5ms | å•å…ƒæµ‹è¯• |
| é‡è¯•å»¶è¿Ÿ | 500ms | é…ç½®éªŒè¯ |

---

## 7. ROI åˆ†æ

| ç»´åº¦ | å€¼ |
|:---|:---|
| å¼€å‘æŠ•å…¥ | 2 äººå¤© |
| é¢„æœŸæ”¶ç›Š | å·¥å…·è°ƒç”¨æˆåŠŸç‡ +10%ï¼Œç”¨æˆ·ä½“éªŒæå‡ |
| é£é™©è¯„ä¼° | ä½ |
| å›æŠ¥å‘¨æœŸ | Phase 1 ç»“æŸ |

---

## 8. å®æ–½è®¡åˆ’

### 8.1 æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ |
|:---|:---|:---|
| Day 1 | 1äººå¤© | æ‰§è¡Œå™¨å®ç° |
| Day 2 | 1äººå¤© | é™çº§ç­–ç•¥ + æµ‹è¯• |

### 8.2 æ£€æŸ¥ç‚¹

- [ ] Day 1: é‡è¯•æœºåˆ¶ç”Ÿæ•ˆ
- [ ] Day 2: é™çº§ç­–ç•¥å®Œæˆ

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [æ™ºèƒ½åŠ©ç†è·¯çº¿å›¾ - å·¥å…·å¯é æ€§](../../research/assistant-roadmap.md)

### B. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|:---|:---|:---|:---|
| 2026-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
