# P1-C003: ç›¸å…³ç¬”è®°æ¨è

> **çŠ¶æ€**: ğŸ”² å¾…å¼€å‘  
> **ä¼˜å…ˆçº§**: P1 (é‡è¦)  
> **æŠ•å…¥**: 6 äººå¤©  
> **è´Ÿè´£å›¢é˜Ÿ**: å›¢é˜Ÿ C  
> **Sprint**: Sprint 2

---

## 1. ç›®æ ‡ä¸èƒŒæ™¯

### 1.1 æ ¸å¿ƒç›®æ ‡

åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦å’Œæ ‡ç­¾å…±ç°ï¼Œä¸ºå½“å‰ç¬”è®°æ¨èç›¸å…³ç¬”è®°ï¼Œå¸®åŠ©ç”¨æˆ·å‘ç°çŸ¥è¯†å…³è”ã€‚

### 1.2 ç”¨æˆ·ä»·å€¼

- ç¬”è®°å…³è”å‘ç°ç‡ä» 5% æå‡è‡³ 20%
- å‡å°‘é‡å¤è®°å½•

### 1.3 æŠ€æœ¯ä»·å€¼

- å¤ç”¨å‘é‡æ£€ç´¢èƒ½åŠ›
- ä¸ºçŸ¥è¯†å›¾è°±å¥ å®šåŸºç¡€

---

## 2. ä¾èµ–å…³ç³»

### 2.1 å‰ç½®ä¾èµ–

- [ ] P1-A005: ç¼“å­˜å±‚ï¼ˆç”¨äºç¼“å­˜æ¨èç»“æœï¼‰

### 2.2 å¹¶è¡Œä¾èµ–

- P1-C001/C002: æœç´¢é«˜äº®ï¼ˆå¯å¤ç”¨éƒ¨åˆ†é€»è¾‘ï¼‰

### 2.3 åç»­ä¾èµ–

- P2-C002: é‡å¤æ£€æµ‹ç³»ç»Ÿ
- P3-C001: çŸ¥è¯†å›¾è°±å¯è§†åŒ–

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›¸å…³æ¨èæ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  è§¦å‘åœºæ™¯:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ç¼–è¾‘å™¨è¾“å…¥   â”‚  â”‚ ç¬”è®°è¯¦æƒ…é¡µ   â”‚  â”‚ ä¿å­˜ç¬”è®°å   â”‚          â”‚
â”‚  â”‚ (é˜²æŠ–500ms) â”‚  â”‚ (ä¾§è¾¹æ )     â”‚  â”‚ (åå°æ¨é€)   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  RelatedService                          â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  1. å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ (æƒé‡ 0.6)                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ä½¿ç”¨ pgvector cosine similarity               â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                          +                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  2. æ ‡ç­¾å…±ç°è®¡ç®— (æƒé‡ 0.3)                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     å…±äº«æ ‡ç­¾æ•° / æ€»æ ‡ç­¾æ•°                          â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                          +                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  3. æ—¶é—´é‚»è¿‘åº¦ (æƒé‡ 0.1)                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     7å¤©å†…å¾—åˆ†é«˜                                    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                          â”‚                               â”‚   â”‚
â”‚  â”‚                          â–¼                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  åŠ æƒèåˆ + å»é‡ + æ’åº â†’ Top-5                     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæµç¨‹

1. **å‘é‡æ£€ç´¢**: æŸ¥æ‰¾è¯­ä¹‰ç›¸ä¼¼çš„ç¬”è®°
2. **æ ‡ç­¾è®¡ç®—**: è®¡ç®—æ ‡ç­¾å…±ç°åˆ†æ•°
3. **æ—¶é—´è®¡ç®—**: è®¡ç®—æ—¶é—´é‚»è¿‘åˆ†æ•°
4. **èåˆæ’åº**: åŠ æƒèåˆåå– Top-5

### 3.3 å…³é”®å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | é€‰æ‹© | ç†ç”± |
|:---|:---|:---|:---:|:---|
| ç›¸ä¼¼åº¦æ¥æº | ä»…å‘é‡ | å¤šç»´èåˆ | B | æ›´å‡†ç¡®çš„æ¨è |
| è§¦å‘æ—¶æœº | å®æ—¶ | é˜²æŠ– | B | å‡å°‘è®¡ç®—å‹åŠ› |

---

## 4. æŠ€æœ¯å®ç°

### 4.1 æ¥å£å®šä¹‰

```protobuf
// proto/api/v1/memo_service.proto

rpc GetRelatedMemos(GetRelatedMemosRequest) returns (GetRelatedMemosResponse);

message GetRelatedMemosRequest {
  string memo_name = 1;
  int32 limit = 2;           // default: 5
}

message GetRelatedMemosResponse {
  repeated RelatedMemo memos = 1;
}

message RelatedMemo {
  string name = 1;
  string title = 2;
  float similarity = 3;
  repeated string shared_tags = 4;
  int64 created_ts = 5;
}
```

### 4.2 å…³é”®ä»£ç è·¯å¾„

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|:---|:---|
| `server/service/memo/related.go` | ç›¸å…³æœåŠ¡ |
| `server/router/api/v1/memo_service.go` | API å¤„ç†å™¨ |
| `web/src/components/MemoRelated/RelatedList.tsx` | å‰ç«¯ç»„ä»¶ |

### 4.3 åç«¯å®ç°

```go
// server/service/memo/related.go

type RelatedService struct {
    embeddingStore *store.EmbeddingStore
    memoStore      *store.MemoStore
    cache          cache.CacheService
}

type RelatedMemo struct {
    Name       string   `json:"name"`
    Title      string   `json:"title"`
    Similarity float32  `json:"similarity"`
    SharedTags []string `json:"shared_tags"`
    CreatedTs  int64    `json:"created_ts"`
}

func (s *RelatedService) GetRelatedMemos(
    ctx context.Context,
    memoUID string,
    limit int,
) ([]RelatedMemo, error) {
    // æ£€æŸ¥ç¼“å­˜
    cacheKey := fmt.Sprintf("related:%s", memoUID)
    if cached, ok := s.cache.Get(ctx, cacheKey); ok {
        var result []RelatedMemo
        json.Unmarshal(cached, &result)
        return result, nil
    }
    
    // 1. è·å–å½“å‰ç¬”è®°çš„å‘é‡
    currentEmb, err := s.embeddingStore.GetByMemoUID(ctx, memoUID)
    if err != nil {
        return nil, err
    }
    
    // 2. å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢
    vectorResults, err := s.embeddingStore.FindSimilar(ctx, currentEmb.Vector, limit*2)
    if err != nil {
        return nil, err
    }
    
    // 3. è·å–å½“å‰ç¬”è®°æ ‡ç­¾
    currentMemo, _ := s.memoStore.GetByUID(ctx, memoUID)
    currentTags := extractTags(currentMemo.Payload)
    
    // 4. è®¡ç®—ç»¼åˆå¾—åˆ†
    var results []RelatedMemo
    for _, v := range vectorResults {
        if v.MemoUID == memoUID {
            continue // æ’é™¤è‡ªèº«
        }
        
        memo, _ := s.memoStore.GetByUID(ctx, v.MemoUID)
        memoTags := extractTags(memo.Payload)
        
        // æ ‡ç­¾å…±ç°å¾—åˆ†
        sharedTags := intersect(currentTags, memoTags)
        tagScore := float32(len(sharedTags)) / float32(max(len(currentTags), 1))
        
        // æ—¶é—´é‚»è¿‘å¾—åˆ† (7å¤©å†…å¾—åˆ†é«˜)
        timeDiff := abs(currentMemo.CreatedTs - memo.CreatedTs)
        timeScore := max(0, 1.0 - float32(timeDiff)/(7*24*3600))
        
        // åŠ æƒèåˆ
        finalScore := 0.6*v.Similarity + 0.3*tagScore + 0.1*timeScore
        
        results = append(results, RelatedMemo{
            Name:       memo.UID,
            Title:      extractTitle(memo.Content),
            Similarity: finalScore,
            SharedTags: sharedTags,
            CreatedTs:  memo.CreatedTs,
        })
    }
    
    // 5. æ’åºå– Top-N
    sort.Slice(results, func(i, j int) bool {
        return results[i].Similarity > results[j].Similarity
    })
    
    if len(results) > limit {
        results = results[:limit]
    }
    
    // å†™å…¥ç¼“å­˜
    data, _ := json.Marshal(results)
    s.cache.Set(ctx, cacheKey, data, 5*time.Minute)
    
    return results, nil
}
```

### 4.4 å‰ç«¯å®ç°

```tsx
// web/src/components/MemoRelated/RelatedList.tsx

interface RelatedListProps {
  memoName: string;
}

export function RelatedList({ memoName }: RelatedListProps) {
  const { data, isLoading } = useQuery({
    queryKey: ['related', memoName],
    queryFn: () => memoService.getRelatedMemos({ memoName, limit: 5 }),
    enabled: !!memoName,
  });

  if (isLoading) {
    return <Skeleton className="h-32" />;
  }

  if (!data?.memos?.length) {
    return (
      <div className="text-sm text-gray-500">
        {t("memo.no-related")}
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <h4 className="text-sm font-medium text-gray-700 dark:text-gray-300">
        {t("memo.related-notes")}
      </h4>
      {data.memos.map((memo) => (
        <Link
          key={memo.name}
          to={`/m/${memo.name}`}
          className="block p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-800"
        >
          <div className="text-sm font-medium truncate">{memo.title}</div>
          <div className="flex items-center gap-2 mt-1 text-xs text-gray-500">
            <span>{(memo.similarity * 100).toFixed(0)}% {t("memo.match")}</span>
            {memo.sharedTags.length > 0 && (
              <span className="text-blue-500">
                #{memo.sharedTags[0]}
              </span>
            )}
          </div>
        </Link>
      ))}
    </div>
  );
}
```

---

## 5. äº¤ä»˜ç‰©æ¸…å•

### 5.1 ä»£ç æ–‡ä»¶

- [ ] `server/service/memo/related.go` - ç›¸å…³æœåŠ¡
- [ ] `server/router/api/v1/memo_service.go` - API æ‰©å±•
- [ ] `web/src/components/MemoRelated/RelatedList.tsx` - å‰ç«¯ç»„ä»¶
- [ ] `web/src/components/MemoRelated/index.ts` - å¯¼å‡º

### 5.2 Proto å˜æ›´

- [ ] `proto/api/v1/memo_service.proto` - æ–°å¢ RPC

### 5.3 å›½é™…åŒ–

- [ ] `web/src/locales/en.json` - æ–°å¢ key
- [ ] `web/src/locales/zh-Hans.json` - æ–°å¢ key

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 åŠŸèƒ½æµ‹è¯•

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|:---|:---|:---|
| æœ‰ç›¸å…³ç¬”è®° | æœ‰æ ‡ç­¾å’Œå†…å®¹ç›¸ä¼¼çš„ç¬”è®° | è¿”å› Top-5 |
| æ— ç›¸å…³ç¬”è®° | æ— ç›¸ä¼¼å†…å®¹ | è¿”å›ç©ºåˆ—è¡¨ |
| è‡ªèº«æ’é™¤ | å½“å‰ç¬”è®° UID | ä¸åŒ…å«è‡ªèº« |

### 6.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|:---|:---|:---|
| é¦–æ¬¡å“åº” | < 500ms | é›†æˆæµ‹è¯• |
| ç¼“å­˜å‘½ä¸­ | < 50ms | é›†æˆæµ‹è¯• |

---

## 7. ROI åˆ†æ

| ç»´åº¦ | å€¼ |
|:---|:---|
| å¼€å‘æŠ•å…¥ | 6 äººå¤© |
| é¢„æœŸæ”¶ç›Š | ç¬”è®°å…³è”å‘ç°ç‡ +300% |
| é£é™©è¯„ä¼° | ä¸­ |
| å›æŠ¥å‘¨æœŸ | Phase 1 ç»“æŸ |

---

## 8. å®æ–½è®¡åˆ’

### 8.1 æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ |
|:---|:---|:---|
| Day 1-2 | 2äººå¤© | åç«¯æœåŠ¡å®ç° |
| Day 3-4 | 2äººå¤© | å‰ç«¯ç»„ä»¶å®ç° |
| Day 5-6 | 2äººå¤© | æµ‹è¯• + ä¼˜åŒ– |

### 8.2 æ£€æŸ¥ç‚¹

- [ ] Day 2: API å¯ç”¨
- [ ] Day 4: å‰ç«¯æ¸²æŸ“æ­£ç¡®
- [ ] Day 6: æ€§èƒ½è¾¾æ ‡

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [ç¬”è®°å¢å¼ºè·¯çº¿å›¾](../../research/memo-roadmap.md)

### B. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|:---|:---|:---|:---|
| 2026-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
