# P1-C002: ä¸Šä¸‹æ–‡æ™ºèƒ½æ‘˜å½•

> **çŠ¶æ€**: ğŸ”² å¾…å¼€å‘  
> **ä¼˜å…ˆçº§**: P1 (é‡è¦)  
> **æŠ•å…¥**: 2 äººå¤©  
> **è´Ÿè´£å›¢é˜Ÿ**: å›¢é˜Ÿ C  
> **Sprint**: Sprint 1-2

---

## 1. ç›®æ ‡ä¸èƒŒæ™¯

### 1.1 æ ¸å¿ƒç›®æ ‡

åŸºäºæœç´¢é«˜äº®åŠŸèƒ½ï¼Œæ™ºèƒ½æå–åŒ¹é…ä½ç½®çš„ä¸Šä¸‹æ–‡æ‘˜å½•ï¼Œå±•ç¤ºæœ€ç›¸å…³çš„å†…å®¹ç‰‡æ®µã€‚

### 1.2 ç”¨æˆ·ä»·å€¼

- æ— éœ€ç‚¹å‡»å³å¯é¢„è§ˆå…³é”®å†…å®¹
- å¿«é€Ÿåˆ¤æ–­æœç´¢ç»“æœç›¸å…³æ€§

### 1.3 æŠ€æœ¯ä»·å€¼

- æ‰©å±•é«˜äº®æœåŠ¡èƒ½åŠ›
- ä¸ºç›¸å…³æ¨èæä¾›å¤ç”¨

---

## 2. ä¾èµ–å…³ç³»

### 2.1 å‰ç½®ä¾èµ–

- [ ] P1-C001: æœç´¢ç»“æœé«˜äº®ï¼ˆæ ¸å¿ƒä¾èµ–ï¼‰

### 2.2 å¹¶è¡Œä¾èµ–

- æ— 

### 2.3 åç»­ä¾èµ–

- P1-C003: ç›¸å…³ç¬”è®°æ¨è

---

## 3. åŠŸèƒ½è®¾è®¡

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ™ºèƒ½æ‘˜å½•é€»è¾‘                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  è¾“å…¥: å†…å®¹ + åŒ¹é…ä½ç½®åˆ—è¡¨ + contextChars                        â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 1: é€‰æ‹©æœ€ä½³åŒ¹é…ç‚¹                                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ ä¼˜å…ˆé€‰æ‹©ç¬¬ä¸€ä¸ªåŒ¹é…ï¼ˆæœ€ç›¸å…³ï¼‰                           â”‚   â”‚
â”‚  â”‚  â€¢ å¦‚æœ‰å¤šä¸ªåŒ¹é…ï¼Œé€‰æ‹©è·ç¦»å¼€å¤´æœ€è¿‘çš„                       â”‚   â”‚
â”‚  â”‚  â€¢ å¦‚åŒ¹é…åœ¨ä¸­é—´ï¼Œå±…ä¸­å±•ç¤º                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 2: æå–ä¸Šä¸‹æ–‡çª—å£                                    â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ ä»¥åŒ¹é…ç‚¹ä¸ºä¸­å¿ƒ                                        â”‚   â”‚
â”‚  â”‚  â€¢ å‰åå„å– contextChars å­—ç¬¦                            â”‚   â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½è°ƒæ•´åˆ°è¯è¾¹ç•Œï¼ˆé¿å…æˆªæ–­è¯è¯­ï¼‰                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Step 3: æ ¼å¼åŒ–è¾“å‡º                                        â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ å¼€å¤´ä¸æ˜¯åŸæ–‡å¼€å¤´ â†’ æ·»åŠ  "..."                         â”‚   â”‚
â”‚  â”‚  â€¢ ç»“å°¾ä¸æ˜¯åŸæ–‡ç»“å°¾ â†’ æ·»åŠ  "..."                         â”‚   â”‚
â”‚  â”‚  â€¢ è°ƒæ•´é«˜äº®ä½ç½®åç§»                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  è¾“å‡º: æ‘˜å½•æ–‡æœ¬ + è°ƒæ•´åçš„é«˜äº®ä½ç½®                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæµç¨‹

1. **é€‰ç‚¹**: é€‰æ‹©æœ€ä½³åŒ¹é…ç‚¹
2. **æå–**: ä»¥åŒ¹é…ç‚¹ä¸ºä¸­å¿ƒæå–ä¸Šä¸‹æ–‡
3. **è°ƒæ•´**: è°ƒæ•´åˆ°è¯è¾¹ç•Œ
4. **æ ¼å¼åŒ–**: æ·»åŠ çœç•¥å·å’Œä½ç½®åç§»

### 3.3 å…³é”®å†³ç­–

| å†³ç­–ç‚¹ | æ–¹æ¡ˆ A | æ–¹æ¡ˆ B | é€‰æ‹© | ç†ç”± |
|:---|:---|:---|:---:|:---|
| æ‘˜å½•é•¿åº¦ | å›ºå®šé•¿åº¦ | å¯é…ç½® | B | é€‚åº”ä¸åŒåœºæ™¯ |
| è¯è¾¹ç•Œè°ƒæ•´ | ç²¾ç¡®åˆ†è¯ | ç®€å•è§„åˆ™ | B | æ€§èƒ½ä¼˜å…ˆ |

---

## 4. æŠ€æœ¯å®ç°

### 4.1 å…³é”®ä»£ç è·¯å¾„

| æ–‡ä»¶è·¯å¾„ | èŒè´£ |
|:---|:---|
| `server/service/memo/snippet.go` | æ‘˜å½•æå– |

### 4.2 æ ¸å¿ƒå®ç°

```go
// server/service/memo/snippet.go

type SnippetExtractor struct {
    defaultContextChars int
}

func NewSnippetExtractor() *SnippetExtractor {
    return &SnippetExtractor{
        defaultContextChars: 50,
    }
}

// ExtractSnippet æå–æ™ºèƒ½æ‘˜å½•
func (e *SnippetExtractor) ExtractSnippet(
    content string,
    matches []Highlight,
    contextChars int,
) (string, []Highlight) {
    if contextChars == 0 {
        contextChars = e.defaultContextChars
    }
    
    // æ— åŒ¹é…ï¼Œè¿”å›å¼€å¤´
    if len(matches) == 0 {
        snippet := e.truncate(content, contextChars*2)
        return snippet, nil
    }
    
    // å–ç¬¬ä¸€ä¸ªåŒ¹é…ç‚¹ä¸ºä¸­å¿ƒ
    center := matches[0].Start
    
    // è®¡ç®—çª—å£
    start := max(0, center-contextChars)
    end := min(len(content), center+contextChars)
    
    // è°ƒæ•´åˆ°è¯è¾¹ç•Œ
    start = e.adjustToWordBoundary(content, start, false)
    end = e.adjustToWordBoundary(content, end, true)
    
    snippet := content[start:end]
    
    // æ·»åŠ çœç•¥å·
    prefix := ""
    suffix := ""
    if start > 0 {
        prefix = "..."
    }
    if end < len(content) {
        suffix = "..."
    }
    snippet = prefix + snippet + suffix
    
    // è°ƒæ•´é«˜äº®ä½ç½®åç§»
    adjustedMatches := e.adjustMatchPositions(matches, start, len(prefix))
    
    return snippet, adjustedMatches
}

// adjustToWordBoundary è°ƒæ•´åˆ°è¯è¾¹ç•Œ
func (e *SnippetExtractor) adjustToWordBoundary(content string, pos int, isEnd bool) int {
    if pos <= 0 || pos >= len(content) {
        return pos
    }
    
    // ç®€å•è§„åˆ™ï¼šæ‰¾åˆ°æœ€è¿‘çš„ç©ºæ ¼æˆ–æ ‡ç‚¹
    separators := []rune{' ', '\n', 'ã€‚', 'ï¼Œ', 'ã€', 'ï¼›', 'ï¼š'}
    
    if isEnd {
        // å‘åæ‰¾
        for i := pos; i < len(content) && i < pos+10; i++ {
            for _, sep := range separators {
                if rune(content[i]) == sep {
                    return i
                }
            }
        }
    } else {
        // å‘å‰æ‰¾
        for i := pos; i > 0 && i > pos-10; i-- {
            for _, sep := range separators {
                if rune(content[i]) == sep {
                    return i + 1
                }
            }
        }
    }
    
    return pos
}

// adjustMatchPositions è°ƒæ•´åŒ¹é…ä½ç½®
func (e *SnippetExtractor) adjustMatchPositions(
    matches []Highlight,
    windowStart int,
    prefixLen int,
) []Highlight {
    var adjusted []Highlight
    
    for _, m := range matches {
        // åªä¿ç•™åœ¨çª—å£å†…çš„åŒ¹é…
        if m.Start >= windowStart {
            adjusted = append(adjusted, Highlight{
                Start:       m.Start - windowStart + prefixLen,
                End:         m.End - windowStart + prefixLen,
                MatchedText: m.MatchedText,
            })
        }
    }
    
    return adjusted
}
```

---

## 5. äº¤ä»˜ç‰©æ¸…å•

### 5.1 ä»£ç æ–‡ä»¶

- [ ] `server/service/memo/snippet.go` - æ‘˜å½•æå–å™¨

### 5.2 æµ‹è¯•æ–‡ä»¶

- [ ] `server/service/memo/snippet_test.go`

---

## 6. æµ‹è¯•éªŒæ”¶

### 6.1 åŠŸèƒ½æµ‹è¯•

| åœºæ™¯ | è¾“å…¥ | é¢„æœŸè¾“å‡º |
|:---|:---|:---|
| å¼€å¤´åŒ¹é… | åŒ¹é…åœ¨å‰10å­—ç¬¦ | ä»å¤´å¼€å§‹æ‘˜å½• |
| ä¸­é—´åŒ¹é… | åŒ¹é…åœ¨ä¸­é—´ | å±…ä¸­æ‘˜å½•ï¼Œå‰åæœ‰çœç•¥å· |
| ç»“å°¾åŒ¹é… | åŒ¹é…åœ¨æœ€å | åˆ°ç»“å°¾æ‘˜å½• |
| å¤šåŒ¹é… | å¤šä¸ªåŒ¹é…ç‚¹ | é€‰æ‹©ç¬¬ä¸€ä¸ª |

### 6.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|:---|:---|:---|
| æå–å»¶è¿Ÿ | < 10ms | å•å…ƒæµ‹è¯• |

---

## 7. ROI åˆ†æ

| ç»´åº¦ | å€¼ |
|:---|:---|
| å¼€å‘æŠ•å…¥ | 2 äººå¤© |
| é¢„æœŸæ”¶ç›Š | æœç´¢é¢„è§ˆä½“éªŒæå‡ |
| é£é™©è¯„ä¼° | ä½ |
| å›æŠ¥å‘¨æœŸ | Phase 1 ç»“æŸ |

---

## 8. å®æ–½è®¡åˆ’

### 8.1 æ—¶é—´è¡¨

| é˜¶æ®µ | æ—¶é—´ | ä»»åŠ¡ |
|:---|:---|:---|
| Day 1 | 1äººå¤© | æå–é€»è¾‘å®ç° |
| Day 2 | 1äººå¤© | æµ‹è¯• + è¾¹ç•Œå¤„ç† |

### 8.2 æ£€æŸ¥ç‚¹

- [ ] Day 1: æ ¸å¿ƒé€»è¾‘å®Œæˆ
- [ ] Day 2: è¾¹ç•Œcaseå¤„ç†

---

## é™„å½•

### A. å‚è€ƒèµ„æ–™

- [ç¬”è®°å¢å¼ºè·¯çº¿å›¾](../../research/memo-roadmap.md)

### B. å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|:---|:---|:---|:---|
| 2026-01-27 | v1.0 | åˆå§‹ç‰ˆæœ¬ | - |
