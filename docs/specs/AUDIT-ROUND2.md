# AI Specs äºŒè½®ä¸“å®¶å®¡è®¡æŠ¥å‘Š

> å®¡è®¡æ—¶é—´: 2026-01-19
> å®¡è®¡è§’è‰²: ç‹¬ç«‹ç¬¬ä¸‰æ–¹ Go å¼€å‘ä¸“å®¶, AI ä¸“å®¶, ä¸“ä¸šå®¡è®¡äººå‘˜

---

## ä¸€ã€Go å¼€å‘ä¸“å®¶å®¡è®¡

### 1.1 ä»£ç è´¨é‡é—®é¢˜

| Spec   | é—®é¢˜                                              | ä¸¥é‡æ€§ | ä¿®å¤å»ºè®®                                            |
| ------ | ------------------------------------------------- | ------ | --------------------------------------------------- |
| AI-006 | `vectorToString` ä½¿ç”¨ `%f` å¯¼è‡´ç²¾åº¦ä¸¢å¤±å’Œæ€§èƒ½é—®é¢˜ | ğŸ”´ é«˜   | ä½¿ç”¨ `strconv.FormatFloat` æˆ– pgvector çš„åŸç”Ÿåºåˆ—åŒ– |
| AI-006 | å¤§å‘é‡å­—ç¬¦ä¸²æ‹¼æ¥ä½¿ç”¨ `strings.Join` å†…å­˜åˆ†é…è¿‡å¤š  | ğŸŸ¡ ä¸­   | ä½¿ç”¨ `strings.Builder` é¢„åˆ†é…                       |
| AI-008 | `err` å˜é‡åœ¨ switch å†…éƒ¨è¦†ç›–å¤–éƒ¨åŒåå˜é‡          | ğŸ”´ é«˜   | é‡å‘½åå†…éƒ¨ err æˆ–é‡æ„é€»è¾‘                           |
| AI-008 | ç¼ºå°‘ `import "fmt"` å’Œ `import "errors"`          | ğŸŸ¢ ä½   | è¡¥å…… import                                         |
| AI-011 | `findMemosWithoutEmbedding` è¿”å› nil å®ç°         | ğŸ”´ é«˜   | å¿…é¡»æä¾›å®Œæ•´å®ç°æˆ–æ ‡è®°ä¸ºå¾…å®ç°                      |
| AI-013 | æµå¼å“åº” select å­˜åœ¨ goroutine æ³„æ¼é£é™©           | ğŸ”´ é«˜   | errChan å…³é—­åå¾ªç¯æœªæ­£ç¡®é€€å‡º                        |

### 1.2 AI-006 vectorToString ä¿®æ­£

**é—®é¢˜ä»£ç **:
```go
strs[i] = fmt.Sprintf("%f", f)  // ç²¾åº¦ä¸¢å¤± + æ…¢
```

**ä¿®æ­£æ–¹æ¡ˆ**:
```go
func vectorToString(v []float32) string {
    var sb strings.Builder
    sb.Grow(len(v) * 12) // é¢„åˆ†é…
    sb.WriteByte('[')
    for i, f := range v {
        if i > 0 {
            sb.WriteByte(',')
        }
        sb.WriteString(strconv.FormatFloat(float64(f), 'g', -1, 32))
    }
    sb.WriteByte(']')
    return sb.String()
}
```

### 1.3 AI-008 å˜é‡é®è”½ä¿®æ­£

**é—®é¢˜ä»£ç **:
```go
var err error  // å¤–éƒ¨
switch cfg.Provider {
case "siliconflow":
    llm, err := openai.New(...)  // å†…éƒ¨ err é®è”½å¤–éƒ¨
```

**ä¿®æ­£æ–¹æ¡ˆ**:
```go
switch cfg.Provider {
case "siliconflow":
    llm, createErr := openai.New(...)
    if createErr != nil {
        return nil, createErr
    }
```

### 1.4 AI-013 goroutine æ³„æ¼ä¿®æ­£

**é—®é¢˜**: `errChan` å…³é—­å select ç»§ç»­é˜»å¡

**ä¿®æ­£æ–¹æ¡ˆ**:
```go
for {
    select {
    case content, ok := <-contentChan:
        if !ok {
            contentChan = nil // æ ‡è®°ä¸ºå·²å…³é—­
            if errChan == nil {
                return stream.Send(&apiv1.ChatWithMemosResponse{Done: true})
            }
        }
        // ...
    case err, ok := <-errChan:
        if !ok {
            errChan = nil
            if contentChan == nil {
                return stream.Send(&apiv1.ChatWithMemosResponse{Done: true})
            }
            continue
        }
        if err != nil {
            return status.Errorf(codes.Internal, "LLM error: %v", err)
        }
    case <-ctx.Done():
        return ctx.Err()
    }
}
```

### 1.5 ç¼ºå¤±çš„é”™è¯¯å¤„ç†

| Spec   | ä½ç½®                | é—æ¼                          |
| ------ | ------------------- | ----------------------------- |
| AI-006 | SearchMemosByVector | æœªå¤„ç† memo.Payload JSON è§£æ |
| AI-011 | processBatch        | æ‰¹é‡å¤±è´¥ååº”è®°å½•å¤±è´¥çš„ MemoID |
| AI-012 | SemanticSearch      | ç©ºç»“æœæ—¶åº”è¿”å›æç¤ºä¿¡æ¯        |

---

## äºŒã€AI ä¸“å®¶å®¡è®¡

### 2.1 RAG æµç¨‹é—®é¢˜

| é—®é¢˜                 | å½±å“                        | å»ºè®®                      |
| -------------------- | --------------------------- | ------------------------- |
| **Prompt è¿‡é•¿é£é™©**  | 5 æ¡ç¬”è®°å¯èƒ½è¶…å‡º token é™åˆ¶ | å¢åŠ å†…å®¹æˆªæ–­é€»è¾‘          |
| **æ— æ£€ç´¢è´¨é‡æ£€æµ‹**   | ä½ç›¸å…³æ€§ç»“æœä¹Ÿä¼šé€å…¥ LLM    | å¢åŠ  score é˜ˆå€¼è¿‡æ»¤       |
| **æ—  fallback ç­–ç•¥** | æ— ç›¸å…³ç¬”è®°æ—¶ç›´æ¥ç©ºä¸Šä¸‹æ–‡    | æä¾›é»˜è®¤æç¤º "æ— ç›¸å…³ç¬”è®°" |

### 2.2 Embedding æœ€ä½³å®è·µé—æ¼

| é—æ¼é¡¹           | è¯´æ˜                            | å»ºè®®             |
| ---------------- | ------------------------------- | ---------------- |
| **ç©ºæ–‡æœ¬å¤„ç†**   | ç©ºå†…å®¹ Memo ä¼šå¯¼è‡´ API é”™è¯¯     | è·³è¿‡ç©ºç™½å†…å®¹     |
| **æ–‡æœ¬é¢„å¤„ç†**   | æœªå»é™¤ Markdown æ ¼å¼ç¬¦å·        | å¯é€‰ï¼šæå–çº¯æ–‡æœ¬ |
| **å‘é‡å½’ä¸€åŒ–**   | bge-m3 è¿”å›å½’ä¸€åŒ–å‘é‡ï¼Œä½†æœªéªŒè¯ | å¢åŠ æ–­è¨€éªŒè¯     |
| **æ‰¹é‡å¤§å°é™åˆ¶** | SiliconFlow å¯èƒ½æœ‰æ‰¹é‡é™åˆ¶      | åŠ¨æ€åˆ†æ‰¹         |

### 2.3 Reranker é…ç½®é—®é¢˜

**AI-009 é—®é¢˜**: ç¡¬ç¼–ç  `/rerank` ç«¯ç‚¹

```go
req, err := http.NewRequestWithContext(ctx, "POST", s.baseURL+"/rerank", ...)
```

**ä¿®æ­£**: SiliconFlow å®é™…ç«¯ç‚¹æ˜¯ `/v1/rerank`

```go
req, err := http.NewRequestWithContext(ctx, "POST", s.baseURL+"/v1/rerank", ...)
```

### 2.4 å»ºè®®å¢åŠ çš„ AI ç‰¹æ€§

| ç‰¹æ€§                | ä¼˜å…ˆçº§ | è¯´æ˜                 |
| ------------------- | ------ | -------------------- |
| **Score é˜ˆå€¼**      | é«˜     | è¿‡æ»¤ä½äº 0.5 çš„ç»“æœ  |
| **æœ€å¤§ Token ä¼°ç®—** | é«˜     | é˜²æ­¢è¶…å‡ºä¸Šä¸‹æ–‡çª—å£   |
| **ç¼“å­˜æŸ¥è¯¢å‘é‡**    | ä¸­     | ç›¸åŒæŸ¥è¯¢é¿å…é‡å¤è°ƒç”¨ |
| **å¼‚æ­¥ Rerank**     | ä½     | å¹¶è¡Œæ‰§è¡Œæé€Ÿ         |

---

## ä¸‰ã€ä¸“ä¸šå®¡è®¡äººå‘˜å®¡è®¡

### 3.1 å®‰å…¨å®¡è®¡

| é£é™©             | Spec           | ä¸¥é‡æ€§ | ä¿®å¤                       |
| ---------------- | -------------- | ------ | -------------------------- |
| **API Key æ³„éœ²** | AI-002, AI-007 | ğŸ”´ é«˜   | æ—¥å¿—ä¸­ç¦æ­¢æ‰“å° API Key     |
| **SQL æ³¨å…¥**     | AI-006         | ğŸŸ¢ ä½   | ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œå·²æ­£ç¡®å®ç° |
| **æƒé™ç»•è¿‡**     | AI-012, AI-015 | ğŸŸ¡ ä¸­   | å¢åŠ  Visibility æ£€æŸ¥       |
| **DoS é£é™©**     | AI-012         | ğŸŸ¡ ä¸­   | æ·»åŠ é€Ÿç‡é™åˆ¶               |

### 3.2 æƒé™æ£€æŸ¥å¢å¼º

**AI-012 SemanticSearch é—æ¼**:
```go
// å½“å‰åªæŒ‰ creator_id è¿‡æ»¤
// é—æ¼: å…¬å¼€ Memo ä¹Ÿåº”å¯è¢«æœç´¢ (å¯é€‰)
// é—æ¼: éœ€è¦æ£€æŸ¥ AI åŠŸèƒ½æ˜¯å¦å¯ç”¨
```

**å»ºè®®å¢åŠ **:
```go
// æ£€æŸ¥ AI åŠŸèƒ½æ˜¯å¦å¯ç”¨
if !s.IsEnabled() {
    return nil, status.Errorf(codes.Unavailable, "AI features are disabled")
}
```

### 3.3 å¯è§‚æµ‹æ€§ç¼ºå¤±

| ç¼ºå¤±é¡¹       | é‡è¦æ€§ | å»ºè®®                        |
| ------------ | ------ | --------------------------- |
| **è¯·æ±‚è¿½è¸ª** | é«˜     | æ·»åŠ  trace_id               |
| **æ€§èƒ½æŒ‡æ ‡** | é«˜     | Embedding å»¶è¿Ÿã€Rerank å»¶è¿Ÿ |
| **ä½¿ç”¨ç»Ÿè®¡** | ä¸­     | æ¯æ—¥ AI è°ƒç”¨æ¬¡æ•°            |
| **é”™è¯¯æŠ¥å‘Š** | é«˜     | ç»“æ„åŒ–é”™è¯¯æ—¥å¿—              |

### 3.4 æµ‹è¯•è¦†ç›–ç‡è¯„ä¼°

| Spec   | å•æµ‹ | é›†æˆæµ‹è¯• | E2E | è¯„ä¼°           |
| ------ | ---- | -------- | --- | -------------- |
| AI-001 | âŒ    | âŒ        | âŒ   | âš ï¸ ä»… lint      |
| AI-003 | âŒ    | âœ…        | âŒ   | âš ï¸ éœ€å›æ»šæµ‹è¯•   |
| AI-006 | âœ…    | âœ…        | âŒ   | âœ…              |
| AI-008 | âœ…    | âœ…        | âŒ   | âœ…              |
| AI-012 | âŒ    | âœ…        | âŒ   | âš ï¸ éœ€ Mock æµ‹è¯• |

---

## å››ã€ç»¼åˆæ•´æ”¹æ¸…å•

### å¿…é¡»ä¿®å¤ (é˜»å¡å‘å¸ƒ)

| #   | Spec   | é—®é¢˜                             | ä¼˜å…ˆçº§ |
| --- | ------ | -------------------------------- | ------ |
| 1   | AI-006 | vectorToString æ€§èƒ½å’Œç²¾åº¦        | P0     |
| 2   | AI-008 | å˜é‡é®è”½ bug                     | P0     |
| 3   | AI-009 | Rerank ç«¯ç‚¹è·¯å¾„é”™è¯¯              | P0     |
| 4   | AI-011 | findMemosWithoutEmbedding æœªå®ç° | P0     |
| 5   | AI-013 | goroutine æ³„æ¼é£é™©               | P0     |

### å¼ºçƒˆå»ºè®® (è´¨é‡æå‡)

| #   | Spec   | é—®é¢˜                         | ä¼˜å…ˆçº§ |
| --- | ------ | ---------------------------- | ------ |
| 6   | AI-012 | å¢åŠ  Score é˜ˆå€¼è¿‡æ»¤          | P1     |
| 7   | AI-013 | å¢åŠ ä¸Šä¸‹æ–‡ Token ä¼°ç®—        | P1     |
| 8   | å…¨å±€   | å¢åŠ  AI åŠŸèƒ½å¼€å…³æ£€æŸ¥         | P1     |
| 9   | å…¨å±€   | å¢åŠ  API è°ƒç”¨æ—¥å¿— (ä¸å« Key) | P1     |

### å»ºè®®ä¼˜åŒ– (å¯å»¶å)

| #   | Spec   | é—®é¢˜                 | ä¼˜å…ˆçº§ |
| --- | ------ | -------------------- | ------ |
| 10  | AI-011 | å¢åŠ è¿›åº¦æ—¥å¿—         | P2     |
| 11  | AI-008 | è¡¥å…… Ollama å®Œæ•´å®ç° | P2     |
| 12  | AI-016 | å¢åŠ æµå¼èŠå¤© Hook    | P2     |

---

## äº”ã€ä¿®æ­£åé¢„ä¼°æ—¶é—´è°ƒæ•´

| é˜¶æ®µ     | åŸé¢„ä¼° | è°ƒæ•´å  | åŸå›                   |
| -------- | ------ | ------- | --------------------- |
| AI-006   | 3h     | 4h      | æ€§èƒ½ä¼˜åŒ– + å®Œå–„æµ‹è¯•   |
| AI-008   | 2h     | 2.5h    | ä¿®å¤å˜é‡é®è”½          |
| AI-009   | 1.5h   | 2h      | ç«¯ç‚¹ä¿®æ­£ + æµ‹è¯•       |
| AI-011   | 2h     | 3h      | å®Œæ•´å®ç°æŸ¥è¯¢æ–¹æ³•      |
| AI-013   | 2h     | 3h      | ä¿®å¤æ³„æ¼ + Token ä¼°ç®— |
| **æ€»è®¡** | 25h    | **29h** | +16%                  |

---

## å…­ã€å®¡è®¡ç»“è®º

### æ€»ä½“è¯„ä¼°

| ç»´åº¦        | åˆå®¡è¯„åˆ† | äºŒå®¡è¯„åˆ† | æ”¹è¿›é¡¹       |
| ----------- | -------- | -------- | ------------ |
| æ¶æ„è®¾è®¡    | â­â­â­â­â­    | â­â­â­â­â­    | æ—            |
| ä»£ç è´¨é‡    | â­â­â­â­     | â­â­â­      | 5 é¡¹å¿…é¡»ä¿®å¤ |
| AI æœ€ä½³å®è·µ | â­â­â­â­     | â­â­â­      | 4 é¡¹å¼ºçƒˆå»ºè®® |
| å®‰å…¨æ€§      | â­â­â­â­     | â­â­â­â­     | 2 é¡¹æ£€æŸ¥å¢å¼º |
| å¯æµ‹è¯•æ€§    | â­â­â­â­     | â­â­â­â­     | æ—            |

### å»ºè®®

1. **ä¿®å¤ 5 é¡¹ P0 é—®é¢˜åæ–¹å¯è¿›å…¥å¼€å‘**
2. åœ¨ç¬¬ä¸€ä¸ª Spec å¼€å‘å®Œæˆåè¿›è¡Œ Code Review
3. å¢åŠ é›†æˆæµ‹è¯•ç¯å¢ƒå‡†å¤‡ Spec

**äºŒè½®å®¡è®¡å®Œæˆ** âœ…
