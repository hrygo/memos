# Technical Debt

本文档记录项目中的技术债务和待改进项。

## 优先级定义

- **P0 (严重)**: 影响功能正确性，需立即修复
- **P1 (高)**: 影响代码质量或性能，应尽快修复
- **P2 (中)**: 代码改进或优化问题
- **P3 (低)**: 锦误、文档、非关键问题

---

## 待修复项

### P0 - 功能 Bug

#### 1. 文件过早关闭导致写入失败
- **文件**: `plugin/textextract/tika.go:211-216`
- **问题**: `outputFile.Close()` 在 `Write` 之前调用
- **修复**: 移除显式 `Close()`，依赖 `defer` 自动关闭
- **状态**: 待修复
- **创建时间**: 2025-01-22

#### 2. RRULE BYDAY 循环逻辑错误
- **文件**: `server/scheduler/rrule/rrule.go:309-322`
- **问题**: `for` 循环中直接 `return`，只处理第一个 BYDAY
- **影响**: `BYDAY=MO,WE,FR` 只会计算到第一个日期
- **修复**: 重构 `nextWeeklyByDay` 逻辑，正确遍历所有 BYDAY
- **状态**: 待修复
- **创建时间**: 2025-01-22

#### 3. 统计字段永远不被更新
- **文件**: `server/stats/stats.go:33-36`
- **问题**: `ActiveDays`, `LastActivityTime`, `StreakDays` 声明但 `collect()` 从未更新
- **修复**: 在 `collect()` 函数中添加这些字段的计算逻辑
- **状态**: 待修复
- **创建时间**: 2025-01-22

### P1 - 并发与资源

#### 4. Goroutine 泄漏风险
- **文件**: `server/retrieval/adaptive_retrieval.go:422-450`
- **问题**: Context 取消时 goroutine 可能永久阻塞等待 channel
- **修复**: 使用 select 语句检查 ctx.Done()
- **状态**: 待修复
- **创建时间**: 2025-01-22

#### 5. 无限制 Goroutine 创建
- **文件**: `server/runner/ocr/runner.go:261-277`
- **问题**: `ProcessAttachmentAsync` 每次调用创建新 goroutine，无限流
- **修复**: 添加 worker pool 或信号量限流
- **状态**: 待修复
- **创建时间**: 2025-01-22

### P1 - 输入验证与安全

#### 6. 输入验证缺失
- **文件**: `store/memo_embedding.go:46-53`
- **问题**: `BM25SearchOptions.Query` 无长度限制，`Limit` 无最大值
- **修复**: 添加 `MaxQueryLength = 1000`, `MaxSearchLimit = 100`
- **状态**: 待修复
- **创建时间**: 2025-01-22

#### 7. SQL 格式化字符串风险
- **文件**: `store/db/postgres/attachment.go:62`
- **问题**: `fmt.Sprintf("%%%s%%", *v)` 可能导致格式化攻击
- **修复**: 使用字符串拼接替代格式化
- **状态**: 待修复
- **创建时间**: 2025-01-22

#### 8. ts_query 注入风险
- **文件**: `store/db/postgres/memo_embedding.go:273-277`
- **问题**: 用户输入直接传入 `plainto_tsquery`，支持特殊操作符
- **修复**: 添加输入清理，转义特殊字符
- **状态**: 待修复
- **创建时间**: 2025-01-22

### P2 - 架构与设计

#### 9. 目录结构问题 (ROI: 🟡 中低 - 延期处理)
- **文件**: `server/scheduler/rrule/`, `server/scheduler/suggestion/`, `server/stats/`
- **问题**: 应放在 `plugin/` 或 `internal/` 而非 `server/`
- **分析**:
  - 当前外部依赖: 0 (这些模块尚未被集成使用)
  - 代码行数: ~1500 行
  - 重构成本: ~35 分钟
  - ROI 评估: 中低 (模块未使用，立即移动收益有限)
- **修复**: 在实际集成这些模块时一并重构目录结构
- **状态**: 待集成后修复
- **创建时间**: 2025-01-22
- **评估时间**: 2025-01-22

#### 10. 缺少测试
- **文件**: `plugin/ocr/`, `plugin/textextract/`
- **问题**: 没有测试文件
- **修复**: 添加单元测试
- **状态**: 待修复
- **创建时间**: 2025-01-22

### P2 - 注释与文档

#### 11. 统计字段未实现
- **文件**: `server/stats/stats.go`
- **问题**: `GetSummary` 使用 `ActiveDays` 等字段，但从未计算
- **修复**: 实现这些字段的计算，或从摘要中移除
- **状态**: 待修复
- **创建时间**: 2025-01-22

#### 12. GetCacheStats 返回未初始化数据
- **文件**: `store/cache/tiered.go:410-424`
- **问题**: 只填充 `L1Size`，其他字段为零值
- **修复**: 完整实现或移除未使用的字段
- **状态**: 待修复
- **创建时间**: 2025-01-22

### P3 - 代码风格

#### 13. 硬编码中文字符串
- **文件**: `server/stats/stats.go:204-244`
- **问题**: `GetSummary()` 返回中文硬编码
- **建议**: 返回结构化数据，让前端处理国际化
- **状态**: 待重构
- **创建时间**: 2025-01-22

---

## 已解决

*(本节记录已解决的技术债务)*

---

## 变更记录

| 日期 | 项目 | 状态 |
|------|------|------|
| 2025-01-22 | 初始技术债务记录 | 创建 |
